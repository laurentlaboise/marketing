<%- include('../../partials/head', { title, bodyClass: 'dashboard-layout' }) %>
<%- include('../../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Social Channels</h1>
        <p class="page-subtitle">Connect and manage social media accounts</p>
      </div>
      <div class="page-actions">
        <a href="/social/ai-settings" class="btn btn-secondary"><i class="fas fa-robot"></i> AI Providers</a>
        <a href="/social/channels/new" class="btn btn-secondary"><i class="fas fa-plus"></i> Manual Add</a>
      </div>
    </div>

    <!-- OAuth Connect Cards -->
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-header"><h3><i class="fas fa-plug"></i> Connect with OAuth</h3></div>
      <div class="card-body">
        <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">Connect your accounts to enable direct publishing from the admin panel.</p>
        <div class="oauth-grid">
          <a href="/social/oauth/facebook" class="oauth-connect-btn" style="--btn-color: #1877f2;">
            <i class="fab fa-facebook"></i> Facebook / Instagram
          </a>
          <a href="/social/oauth/twitter" class="oauth-connect-btn" style="--btn-color: #000;">
            <i class="fab fa-x-twitter"></i> Twitter / X
          </a>
          <a href="/social/oauth/linkedin" class="oauth-connect-btn" style="--btn-color: #0a66c2;">
            <i class="fab fa-linkedin"></i> LinkedIn
          </a>
          <a href="/social/oauth/tiktok" class="oauth-connect-btn" style="--btn-color: #000;">
            <i class="fab fa-tiktok"></i> TikTok
          </a>
          <a href="/social/oauth/pinterest" class="oauth-connect-btn" style="--btn-color: #e60023;">
            <i class="fab fa-pinterest"></i> Pinterest
          </a>
        </div>
      </div>
    </div>

    <!-- Connected Channels -->
    <div class="card">
      <div class="card-header"><h3><i class="fas fa-link"></i> Connected Channels</h3></div>
      <div class="card-body" style="padding: 0;">
        <% if (channels.length > 0) { %>
        <div class="table-container">
          <table class="table table-responsive-cards">
            <thead>
              <tr>
                <th>Platform</th>
                <th>Account</th>
                <th>Token Health</th>
                <th>Status</th>
                <th>Connected</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% channels.forEach(channel => { %>
              <%
                const platformIcons = { 'Facebook': 'fab fa-facebook', 'Twitter/X': 'fab fa-x-twitter', 'Instagram': 'fab fa-instagram', 'LinkedIn': 'fab fa-linkedin', 'TikTok': 'fab fa-tiktok', 'Pinterest': 'fab fa-pinterest', 'Google Business': 'fab fa-google', 'Threads': 'fas fa-at', 'YouTube': 'fab fa-youtube', 'Snapchat': 'fab fa-snapchat' };
                const platformColors = { 'Facebook': '#1877f2', 'Twitter/X': '#000', 'Instagram': '#e4405f', 'LinkedIn': '#0a66c2', 'TikTok': '#000', 'Pinterest': '#e60023', 'Google Business': '#4285f4', 'Threads': '#000', 'YouTube': '#ff0000', 'Snapchat': '#fffc00' };
                const tokenOk = channel.access_token && (!channel.token_expires || new Date(channel.token_expires) > new Date());
                const tokenExpiring = channel.token_expires && new Date(channel.token_expires) < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) && new Date(channel.token_expires) > new Date();
              %>
              <tr>
                <td data-label="Platform">
                  <i class="<%= platformIcons[channel.platform] || 'fas fa-globe' %>" style="color: <%= platformColors[channel.platform] || 'var(--gray-500)' %>; font-size: 18px; margin-right: 6px;"></i>
                  <strong><%= channel.platform %></strong>
                </td>
                <td data-label="Account">
                  <% if (channel.account_name) { %>
                  <span style="font-size: 14px;"><%= channel.account_name %></span>
                  <% if (channel.account_id) { %>
                  <div style="font-size: 11px; color: var(--gray-400); font-family: monospace;"><%= channel.account_id %></div>
                  <% } %>
                  <% } else { %>
                  <span style="color: var(--gray-400);">-</span>
                  <% } %>
                </td>
                <td data-label="Token Health">
                  <% if (!channel.access_token) { %>
                  <span class="token-badge token-none"><i class="fas fa-times-circle"></i> No token</span>
                  <% } else if (!tokenOk) { %>
                  <span class="token-badge token-expired"><i class="fas fa-exclamation-triangle"></i> Expired</span>
                  <% } else if (tokenExpiring) { %>
                  <span class="token-badge token-warning"><i class="fas fa-clock"></i> Expiring soon</span>
                  <% } else { %>
                  <span class="token-badge token-ok"><i class="fas fa-check-circle"></i> Valid</span>
                  <% } %>
                  <% if (channel.token_expires) { %>
                  <div style="font-size: 11px; color: var(--gray-400); margin-top: 2px;">
                    Expires: <%= new Date(channel.token_expires).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                  </div>
                  <% } %>
                </td>
                <td data-label="Status"><span class="status-badge <%= channel.status %>"><%= channel.status %></span></td>
                <td data-label="Connected" style="font-size: 13px; color: var(--gray-500);">
                  <%= channel.created_at ? new Date(channel.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-' %>
                </td>
                <td data-label="Actions">
                  <div class="table-actions">
                    <% const oauthMap = { 'Facebook': 'facebook', 'Twitter/X': 'twitter', 'LinkedIn': 'linkedin', 'TikTok': 'tiktok', 'Pinterest': 'pinterest' }; %>
                    <% if (oauthMap[channel.platform] && (!tokenOk)) { %>
                    <a href="/social/oauth/<%= oauthMap[channel.platform] %>" class="btn btn-sm btn-primary" title="Reconnect"><i class="fas fa-sync"></i></a>
                    <% } %>
                    <a href="/social/channels/<%= channel.id %>/edit" class="btn btn-sm btn-secondary" title="Edit"><i class="fas fa-edit"></i></a>
                    <form action="/social/channels/<%= channel.id %>/delete" method="POST" style="display: inline;">
                      <button type="submit" class="btn btn-sm btn-danger" data-confirm-delete title="Disconnect"><i class="fas fa-unlink"></i></button>
                    </form>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
        <% } else { %>
        <div class="empty-state">
          <div class="empty-state-icon"><i class="fas fa-plug"></i></div>
          <h3>No Channels Connected</h3>
          <p>Click one of the OAuth buttons above to connect your first account, or add one manually.</p>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<style>
.oauth-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.oauth-connect-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: 8px;
  background: var(--btn-color, var(--primary));
  color: white;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all 0.2s;
}
.oauth-connect-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  color: white;
}
.oauth-connect-btn i {
  font-size: 18px;
}
.token-badge {
  font-size: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.token-ok { color: var(--success); }
.token-warning { color: var(--warning); }
.token-expired { color: var(--danger); }
.token-none { color: var(--gray-400); }
</style>

<%- include('../../partials/footer') %>
