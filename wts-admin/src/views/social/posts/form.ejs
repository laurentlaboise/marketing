<%- include('../../partials/head', { title, bodyClass: 'dashboard-layout' }) %>
<%- include('../../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title"><%= post ? 'Edit Post' : (sourceData ? 'Promote Content' : 'New Post') %></h1>
        <p class="page-subtitle"><a href="/social/posts"><i class="fas fa-arrow-left"></i> Back to Posts</a>
          <% if (!sourceData && !post) { %> | <a href="/social/content-hub"><i class="fas fa-wand-magic-sparkles"></i> Content Hub</a><% } %>
        </p>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 340px; gap: 24px; max-width: 1200px;">
      <!-- Main Form -->
      <div>
        <form id="postForm" action="<%= post ? '/social/posts/' + post.id : '/social/posts' %>" method="POST">

          <!-- Hidden source fields -->
          <input type="hidden" name="source_type" id="source_type" value="<%= sourceData ? sourceData.type : (post && post.source_type ? post.source_type : '') %>">
          <input type="hidden" name="source_id" id="source_id" value="<%= sourceData ? sourceData.id : (post && post.source_id ? post.source_id : '') %>">
          <input type="hidden" name="source_title" id="source_title" value="<%= sourceData ? sourceData.title : (post && post.source_title ? post.source_title : '') %>">
          <input type="hidden" name="source_url" id="source_url" value="<%= sourceData ? sourceData.url : (post && post.source_url ? post.source_url : '') %>">
          <input type="hidden" name="ai_generated" id="ai_generated" value="<%= post && post.ai_generated ? 'true' : 'false' %>">
          <input type="hidden" name="ai_provider" id="ai_provider_hidden" value="<%= post && post.ai_provider ? post.ai_provider : '' %>">
          <input type="hidden" name="ai_prompt_used" id="ai_prompt_used" value="">

          <% if (sourceData) { %>
          <!-- Source Context Card -->
          <div class="card" style="margin-bottom: 20px; border-left: 4px solid var(--primary);">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-link"></i> Promoting Content</h2>
              <button type="button" class="btn btn-sm btn-secondary" onclick="clearSource()"><i class="fas fa-times"></i> Remove</button>
            </div>
            <div class="card-body">
              <div style="display: flex; gap: 12px; align-items: flex-start;">
                <span class="source-badge source-badge-<%= sourceData.type %>"><%= sourceData.type %></span>
                <div style="flex: 1;">
                  <h3 style="margin: 0 0 4px 0; font-size: 15px;"><%= sourceData.title %></h3>
                  <% if (sourceData.excerpt) { %>
                  <p style="margin: 0 0 6px 0; font-size: 13px; color: var(--gray-500); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"><%= sourceData.excerpt.substring(0, 200) %></p>
                  <% } %>
                  <% if (sourceData.url) { %>
                  <a href="<%= sourceData.url %>" target="_blank" style="font-size: 12px; color: var(--primary);"><i class="fas fa-external-link-alt"></i> <%= sourceData.url.substring(0, 60) %></a>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          <% } %>

          <!-- AI Generation Card -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="cursor: pointer;" onclick="document.getElementById('aiGenBody').style.display = document.getElementById('aiGenBody').style.display === 'none' ? '' : 'none'; this.querySelector('.fa-chevron-down').classList.toggle('rotated');">
              <h2 class="card-title"><i class="fas fa-robot"></i> AI Generate</h2>
              <i class="fas fa-chevron-down" style="color: var(--gray-400); transition: transform 0.2s;<%= sourceData ? ' transform: rotate(180deg);' : '' %>"></i>
            </div>
            <div class="card-body" id="aiGenBody" style="<%= sourceData ? '' : 'display: none;' %>">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">AI Engine</label>
                  <select id="ai_engine" class="form-input">
                    <option value="auto">Auto (best for task)</option>
                    <% if (typeof aiProviders !== 'undefined') { aiProviders.forEach(function(p) { %>
                    <option value="<%= p.id %>"><%= p.name %> ($<%= p.cost_per_1m_input %>/<%= p.cost_per_1m_output %>)</option>
                    <% }); } %>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Language</label>
                  <select id="ai_language" name="language" class="form-input">
                    <% if (typeof languages !== 'undefined') { languages.forEach(function(l) { %>
                    <option value="<%= l.code %>" <%= (post && post.language === l.code) ? 'selected' : (l.code === 'en' ? 'selected' : '') %>><%= l.name %> (<%= l.native %>)</option>
                    <% }); } %>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Tone</label>
                  <select id="ai_tone" class="form-input">
                    <option value="professional">Professional</option>
                    <option value="casual">Casual</option>
                    <option value="educational">Educational</option>
                    <option value="urgent">Urgent / FOMO</option>
                    <option value="storytelling">Storytelling</option>
                    <option value="humorous">Humorous</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Style</label>
                  <select id="ai_style" class="form-input">
                    <option value="key_takeaway">Key Takeaway</option>
                    <option value="question_hook">Question Hook</option>
                    <option value="statistic_lead">Stat / Data Lead</option>
                    <option value="how_to">How-To Tip</option>
                    <option value="listicle">Listicle</option>
                    <option value="quote">Quote / Insight</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">CTA</label>
                <input type="text" id="ai_cta" class="form-input" value="Read more" placeholder="Call-to-action text">
              </div>
              <div class="form-group">
                <label class="form-label">Custom Prompt (optional)</label>
                <textarea id="ai_custom_prompt" class="form-input" rows="2" placeholder="Override with your own instructions..."></textarea>
              </div>
              <button type="button" id="generateBtn" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-wand-magic-sparkles"></i> Generate 3 Variations
              </button>

              <!-- AI Results -->
              <div id="aiResults" style="display: none; margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <label class="form-label" style="margin: 0;">Pick a variation</label>
                  <span id="aiProviderBadge" style="font-size: 11px; background: var(--gray-100); padding: 2px 8px; border-radius: 10px; color: var(--gray-500);"></span>
                </div>
                <div id="aiVariations"></div>
              </div>
            </div>
          </div>

          <!-- Content -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-pen"></i> Content</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label" for="content">
                  Post Content *
                  <span id="charCounter" style="float: right; font-weight: 400; font-size: 12px; color: var(--gray-500);">0</span>
                </label>
                <textarea id="content" name="content" class="form-input" rows="6" required
                  placeholder="Write your social media post content..."><%= post ? post.content : '' %></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="content_type">Content Type</label>
                  <select id="content_type" name="content_type" class="form-input">
                    <% contentTypes.forEach(ct => { %>
                    <option value="<%= ct.id %>" <%= post && post.content_type === ct.id ? 'selected' : '' %>>
                      <%= ct.label %>
                    </option>
                    <% }); %>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="link_url">Link URL</label>
                  <input type="url" id="link_url" name="link_url" class="form-input"
                    value="<%= sourceData ? sourceData.url || '' : (post ? post.link_url || '' : '') %>" placeholder="https://wordsthatsells.website/...">
                </div>
              </div>
            </div>
          </div>

          <!-- Platforms -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-share-alt"></i> Platforms</h2>
            </div>
            <div class="card-body">
              <div class="platform-selector">
                <% platforms.forEach(p => { %>
                <label class="platform-check" style="--platform-color: <%= p.color %>;">
                  <input type="checkbox" name="platforms" value="<%= p.id %>"
                    <%= post && post.platforms && post.platforms.includes(p.id) ? 'checked' : '' %>
                    data-char-limit="<%= p.charLimit %>" data-hashtag-limit="<%= p.hashtagLimit %>">
                  <span class="platform-check-label">
                    <i class="<%= p.icon %>" style="font-size: 18px;"></i>
                    <span><%= p.id %></span>
                    <span class="platform-char-limit"><%= p.charLimit %> chars</span>
                  </span>
                </label>
                <% }); %>
              </div>
            </div>
          </div>

          <!-- Hashtags -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-hashtag"></i> Hashtags</h2>
            </div>
            <div class="card-body">
              <% if (hashtagSets.length > 0) { %>
              <div class="form-group">
                <label class="form-label">Quick Insert from Sets</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <% hashtagSets.forEach(set => { %>
                  <button type="button" class="btn btn-sm btn-secondary insert-hashtag-set"
                    data-hashtags="<%= set.hashtags ? set.hashtags.join(', ') : '' %>">
                    <i class="fas fa-plus"></i> <%= set.name %> (<%= set.hashtags ? set.hashtags.length : 0 %>)
                  </button>
                  <% }); %>
                </div>
              </div>
              <% } %>

              <div class="form-group">
                <label class="form-label" for="hashtags">
                  Hashtags
                  <span id="hashtagCount" style="float: right; font-weight: 400; font-size: 12px; color: var(--gray-500);">0 tags</span>
                </label>
                <input type="text" id="hashtags" name="hashtags" class="form-input"
                  value="<%= post && post.hashtags ? post.hashtags.map(h => h.replace(/^#/, '')).join(', ') : '' %>"
                  placeholder="marketing, seo, digital (# added automatically)">
                <p class="form-help">Comma-separated. The # symbol is added automatically.</p>
              </div>
            </div>
          </div>

          <!-- Campaign & Scheduling -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-calendar-check"></i> Campaign & Scheduling</h2>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="campaign_id">Campaign</label>
                  <select id="campaign_id" name="campaign_id" class="form-input">
                    <option value="">No campaign</option>
                    <% campaigns.forEach(c => { %>
                    <option value="<%= c.id %>"
                      data-utm-source="<%= c.utm_source || '' %>"
                      data-utm-medium="<%= c.utm_medium || '' %>"
                      data-utm-campaign="<%= c.utm_campaign || '' %>"
                      data-utm-term="<%= c.utm_term || '' %>"
                      data-utm-content="<%= c.utm_content || '' %>"
                      <%= (post && post.campaign_id == c.id) || (preselectedCampaign == c.id) ? 'selected' : '' %>>
                      <span style="color: <%= c.color %>;">&#9679;</span> <%= c.name %>
                    </option>
                    <% }); %>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="status">Status</label>
                  <select id="status" name="status" class="form-input">
                    <option value="draft" <%= !post || post.status === 'draft' ? 'selected' : '' %>>Draft</option>
                    <option value="scheduled" <%= post && post.status === 'scheduled' ? 'selected' : '' %>>Scheduled</option>
                    <option value="published" <%= post && post.status === 'published' ? 'selected' : '' %>>Published</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="scheduled_at">Schedule For</label>
                  <input type="datetime-local" id="scheduled_at" name="scheduled_at" class="form-input"
                    value="<%= post && post.scheduled_at ? new Date(post.scheduled_at).toISOString().slice(0, 16) : '' %>">
                </div>
                <div class="form-group">
                  <label class="form-label" for="approval_status">Approval</label>
                  <select id="approval_status" name="approval_status" class="form-input">
                    <option value="pending" <%= !post || post.approval_status === 'pending' ? 'selected' : '' %>>Pending Review</option>
                    <option value="approved" <%= post && post.approval_status === 'approved' ? 'selected' : '' %>>Approved</option>
                    <option value="rejected" <%= post && post.approval_status === 'rejected' ? 'selected' : '' %>>Rejected</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Media & Image Picker -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-photo-video"></i> Media</h2>
              <button type="button" class="btn btn-sm btn-primary" id="openImagePickerBtn"><i class="fas fa-images"></i> Pick from Library</button>
            </div>
            <div class="card-body">
              <div id="mediaPreviewGrid" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
              <div class="form-group">
                <label class="form-label" for="media_urls">Media URLs (one per line)</label>
                <textarea id="media_urls" name="media_urls" class="form-input" rows="3"
                  placeholder="https://cdn.jsdelivr.net/gh/laurentlaboise/marketing@main/images/..."><%= post && post.media_urls ? post.media_urls.join('\n') : '' %></textarea>
              </div>
            </div>
          </div>

          <!-- UTM Parameters -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-chart-line"></i> UTM Tracking</h2>
              <button type="button" id="inheritUtmBtn" class="btn btn-sm btn-secondary" style="display: none;">
                <i class="fas fa-download"></i> Inherit from Campaign
              </button>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="utm_source">Source</label>
                  <input type="text" id="utm_source" name="utm_source" class="form-input"
                    value="<%= post && post.utm_params ? post.utm_params.source || '' : '' %>" placeholder="facebook">
                </div>
                <div class="form-group">
                  <label class="form-label" for="utm_medium">Medium</label>
                  <input type="text" id="utm_medium" name="utm_medium" class="form-input"
                    value="<%= post && post.utm_params ? post.utm_params.medium || '' : '' %>" placeholder="social">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="utm_campaign">Campaign</label>
                  <input type="text" id="utm_campaign" name="utm_campaign" class="form-input"
                    value="<%= post && post.utm_params ? post.utm_params.campaign || '' : '' %>" placeholder="q1-awareness">
                </div>
                <div class="form-group">
                  <label class="form-label" for="utm_term">Term</label>
                  <input type="text" id="utm_term" name="utm_term" class="form-input"
                    value="<%= post && post.utm_params ? post.utm_params.term || '' : '' %>">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="utm_content">Content</label>
                <input type="text" id="utm_content" name="utm_content" class="form-input"
                  value="<%= post && post.utm_params ? post.utm_params.content || '' : '' %>">
              </div>
            </div>
          </div>

          <!-- Targeting (collapsed by default) -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? '' : 'none'; this.querySelector('.fa-chevron-down').classList.toggle('rotated');">
              <h2 class="card-title"><i class="fas fa-crosshairs"></i> Audience Targeting</h2>
              <i class="fas fa-chevron-down" style="color: var(--gray-400); transition: transform 0.2s;"></i>
            </div>
            <div class="card-body" style="display: none;">
              <% const t = post && post.targeting ? post.targeting : {}; %>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="targeting_age_min">Min Age</label>
                  <input type="number" id="targeting_age_min" name="targeting_age_min" class="form-input" min="13" max="65"
                    value="<%= t.age_min || '' %>">
                </div>
                <div class="form-group">
                  <label class="form-label" for="targeting_age_max">Max Age</label>
                  <input type="number" id="targeting_age_max" name="targeting_age_max" class="form-input" min="13" max="65"
                    value="<%= t.age_max || '' %>">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="targeting_gender">Gender</label>
                  <select id="targeting_gender" name="targeting_gender" class="form-input">
                    <option value="all" <%= !t.gender || t.gender === 'all' ? 'selected' : '' %>>All</option>
                    <option value="male" <%= t.gender === 'male' ? 'selected' : '' %>>Male</option>
                    <option value="female" <%= t.gender === 'female' ? 'selected' : '' %>>Female</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="targeting_locations">Locations</label>
                  <input type="text" id="targeting_locations" name="targeting_locations" class="form-input"
                    value="<%= t.locations ? t.locations.join(', ') : '' %>" placeholder="Laos, Thailand">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="targeting_interests">Interests</label>
                <input type="text" id="targeting_interests" name="targeting_interests" class="form-input"
                  value="<%= t.interests ? t.interests.join(', ') : '' %>" placeholder="marketing, seo">
              </div>
            </div>
          </div>

          <!-- Notes & Labels -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h2 class="card-title"><i class="fas fa-sticky-note"></i> Notes & Labels</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label" for="labels">Labels</label>
                <input type="text" id="labels" name="labels" class="form-input"
                  value="<%= post && post.labels ? post.labels.join(', ') : '' %>" placeholder="urgent, needs-review, approved">
                <p class="form-help">Comma-separated labels</p>
              </div>
              <div class="form-group">
                <label class="form-label" for="notes">Internal Notes</label>
                <textarea id="notes" name="notes" class="form-input" rows="3"
                  placeholder="Notes visible only to team members"><%= post ? post.notes || '' : '' %></textarea>
              </div>
            </div>
          </div>

          <div class="form-actions" style="display: flex; gap: 8px; align-items: center;">
            <a href="/social/posts" class="btn btn-secondary">Cancel</a>
            <button type="button" class="btn btn-secondary" onclick="showPlatformPreview()"><i class="fas fa-eye"></i> Preview</button>
            <button type="button" class="btn btn-secondary" id="shortenBtn" onclick="shortenLink()"><i class="fas fa-link"></i> Shorten</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> <%= post ? 'Update Post' : 'Create Post' %></button>
          </div>
        </form>
      </div>

      <!-- Right Sidebar: Preview -->
      <div>
        <div class="card" style="position: sticky; top: 80px;">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-eye"></i> Preview</h2>
          </div>
          <div class="card-body">
            <div id="previewPlatformIcons" style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;"></div>
            <div id="previewContent" style="font-size: 14px; color: var(--gray-700); line-height: 1.6; white-space: pre-wrap; word-break: break-word; min-height: 60px; padding: 12px; background: var(--gray-50); border-radius: var(--radius);">
              Your post preview will appear here...
            </div>
            <div id="previewHashtags" style="margin-top: 10px;"></div>
            <div id="previewLink" style="margin-top: 10px;"></div>

            <!-- Character limit warnings -->
            <div id="charWarnings" style="margin-top: 16px;"></div>

            <!-- Post Summary -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
              <div style="display: grid; gap: 8px; font-size: 13px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">Content type</span>
                  <span id="previewContentType" style="font-weight: 500;">Text Post</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">Campaign</span>
                  <span id="previewCampaign" style="font-weight: 500;">None</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">Platforms</span>
                  <span id="previewPlatformCount" style="font-weight: 500;">0 selected</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">Hashtags</span>
                  <span id="previewHashtagCount" style="font-weight: 500;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">Source</span>
                  <span id="previewSource" style="font-weight: 500;"><%= sourceData ? sourceData.type : (post && post.source_type ? post.source_type : 'None') %></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--gray-500);">Language</span>
                  <span id="previewLang" style="font-weight: 500;">EN</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Image Picker Modal -->
<div id="imagePickerModal" class="modal-overlay" style="display: none;">
  <div class="modal" style="max-width: 800px; max-height: 80vh;">
    <div class="modal-header">
      <h3><i class="fas fa-images"></i> Pick Images</h3>
      <button type="button" class="modal-close" onclick="closeImagePicker()">&times;</button>
    </div>
    <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
      <div style="margin-bottom: 16px;">
        <input type="text" id="imagePickerSearch" class="form-input" placeholder="Search images by title or filename...">
      </div>
      <div id="imagePickerGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(140px, 100%), 1fr)); gap: 10px;"></div>
      <div id="imagePickerLoading" style="text-align: center; padding: 40px; color: var(--gray-400);">
        <i class="fas fa-spinner fa-spin"></i> Loading images...
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeImagePicker()">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="insertSelectedImages()"><i class="fas fa-check"></i> Insert Selected</button>
    </div>
  </div>
</div>

<style>
.source-badge {
  font-size: 11px; font-weight: 600; padding: 2px 10px; border-radius: 12px;
  text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
}
.source-badge-article { background: #dbeafe; color: #1e40af; }
.source-badge-glossary { background: #d1fae5; color: #065f46; }
.source-badge-ai_tool { background: #ede9fe; color: #5b21b6; }
.source-badge-guide { background: #ffedd5; color: #9a3412; }
.source-badge-service { background: #fce7f3; color: #9d174d; }

.ai-variation {
  border: 2px solid var(--gray-200);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.15s ease;
}
.ai-variation:hover {
  border-color: var(--primary);
  background: rgba(32,133,200,0.03);
}
.ai-variation.selected {
  border-color: var(--primary);
  background: rgba(32,133,200,0.06);
}
.ai-variation-text {
  font-size: 14px;
  color: var(--gray-700);
  line-height: 1.6;
  white-space: pre-wrap;
  margin-bottom: 8px;
}
.ai-variation-hashtags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.ai-variation-hashtags .hashtag-chip {
  font-size: 11px;
}
.ai-variation-number {
  font-size: 11px; font-weight: 700; background: var(--gray-100);
  color: var(--gray-500); width: 22px; height: 22px; border-radius: 50%;
  display: inline-flex; align-items: center; justify-content: center;
  margin-right: 6px;
}
.media-thumb {
  width: 80px; height: 80px; object-fit: cover; border-radius: 6px;
  border: 1px solid var(--gray-200); position: relative;
}
.media-thumb-wrap {
  position: relative; display: inline-block;
}
.media-thumb-remove {
  position: absolute; top: -6px; right: -6px; width: 20px; height: 20px;
  border-radius: 50%; background: var(--danger); color: white; border: none;
  font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.img-pick-item {
  border: 3px solid transparent; border-radius: 8px; overflow: hidden;
  cursor: pointer; transition: all 0.15s;
}
.img-pick-item:hover { border-color: var(--primary); }
.img-pick-item.selected { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(32,133,200,0.3); }
.img-pick-item img { width: 100%; height: 100px; object-fit: cover; display: block; }
.img-pick-item .img-pick-name { font-size: 11px; padding: 4px 6px; color: var(--gray-600); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;
}
.modal {
  background: white; border-radius: 12px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px 20px; border-bottom: 1px solid var(--gray-200);
}
.modal-header h3 { margin: 0; font-size: 16px; }
.modal-close {
  background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400);
  width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
}
.modal-body { padding: 20px; }
.modal-footer {
  display: flex; justify-content: flex-end; gap: 10px;
  padding: 16px 20px; border-top: 1px solid var(--gray-200);
}

@media (max-width: 768px) {
  .modal { max-width: 95%; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var contentEl = document.getElementById('content');
  var charCounter = document.getElementById('charCounter');
  var hashtagsEl = document.getElementById('hashtags');
  var hashtagCount = document.getElementById('hashtagCount');
  var campaignSelect = document.getElementById('campaign_id');
  var inheritBtn = document.getElementById('inheritUtmBtn');

  // Platform metadata
  var platformMeta = {};
  <% platforms.forEach(p => { %>
  platformMeta['<%= p.id %>'] = { icon: '<%= p.icon %>', color: '<%= p.color %>', charLimit: <%= p.charLimit %>, hashtagLimit: <%= p.hashtagLimit %> };
  <% }); %>

  var contentTypeMeta = {};
  <% contentTypes.forEach(ct => { %>
  contentTypeMeta['<%= ct.id %>'] = '<%= ct.label %>';
  <% }); %>

  function getSelectedPlatforms() {
    return Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(function(c) { return c.value; });
  }

  function updatePreview() {
    var text = contentEl.value;
    var len = text.length;
    charCounter.textContent = len + ' chars';

    document.getElementById('previewContent').textContent = text || 'Your post preview will appear here...';

    var tags = hashtagsEl.value.split(',').map(function(t) { return t.trim().replace(/^#/, ''); }).filter(Boolean);
    hashtagCount.textContent = tags.length + ' tag' + (tags.length !== 1 ? 's' : '');
    var previewHashtagsEl = document.getElementById('previewHashtags');
    previewHashtagsEl.textContent = '';
    tags.forEach(function(t, i) {
      var chip = document.createElement('span');
      chip.className = 'hashtag-chip';
      chip.textContent = '#' + t;
      previewHashtagsEl.appendChild(chip);
      if (i < tags.length - 1) previewHashtagsEl.appendChild(document.createTextNode(' '));
    });
    document.getElementById('previewHashtagCount').textContent = tags.length;

    var link = document.getElementById('link_url').value;
    var previewLinkEl = document.getElementById('previewLink');
    previewLinkEl.innerHTML = '';
    if (link) {
      var a = document.createElement('a');
      a.href = '#';
      a.style.cssText = 'font-size: 13px; color: var(--primary);';
      var icon = document.createElement('i');
      icon.className = 'fas fa-link';
      a.appendChild(icon);
      a.appendChild(document.createTextNode(' ' + link.substring(0, 40) + (link.length > 40 ? '...' : '')));
      previewLinkEl.appendChild(a);
    }

    var selected = getSelectedPlatforms();
    var previewPlatformIconsEl = document.getElementById('previewPlatformIcons');
    previewPlatformIconsEl.innerHTML = '';
    selected.forEach(function(p) {
      var m = platformMeta[p];
      if (!m) return;
      var iconEl = document.createElement('i');
      iconEl.className = m.icon;
      iconEl.style.cssText = 'color: ' + m.color + '; font-size: 18px;';
      iconEl.title = p;
      previewPlatformIconsEl.appendChild(iconEl);
    });
    document.getElementById('previewPlatformCount').textContent = selected.length + ' selected';

    var ct = document.getElementById('content_type').value;
    document.getElementById('previewContentType').textContent = contentTypeMeta[ct] || ct;

    var campOpt = campaignSelect.options[campaignSelect.selectedIndex];
    document.getElementById('previewCampaign').textContent = campaignSelect.value ? campOpt.textContent.trim() : 'None';

    // Language
    var langSelect = document.getElementById('ai_language');
    if (langSelect) {
      var langOpt = langSelect.options[langSelect.selectedIndex];
      document.getElementById('previewLang').textContent = langOpt ? langOpt.textContent.trim() : 'EN';
    }

    var charWarningsEl = document.getElementById('charWarnings');
    charWarningsEl.innerHTML = '';
    selected.forEach(function(p) {
      var m = platformMeta[p];
      if (m && len > m.charLimit) {
        var warn = document.createElement('div');
        warn.style.cssText = 'font-size: 12px; color: var(--danger); margin-bottom: 4px;';
        var wIcon = document.createElement('i');
        wIcon.className = m.icon;
        warn.appendChild(wIcon);
        warn.appendChild(document.createTextNode(' Over limit by ' + (len - m.charLimit) + ' chars (' + m.charLimit + ' max)'));
        charWarningsEl.appendChild(warn);
      }
      if (m && m.hashtagLimit > 0 && tags.length > m.hashtagLimit) {
        var warn2 = document.createElement('div');
        warn2.style.cssText = 'font-size: 12px; color: var(--warning); margin-bottom: 4px;';
        var wIcon2 = document.createElement('i');
        wIcon2.className = m.icon;
        warn2.appendChild(wIcon2);
        warn2.appendChild(document.createTextNode(' Too many hashtags: ' + tags.length + '/' + m.hashtagLimit));
        charWarningsEl.appendChild(warn2);
      }
    });
  }

  contentEl.addEventListener('input', updatePreview);
  hashtagsEl.addEventListener('input', updatePreview);
  document.getElementById('link_url').addEventListener('input', updatePreview);
  document.getElementById('content_type').addEventListener('change', updatePreview);
  campaignSelect.addEventListener('change', updatePreview);
  var langSelect = document.getElementById('ai_language');
  if (langSelect) langSelect.addEventListener('change', updatePreview);
  document.querySelectorAll('input[name="platforms"]').forEach(function(cb) { cb.addEventListener('change', updatePreview); });

  // Insert hashtag sets
  document.querySelectorAll('.insert-hashtag-set').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var existing = hashtagsEl.value.trim();
      var newTags = btn.dataset.hashtags;
      hashtagsEl.value = existing ? existing + ', ' + newTags : newTags;
      updatePreview();
    });
  });

  // Inherit UTM from campaign
  campaignSelect.addEventListener('change', function() {
    inheritBtn.style.display = campaignSelect.value ? '' : 'none';
  });

  inheritBtn.addEventListener('click', function() {
    var opt = campaignSelect.options[campaignSelect.selectedIndex];
    if (opt.dataset.utmSource) document.getElementById('utm_source').value = opt.dataset.utmSource;
    if (opt.dataset.utmMedium) document.getElementById('utm_medium').value = opt.dataset.utmMedium;
    if (opt.dataset.utmCampaign) document.getElementById('utm_campaign').value = opt.dataset.utmCampaign;
    if (opt.dataset.utmTerm) document.getElementById('utm_term').value = opt.dataset.utmTerm;
    if (opt.dataset.utmContent) document.getElementById('utm_content').value = opt.dataset.utmContent;
  });

  if (campaignSelect.value) inheritBtn.style.display = '';

  // ==================== AI GENERATION ====================
  var generateBtn = document.getElementById('generateBtn');
  generateBtn.addEventListener('click', function() {
    var selectedPlatforms = getSelectedPlatforms();
    if (selectedPlatforms.length === 0) {
      alert('Please select at least one platform before generating.');
      return;
    }
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    var body = {
      source_type: document.getElementById('source_type').value || null,
      source_id: document.getElementById('source_id').value || null,
      platforms: selectedPlatforms,
      tone: document.getElementById('ai_tone').value,
      style: document.getElementById('ai_style').value,
      cta: document.getElementById('ai_cta').value,
      language: document.getElementById('ai_language').value,
      ai_provider: document.getElementById('ai_engine').value,
      custom_prompt: document.getElementById('ai_custom_prompt').value || null,
    };

    fetch('/social/generate-post', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate 3 Variations';

      if (!data.success) {
        alert('AI error: ' + (data.error || 'Unknown'));
        return;
      }

      document.getElementById('ai_provider_hidden').value = data.provider;
      document.getElementById('ai_prompt_used').value = data.prompt_used || '';

      var resultsDiv = document.getElementById('aiResults');
      var variationsDiv = document.getElementById('aiVariations');
      variationsDiv.innerHTML = '';
      resultsDiv.style.display = '';
      document.getElementById('aiProviderBadge').textContent = data.provider;

      (data.variations || []).forEach(function(v, i) {
        var div = document.createElement('div');
        div.className = 'ai-variation';
        div.setAttribute('data-index', i);

        var numSpan = document.createElement('span');
        numSpan.className = 'ai-variation-number';
        numSpan.textContent = i + 1;

        var textDiv = document.createElement('div');
        textDiv.className = 'ai-variation-text';
        textDiv.textContent = v.text;

        var hashtagsDiv = document.createElement('div');
        hashtagsDiv.className = 'ai-variation-hashtags';
        (v.hashtags || []).forEach(function(h) {
          var chip = document.createElement('span');
          chip.className = 'hashtag-chip';
          chip.textContent = h;
          hashtagsDiv.appendChild(chip);
        });

        div.appendChild(numSpan);
        div.appendChild(textDiv);
        div.appendChild(hashtagsDiv);
        variationsDiv.appendChild(div);

        // Click to use this variation
        div.addEventListener('click', function() {
          document.querySelectorAll('.ai-variation').forEach(function(el) { el.classList.remove('selected'); });
          div.classList.add('selected');

          contentEl.value = v.text;
          document.getElementById('ai_generated').value = 'true';

          // Set hashtags
          if (v.hashtags && v.hashtags.length) {
            hashtagsEl.value = v.hashtags.map(function(h) { return h.replace(/^#/, ''); }).join(', ');
          }

          // Set link from source
          if (data.source && data.source.url && !document.getElementById('link_url').value) {
            document.getElementById('link_url').value = data.source.url;
          }

          updatePreview();
        });
      });
    })
    .catch(function(err) {
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate 3 Variations';
      alert('Request failed: ' + err.message);
    });
  });

  // ==================== IMAGE PICKER ====================
  var imagePickerImages = [];
  var selectedPickerImages = [];

  document.getElementById('openImagePickerBtn').addEventListener('click', function() {
    document.getElementById('imagePickerModal').style.display = 'flex';
    selectedPickerImages = [];
    loadImagePickerImages();
  });

  function loadImagePickerImages(search) {
    var grid = document.getElementById('imagePickerGrid');
    var loading = document.getElementById('imagePickerLoading');
    grid.innerHTML = '';
    loading.style.display = '';

    var url = '/api/images?limit=60';
    if (search) url += '&search=' + encodeURIComponent(search);

    fetch(url)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      loading.style.display = 'none';
      var images = data.images || data.rows || [];
      images.forEach(function(img) {
        var cdnUrl = img.cdn_url || img.file_path;
        var item = document.createElement('div');
        item.className = 'img-pick-item';
        item.setAttribute('data-url', cdnUrl);

        var imgEl = document.createElement('img');
        imgEl.src = cdnUrl;
        imgEl.alt = img.alt_text || img.title || img.filename;
        imgEl.loading = 'lazy';

        var nameEl = document.createElement('div');
        nameEl.className = 'img-pick-name';
        nameEl.textContent = img.title || img.original_filename || img.filename;

        item.appendChild(imgEl);
        item.appendChild(nameEl);
        grid.appendChild(item);

        item.addEventListener('click', function() {
          item.classList.toggle('selected');
          var idx = selectedPickerImages.indexOf(cdnUrl);
          if (idx > -1) { selectedPickerImages.splice(idx, 1); }
          else { selectedPickerImages.push(cdnUrl); }
        });
      });

      if (images.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--gray-400);">No images found</div>';
      }
    })
    .catch(function() {
      loading.style.display = 'none';
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--danger);">Failed to load images</div>';
    });
  }

  var pickerSearchTimer;
  document.getElementById('imagePickerSearch').addEventListener('input', function() {
    clearTimeout(pickerSearchTimer);
    var val = this.value;
    pickerSearchTimer = setTimeout(function() { loadImagePickerImages(val); }, 300);
  });

  // Update media preview thumbnails
  function updateMediaPreviews() {
    var grid = document.getElementById('mediaPreviewGrid');
    grid.innerHTML = '';
    var urls = document.getElementById('media_urls').value.split('\n').map(function(u) { return u.trim(); }).filter(Boolean);
    urls.forEach(function(url, i) {
      var wrap = document.createElement('div');
      wrap.className = 'media-thumb-wrap';
      var img = document.createElement('img');
      img.className = 'media-thumb';
      img.src = url;
      img.alt = 'Media ' + (i + 1);
      img.onerror = function() { this.style.display = 'none'; };
      var removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'media-thumb-remove';
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', function() {
        var lines = document.getElementById('media_urls').value.split('\n').map(function(u) { return u.trim(); }).filter(Boolean);
        lines.splice(i, 1);
        document.getElementById('media_urls').value = lines.join('\n');
        updateMediaPreviews();
      });
      wrap.appendChild(img);
      wrap.appendChild(removeBtn);
      grid.appendChild(wrap);
    });
  }

  document.getElementById('media_urls').addEventListener('input', updateMediaPreviews);
  updateMediaPreviews();

  updatePreview();
});

function closeImagePicker() {
  document.getElementById('imagePickerModal').style.display = 'none';
}

function insertSelectedImages() {
  var selected = document.querySelectorAll('#imagePickerGrid .img-pick-item.selected');
  var urls = [];
  selected.forEach(function(el) { urls.push(el.getAttribute('data-url')); });
  if (urls.length > 0) {
    var textarea = document.getElementById('media_urls');
    var existing = textarea.value.trim();
    textarea.value = existing ? existing + '\n' + urls.join('\n') : urls.join('\n');
    textarea.dispatchEvent(new Event('input'));
  }
  closeImagePicker();
}

function clearSource() {
  document.getElementById('source_type').value = '';
  document.getElementById('source_id').value = '';
  document.getElementById('source_title').value = '';
  document.getElementById('source_url').value = '';
  var sourceCard = document.querySelector('.card[style*="border-left: 4px"]');
  if (sourceCard) sourceCard.style.display = 'none';
}

// ==================== PLATFORM PREVIEW MOCKUPS ====================
function showPlatformPreview() {
  var content = document.getElementById('content').value || 'Preview text here...';
  var hashtags = document.getElementById('hashtags').value.split(',').map(function(t) { return '#' + t.trim().replace(/^#/, ''); }).filter(function(t) { return t !== '#'; });
  var link = document.getElementById('link_url').value || '';
  var platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(function(c) { return c.value; });
  var modal = document.getElementById('platformPreviewModal');
  var body = document.getElementById('platformPreviewBody');
  body.innerHTML = '';

  if (platforms.length === 0) { alert('Select platforms first'); return; }

  platforms.forEach(function(p) {
    var card = document.createElement('div');
    card.style.cssText = 'border: 1px solid var(--gray-200); border-radius: 12px; padding: 16px; margin-bottom: 16px;';

    var header = document.createElement('div');
    header.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 12px;';
    var avatar = document.createElement('div');
    avatar.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center;';
    avatar.innerHTML = '<i class="fas fa-user" style="color: var(--gray-400);"></i>';
    var nameCol = document.createElement('div');
    nameCol.innerHTML = '<div style="font-weight: 600; font-size: 14px;">Words That Sells</div><div style="font-size: 12px; color: var(--gray-400);">Just now</div>';
    header.appendChild(avatar);
    header.appendChild(nameCol);

    var platformLabel = document.createElement('div');
    var colors = { 'Facebook': '#1877f2', 'Twitter/X': '#000', 'LinkedIn': '#0a66c2', 'Instagram': '#e4405f', 'TikTok': '#000' };
    var icons = { 'Facebook': 'fab fa-facebook', 'Twitter/X': 'fab fa-x-twitter', 'LinkedIn': 'fab fa-linkedin', 'Instagram': 'fab fa-instagram', 'TikTok': 'fab fa-tiktok' };
    var iconEl = document.createElement('i');
    iconEl.className = icons[p] || 'fas fa-globe';
    iconEl.style.color = colors[p] || '#666';
    iconEl.style.fontSize = '16px';
    platformLabel.appendChild(iconEl);
    platformLabel.appendChild(document.createTextNode(' '));
    var strongEl = document.createElement('strong');
    strongEl.textContent = p;
    platformLabel.appendChild(strongEl);
    platformLabel.style.cssText = 'margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--gray-100);';

    var limits = { 'Twitter/X': 280, 'Facebook': 63206, 'LinkedIn': 3000, 'Instagram': 2200, 'TikTok': 2200 };
    var limit = limits[p] || 500;
    var text = content;
    if (text.length > limit) text = text.substring(0, limit - 3) + '...';

    var textEl = document.createElement('div');
    textEl.style.cssText = 'font-size: 14px; line-height: 1.6; white-space: pre-wrap; margin-bottom: 8px;';
    textEl.textContent = text;

    var hashEl = document.createElement('div');
    hashEl.style.cssText = 'color: var(--primary); font-size: 13px; margin-bottom: 8px;';
    hashEl.textContent = hashtags.join(' ');

    var linkEl = document.createElement('div');
    if (link) {
      linkEl.style.cssText = 'background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 10px; font-size: 12px;';
      linkEl.innerHTML = '<i class="fas fa-link" style="color: var(--gray-400);"></i> ';
      linkEl.appendChild(document.createTextNode(link));
    }

    var charInfo = document.createElement('div');
    charInfo.style.cssText = 'font-size: 11px; color: var(--gray-400); margin-top: 8px; text-align: right;';
    charInfo.textContent = text.length + ' / ' + limit + ' chars';
    if (text.length > limit * 0.9) charInfo.style.color = 'var(--danger)';

    card.appendChild(platformLabel);
    card.appendChild(header);
    card.appendChild(textEl);
    if (hashtags.length) card.appendChild(hashEl);
    if (link) card.appendChild(linkEl);
    card.appendChild(charInfo);
    body.appendChild(card);
  });

  modal.style.display = 'flex';
}

function closePlatformPreview() {
  document.getElementById('platformPreviewModal').style.display = 'none';
}

// ==================== BITLY SHORTEN ====================
function shortenLink() {
  <% if (post) { %>
  var postId = '<%= post.id %>';
  var btn = document.getElementById('shortenBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

  fetch('/social/posts/' + postId + '/shorten', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-link"></i> Shorten';
    if (d.success && d.short_url) {
      document.getElementById('link_url').value = d.short_url;
      alert('Link shortened: ' + d.short_url);
    } else {
      alert('UTM URL: ' + (d.utm_url || 'N/A') + '\n\n' + (d.error || 'Bitly not configured'));
    }
  });
  <% } else { %>
  alert('Save the post first, then shorten.');
  <% } %>
}
</script>

<!-- Platform Preview Modal -->
<div id="platformPreviewModal" class="modal-overlay" style="display: none;">
  <div class="modal" style="max-width: 700px; max-height: 85vh;">
    <div class="modal-header">
      <h3><i class="fas fa-eye"></i> Platform Previews</h3>
      <button type="button" class="modal-close" onclick="closePlatformPreview()">&times;</button>
    </div>
    <div class="modal-body" id="platformPreviewBody" style="overflow-y: auto; max-height: 65vh;"></div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closePlatformPreview()">Close</button>
    </div>
  </div>
</div>

<%- include('../../partials/footer') %>
