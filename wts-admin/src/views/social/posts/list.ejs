<%- include('../../partials/head', { title, bodyClass: 'dashboard-layout' }) %>
<%- include('../../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Social Posts</h1>
        <p class="page-subtitle">Manage your social media content across all platforms</p>
      </div>
      <div class="page-actions">
        <a href="/social/content-hub" class="btn btn-secondary"><i class="fas fa-wand-magic-sparkles"></i> Content Hub</a>
        <a href="/social/calendar" class="btn btn-secondary"><i class="fas fa-calendar"></i> Calendar</a>
        <a href="/social/posts/new" class="btn btn-primary"><i class="fas fa-plus"></i> New Post</a>
      </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="card-body" style="padding: 16px 24px;">
        <form action="/social/posts" method="GET" class="filter-form">
          <select name="status" class="form-input filter-select">
            <option value="">All Status</option>
            <option value="draft" <%= filter.status === 'draft' ? 'selected' : '' %>>Draft</option>
            <option value="scheduled" <%= filter.status === 'scheduled' ? 'selected' : '' %>>Scheduled</option>
            <option value="published" <%= filter.status === 'published' ? 'selected' : '' %>>Published</option>
          </select>
          <select name="campaign" class="form-input filter-select">
            <option value="">All Campaigns</option>
            <% campaigns.forEach(c => { %>
            <option value="<%= c.id %>" <%= filter.campaign == c.id ? 'selected' : '' %>><%= c.name %></option>
            <% }); %>
          </select>
          <select name="content_type" class="form-input filter-select">
            <option value="">All Types</option>
            <% contentTypes.forEach(ct => { %>
            <option value="<%= ct.id %>" <%= filter.content_type === ct.id ? 'selected' : '' %>><%= ct.label %></option>
            <% }); %>
          </select>
          <select name="source" class="form-input filter-select">
            <option value="">All Sources</option>
            <option value="article" <%= filter.source === 'article' ? 'selected' : '' %>>Article</option>
            <option value="glossary" <%= filter.source === 'glossary' ? 'selected' : '' %>>Glossary</option>
            <option value="ai_tool" <%= filter.source === 'ai_tool' ? 'selected' : '' %>>AI Tool</option>
            <option value="guide" <%= filter.source === 'guide' ? 'selected' : '' %>>Guide</option>
            <option value="service" <%= filter.source === 'service' ? 'selected' : '' %>>Service</option>
            <option value="standalone" <%= filter.source === 'standalone' ? 'selected' : '' %>>Standalone</option>
          </select>
          <button type="submit" class="btn btn-secondary btn-sm"><i class="fas fa-filter"></i> Filter</button>
          <% if (filter.status || filter.campaign || filter.content_type || filter.source) { %>
          <a href="/social/posts" class="btn btn-sm" style="color: var(--gray-500);"><i class="fas fa-times"></i> Clear</a>
          <% } %>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body" style="padding: 0;">
        <% if (posts.length > 0) { %>
        <div class="table-container">
          <table class="table table-responsive-cards">
            <thead>
              <tr>
                <th>Content</th>
                <th>Source</th>
                <th>Campaign</th>
                <th>Platforms</th>
                <th>Type</th>
                <th>Scheduled</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% posts.forEach(post => { %>
              <tr>
                <td data-label="Content" style="max-width: 280px;">
                  <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;">
                    <%= post.content ? post.content.substring(0, 80) : '' %><%= post.content && post.content.length > 80 ? '...' : '' %>
                  </div>
                  <% if (post.hashtags && post.hashtags.length > 0) { %>
                  <div style="margin-top: 4px;">
                    <% post.hashtags.slice(0, 3).forEach(h => { %>
                    <span style="font-size: 11px; color: var(--primary); margin-right: 4px;"><%= h %></span>
                    <% }); %>
                    <% if (post.hashtags.length > 3) { %>
                    <span style="font-size: 11px; color: var(--gray-400);">+<%= post.hashtags.length - 3 %></span>
                    <% } %>
                  </div>
                  <% } %>
                </td>
                <td data-label="Source">
                  <% if (post.source_type) { %>
                  <span class="source-badge source-badge-<%= post.source_type %>"><%= post.source_type %></span>
                  <% if (post.ai_generated) { %><i class="fas fa-robot" style="font-size: 11px; color: var(--gray-400); margin-left: 4px;" title="AI generated"></i><% } %>
                  <% } else { %>
                  <span style="color: var(--gray-400); font-size: 12px;">-</span>
                  <% } %>
                </td>
                <td data-label="Campaign">
                  <% if (post.campaign_name) { %>
                  <span class="campaign-badge" style="border-left: 3px solid <%= post.campaign_color || '#667eea' %>; padding-left: 8px; font-size: 13px;">
                    <%= post.campaign_name %>
                  </span>
                  <% } else { %>
                  <span style="color: var(--gray-400); font-size: 13px;">-</span>
                  <% } %>
                </td>
                <td data-label="Platforms">
                  <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <%
                    const platformIcons = {
                      'Facebook': 'fab fa-facebook', 'Instagram': 'fab fa-instagram', 'Twitter/X': 'fab fa-x-twitter',
                      'LinkedIn': 'fab fa-linkedin', 'TikTok': 'fab fa-tiktok', 'YouTube': 'fab fa-youtube',
                      'Pinterest': 'fab fa-pinterest', 'Google Business': 'fab fa-google', 'Threads': 'fas fa-at', 'Snapchat': 'fab fa-snapchat'
                    };
                    const platformColors = {
                      'Facebook': '#1877f2', 'Instagram': '#e4405f', 'Twitter/X': '#000', 'LinkedIn': '#0a66c2',
                      'TikTok': '#000', 'YouTube': '#ff0000', 'Pinterest': '#e60023', 'Google Business': '#4285f4', 'Threads': '#000', 'Snapchat': '#fffc00'
                    };
                    %>
                    <% if (post.platforms) { post.platforms.forEach(p => { %>
                    <i class="<%= platformIcons[p] || 'fas fa-globe' %>" style="color: <%= platformColors[p] || 'var(--gray-500)' %>; font-size: 16px;" title="<%= p %>"></i>
                    <% }); } %>
                  </div>
                </td>
                <td data-label="Type">
                  <% if (post.content_type && post.content_type !== 'text') { %>
                  <span style="font-size: 12px; padding: 2px 8px; background: var(--gray-100); border-radius: 12px; color: var(--gray-600);"><%= post.content_type %></span>
                  <% } else { %>
                  <span style="color: var(--gray-400); font-size: 13px;">text</span>
                  <% } %>
                </td>
                <td data-label="Scheduled" style="font-size: 13px; white-space: nowrap;">
                  <% if (post.scheduled_at) { %>
                  <div><%= new Date(post.scheduled_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></div>
                  <div style="color: var(--gray-500); font-size: 12px;"><%= new Date(post.scheduled_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></div>
                  <% } else { %>
                  <span style="color: var(--gray-400);">-</span>
                  <% } %>
                </td>
                <td data-label="Status"><span class="status-badge <%= post.status %>"><%= post.status %></span></td>
                <td data-label="Actions">
                  <div class="table-actions">
                    <% if (post.status !== 'published') { %>
                    <button type="button" class="btn btn-sm btn-primary publish-btn" data-post-id="<%= post.id %>" title="Publish Now"><i class="fas fa-paper-plane"></i></button>
                    <% } %>
                    <a href="/social/posts/<%= post.id %>/edit" class="btn btn-sm btn-secondary" title="Edit"><i class="fas fa-edit"></i></a>
                    <form action="/social/posts/<%= post.id %>/clone" method="POST" style="display: inline;">
                      <button type="submit" class="btn btn-sm btn-secondary" title="Clone"><i class="fas fa-copy"></i></button>
                    </form>
                    <form action="/social/posts/<%= post.id %>/delete" method="POST" style="display: inline;">
                      <button type="submit" class="btn btn-sm btn-danger" data-confirm-delete title="Delete"><i class="fas fa-trash"></i></button>
                    </form>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
        <% } else { %>
        <div class="empty-state">
          <div class="empty-state-icon"><i class="fas fa-share-alt"></i></div>
          <h3>No Social Posts</h3>
          <p>Create your first social media post to get started.</p>
          <a href="/social/posts/new" class="btn btn-primary"><i class="fas fa-plus"></i> New Post</a>
        </div>
        <% } %>
      </div>
    </div>

    <% if (posts.length > 0) { %>
    <div style="margin-top: 16px; text-align: center; color: var(--gray-500); font-size: 13px;">
      Showing <%= posts.length %> post<%= posts.length !== 1 ? 's' : '' %>
    </div>
    <% } %>
  </div>
</main>

<style>
.source-badge {
  font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 12px;
  text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
}
.source-badge-article { background: #dbeafe; color: #1e40af; }
.source-badge-glossary { background: #d1fae5; color: #065f46; }
.source-badge-ai_tool { background: #ede9fe; color: #5b21b6; }
.source-badge-guide { background: #ffedd5; color: #9a3412; }
.source-badge-service { background: #fce7f3; color: #9d174d; }
</style>

<script>
document.querySelectorAll('.publish-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var postId = btn.dataset.postId;
    if (!confirm('Publish this post to all connected platforms?')) return;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch('/social/posts/' + postId + '/publish', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        var summary = Object.entries(data.results).map(function(e) {
          return e[0] + ': ' + (e[1].success ? 'OK' : 'Failed - ' + (e[1].error || e[1].reason || 'unknown'));
        }).join('\n');
        alert('Publishing results:\n' + summary);
        window.location.reload();
      } else {
        alert('Publish failed: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
      }
    })
    .catch(function(err) {
      alert('Error: ' + err.message);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
    });
  });
});
</script>

<%- include('../../partials/footer') %>
