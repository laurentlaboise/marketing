<%- include('../partials/head', { title }) %>

<div class="dashboard-layout">
  <%- include('../partials/sidebar') %>

  <div class="main-content">
    <%- include('../partials/header') %>

    <div class="page-content">
      <div class="page-header">
        <div>
          <h1>Analytics Dashboard</h1>
          <p class="page-subtitle">Performance metrics across all channels</p>
        </div>
        <div class="page-actions">
          <button class="btn btn-secondary" onclick="syncClicks()"><i class="fas fa-sync"></i> Sync Clicks</button>
          <button class="btn btn-secondary" onclick="loadInsights()"><i class="fas fa-brain"></i> AI Insights</button>
          <a href="/social/analytics" class="btn btn-secondary"><i class="fas fa-chart-bar"></i> Simple View</a>
        </div>
      </div>

      <!-- Overview Cards -->
      <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(32,133,200,0.1); color: var(--primary);"><i class="fas fa-paper-plane"></i></div>
          <div class="stat-info">
            <span class="stat-value"><%= overview.published || 0 %></span>
            <span class="stat-label">Published</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(245,158,11,0.1); color: var(--warning);"><i class="fas fa-clock"></i></div>
          <div class="stat-info">
            <span class="stat-value"><%= overview.scheduled || 0 %></span>
            <span class="stat-label">Scheduled</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(16,185,129,0.1); color: var(--success);"><i class="fas fa-mouse-pointer"></i></div>
          <div class="stat-info">
            <span class="stat-value"><%= overview.total_clicks || 0 %></span>
            <span class="stat-label">Total Clicks</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(139,92,246,0.1); color: #8b5cf6;"><i class="fas fa-bullseye"></i></div>
          <div class="stat-info">
            <span class="stat-value"><%= overview.campaigns_used || 0 %></span>
            <span class="stat-label">Active Campaigns</span>
          </div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
        <!-- Platform Breakdown -->
        <div class="card">
          <div class="card-header"><h3><i class="fas fa-chart-pie"></i> Platform Breakdown</h3></div>
          <div class="card-body">
            <% if (platformStats.length > 0) { %>
            <% platformStats.forEach(function(p) {
              const colors = { 'Facebook': '#1877f2', 'Twitter/X': '#000', 'Instagram': '#e4405f', 'LinkedIn': '#0a66c2', 'TikTok': '#000', 'Pinterest': '#e60023', 'YouTube': '#ff0000' };
              const maxCount = Math.max(...platformStats.map(x => parseInt(x.count)));
            %>
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                <span><strong><%= p.platform %></strong></span>
                <span><%= p.count %> posts / <%= p.clicks || 0 %> clicks</span>
              </div>
              <div style="background: var(--gray-100); border-radius: 4px; height: 8px; overflow: hidden;">
                <div style="background: <%= colors[p.platform] || 'var(--primary)' %>; height: 100%; width: <%= (parseInt(p.count) / maxCount * 100) %>%; border-radius: 4px;"></div>
              </div>
            </div>
            <% }); %>
            <% } else { %>
            <p style="color: var(--gray-400); text-align: center; padding: 24px;">No published posts yet</p>
            <% } %>
          </div>
        </div>

        <!-- AI Provider Usage -->
        <div class="card">
          <div class="card-header"><h3><i class="fas fa-robot"></i> AI Provider Usage</h3></div>
          <div class="card-body">
            <% if (aiCost.length > 0) { %>
            <% aiCost.forEach(function(a) { %>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-100);">
              <span style="font-size: 14px;"><code><%= a.ai_provider %></code></span>
              <span style="font-size: 14px; font-weight: 600;"><%= a.uses %> posts</span>
            </div>
            <% }); %>
            <div style="margin-top: 12px; text-align: right;">
              <button class="btn btn-sm btn-secondary" onclick="loadCosts()"><i class="fas fa-dollar-sign"></i> View Costs</button>
            </div>
            <% } else { %>
            <p style="color: var(--gray-400); text-align: center; padding: 24px;">No AI-generated posts yet</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Campaign Performance -->
      <% if (campaignStats.length > 0) { %>
      <div class="card" style="margin-bottom: 24px;">
        <div class="card-header"><h3><i class="fas fa-bullhorn"></i> Campaign Performance</h3></div>
        <div class="card-body" style="padding: 0;">
          <div class="table-container">
            <table class="table">
              <thead><tr><th>Campaign</th><th>Posts</th><th>Clicks</th><th>CTR</th></tr></thead>
              <tbody>
                <% campaignStats.forEach(function(c) { %>
                <tr>
                  <td><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: <%= c.color || 'var(--primary)' %>; margin-right: 8px;"></span><%= c.name %></td>
                  <td><%= c.posts %></td>
                  <td><%= c.clicks || 0 %></td>
                  <td><%= parseInt(c.posts) > 0 ? ((parseInt(c.clicks || 0) / parseInt(c.posts)) * 100).toFixed(1) + '%' : '-' %></td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <% } %>

      <!-- Top Posts -->
      <div class="card" style="margin-bottom: 24px;">
        <div class="card-header"><h3><i class="fas fa-trophy"></i> Top Performing Posts</h3></div>
        <div class="card-body" style="padding: 0;">
          <% if (topPosts.length > 0) { %>
          <div class="table-container">
            <table class="table">
              <thead><tr><th style="width: 50%;">Content</th><th>Platform</th><th>Source</th><th>Clicks</th><th>Link</th></tr></thead>
              <tbody>
                <% topPosts.forEach(function(post) { %>
                <tr>
                  <td style="font-size: 13px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><%= (post.content || '').substring(0, 80) %></td>
                  <td><%= (post.platforms || []).join(', ') %></td>
                  <td><span class="source-badge source-badge-<%= post.source_type || 'standalone' %>" style="font-size: 10px; padding: 2px 6px;"><%= post.source_type || 'standalone' %></span></td>
                  <td style="font-weight: 700;"><%= post.bitly_clicks || 0 %></td>
                  <td>
                    <% if (post.bitly_url) { %>
                    <a href="<%= post.bitly_url %>" target="_blank" style="font-size: 12px;"><%= post.bitly_url %></a>
                    <% } else { %>-<% } %>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <% } else { %>
          <div style="text-align: center; padding: 32px; color: var(--gray-400);">No published posts yet</div>
          <% } %>
        </div>
      </div>

      <!-- AI Insights Panel -->
      <div class="card" id="insights-card" style="display: none; margin-bottom: 24px;">
        <div class="card-header"><h3><i class="fas fa-brain"></i> AI-Powered Insights</h3></div>
        <div class="card-body" id="insights-body">
          <div style="text-align: center; padding: 24px;"><i class="fas fa-spinner fa-spin"></i> Generating insights...</div>
        </div>
      </div>

      <!-- Cost Breakdown Panel -->
      <div class="card" id="costs-card" style="display: none;">
        <div class="card-header"><h3><i class="fas fa-dollar-sign"></i> AI Cost Breakdown</h3></div>
        <div class="card-body" id="costs-body">
          <div style="text-align: center; padding: 24px;"><i class="fas fa-spinner fa-spin"></i> Loading costs...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.source-badge { font-size: 11px; font-weight: 600; padding: 2px 10px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.source-badge-standalone { background: var(--gray-100); color: var(--gray-600); }
.source-badge-article { background: #dbeafe; color: #1e40af; }
.source-badge-glossary { background: #d1fae5; color: #065f46; }
.source-badge-ai_tool { background: #ede9fe; color: #5b21b6; }
.source-badge-guide { background: #ffedd5; color: #9a3412; }
.source-badge-service { background: #fce7f3; color: #9d174d; }
</style>

<script>
function syncClicks() {
  fetch('/social/analytics/sync-clicks', { method: 'POST' })
  .then(function(r) { return r.json(); })
  .then(function(d) { alert('Synced ' + d.synced + ' of ' + d.total + ' posts'); window.location.reload(); })
  .catch(function(e) { alert('Sync error: ' + e.message); });
}

function loadInsights() {
  document.getElementById('insights-card').style.display = 'block';
  fetch('/social/analytics/insights')
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.success && d.insights) {
      var i = d.insights;
      var html = '<p style="font-size: 15px; margin-bottom: 16px;"><strong>' + (i.summary || '') + '</strong></p>';
      if (i.insights && i.insights.length) {
        html += '<h4 style="margin-bottom: 8px;">Key Insights</h4><ul style="margin-bottom: 16px;">';
        i.insights.forEach(function(x) { html += '<li style="margin-bottom: 4px;">' + x + '</li>'; });
        html += '</ul>';
      }
      if (i.recommendations && i.recommendations.length) {
        html += '<h4 style="margin-bottom: 8px;">Recommendations</h4><ul style="margin-bottom: 16px;">';
        i.recommendations.forEach(function(x) { html += '<li style="margin-bottom: 4px;">' + x + '</li>'; });
        html += '</ul>';
      }
      if (i.post_suggestion) {
        html += '<div style="background: var(--gray-50); padding: 12px; border-radius: 8px;"><strong>Suggested Next Post:</strong> ' + i.post_suggestion + '</div>';
      }
      document.getElementById('insights-body').innerHTML = html;
    }
  });
}

function loadCosts() {
  document.getElementById('costs-card').style.display = 'block';
  fetch('/social/analytics/costs')
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.success) {
      var html = '<div class="table-container"><table class="table"><thead><tr><th>Provider</th><th>Posts Generated</th><th>Est. Cost</th></tr></thead><tbody>';
      d.providers.forEach(function(p) {
        html += '<tr><td>' + p.provider_name + '</td><td>' + p.uses + '</td><td>$' + p.estimated_cost + '</td></tr>';
      });
      html += '</tbody></table></div>';
      html += '<div style="text-align: right; margin-top: 12px; font-weight: 700; font-size: 16px;">Total: $' + d.total_estimated + '</div>';
      document.getElementById('costs-body').innerHTML = html;
    }
  });
}
</script>

<%- include('../partials/footer') %>
