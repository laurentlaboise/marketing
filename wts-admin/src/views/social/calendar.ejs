<%- include('../partials/head', { title, bodyClass: 'dashboard-layout' }) %>
<%- include('../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../partials/header', { user, messages }) %>

  <div class="page-content">
    <%
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const prevMonth = month === 0 ? 11 : month - 1;
      const prevYear = month === 0 ? year - 1 : year;
      const nextMonth = month === 11 ? 0 : month + 1;
      const nextYear = month === 11 ? year + 1 : year;
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

      // Group posts by day
      const postsByDay = {};
      posts.forEach(p => {
        if (p.scheduled_at) {
          const d = new Date(p.scheduled_at).getDate();
          if (!postsByDay[d]) postsByDay[d] = [];
          postsByDay[d].push(p);
        }
      });

      // Platform icons lookup
      const pIcons = {
        'Facebook': 'fab fa-facebook', 'Instagram': 'fab fa-instagram', 'Twitter/X': 'fab fa-x-twitter',
        'LinkedIn': 'fab fa-linkedin', 'TikTok': 'fab fa-tiktok', 'YouTube': 'fab fa-youtube',
        'Pinterest': 'fab fa-pinterest', 'Google Business': 'fab fa-google', 'Threads': 'fas fa-at', 'Snapchat': 'fab fa-snapchat'
      };
    %>

    <div class="page-header">
      <div>
        <h1 class="page-title">Content Calendar</h1>
        <p class="page-subtitle">Plan and visualize your social media schedule</p>
      </div>
      <div class="page-actions">
        <a href="/social/posts/new" class="btn btn-primary"><i class="fas fa-plus"></i> New Post</a>
      </div>
    </div>

    <!-- Month Navigation -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="card-body calendar-month-nav">
        <a href="/social/calendar?month=<%= prevMonth %>&year=<%= prevYear %>" class="btn btn-secondary btn-sm">
          <i class="fas fa-chevron-left"></i> <%= monthNames[prevMonth] %>
        </a>
        <div style="text-align: center;">
          <h2 style="font-size: 20px; font-weight: 700; color: var(--gray-900);"><%= monthNames[month] %> <%= year %></h2>
          <p style="font-size: 13px; color: var(--gray-500);">
            <%= posts.length %> post<%= posts.length !== 1 ? 's' : '' %> scheduled
            <% if (!isCurrentMonth) { %> &middot; <a href="/social/calendar">Today</a><% } %>
          </p>
        </div>
        <a href="/social/calendar?month=<%= nextMonth %>&year=<%= nextYear %>" class="btn btn-secondary btn-sm">
          <%= monthNames[nextMonth] %> <i class="fas fa-chevron-right"></i>
        </a>
      </div>
    </div>

    <!-- Campaign Legend -->
    <% if (campaigns.length > 0) { %>
    <div class="legend-row">
      <% campaigns.forEach(c => { %>
      <div class="legend-item">
        <span class="legend-dot" style="background: <%= c.color || '#667eea' %>;"></span>
        <span style="color: var(--gray-600);"><%= c.name %></span>
      </div>
      <% }); %>
    </div>
    <% } %>

    <!-- Calendar Grid -->
    <div class="card">
      <div class="card-body" style="padding: 0;">
        <div class="cal-grid">
          <!-- Day Headers -->
          <% dayNames.forEach(day => { %>
          <div class="cal-header"><%= day %></div>
          <% }); %>

          <!-- Empty cells before first day -->
          <% for (let i = 0; i < firstDay; i++) { %>
          <div class="cal-cell cal-empty"></div>
          <% } %>

          <!-- Day cells -->
          <% for (let day = 1; day <= daysInMonth; day++) { %>
          <%
            const isToday = isCurrentMonth && today.getDate() === day;
            const dayPosts = postsByDay[day] || [];
          %>
          <div class="cal-cell <%= isToday ? 'cal-today' : '' %> <%= dayPosts.length > 0 ? 'cal-has-posts' : '' %>">
            <div class="cal-day-header">
              <span class="cal-day-num <%= isToday ? 'today-marker' : '' %>"><%= day %></span>
              <% if (dayPosts.length === 0) { %>
              <a href="/social/posts/new?scheduled_date=<%= year %>-<%= String(month + 1).padStart(2, '0') %>-<%= String(day).padStart(2, '0') %>" class="cal-add-btn" title="Add post">
                <i class="fas fa-plus"></i>
              </a>
              <% } %>
            </div>
            <div class="cal-posts">
              <% dayPosts.slice(0, 3).forEach(post => { %>
              <a href="/social/posts/<%= post.id %>/edit" class="cal-post" style="border-left-color: <%= post.campaign_color || 'var(--primary)' %>;">
                <div class="cal-post-time">
                  <%= new Date(post.scheduled_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %>
                </div>
                <div class="cal-post-content"><%= post.content ? post.content.substring(0, 50) : 'No content' %></div>
                <div class="cal-post-platforms">
                  <% if (post.platforms) { post.platforms.slice(0, 4).forEach(p => { %>
                  <i class="<%= pIcons[p] || 'fas fa-globe' %>" title="<%= p %>"></i>
                  <% }); } %>
                  <span class="status-badge <%= post.status %>" style="font-size: 10px; padding: 1px 6px;"><%= post.status %></span>
                </div>
              </a>
              <% }); %>
              <% if (dayPosts.length > 3) { %>
              <div style="font-size: 11px; color: var(--gray-500); padding: 4px 8px;">+<%= dayPosts.length - 3 %> more</div>
              <% } %>
            </div>
          </div>
          <% } %>

          <!-- Empty cells after last day -->
          <% const totalCells = firstDay + daysInMonth; %>
          <% const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7); %>
          <% for (let i = 0; i < remaining; i++) { %>
          <div class="cal-cell cal-empty"></div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Upcoming Posts List -->
    <% const upcoming = posts.filter(p => new Date(p.scheduled_at) >= today).slice(0, 5); %>
    <% if (upcoming.length > 0) { %>
    <div class="card" style="margin-top: 20px;">
      <div class="card-header">
        <h2 class="card-title"><i class="fas fa-clock"></i> Upcoming Posts</h2>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="table-container">
          <table class="table table-responsive-cards">
            <thead>
              <tr>
                <th>Date & Time</th>
                <th>Content</th>
                <th>Campaign</th>
                <th>Platforms</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% upcoming.forEach(post => { %>
              <tr>
                <td data-label="Date & Time" style="font-size: 13px;">
                  <div><%= new Date(post.scheduled_at).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %></div>
                  <div style="color: var(--gray-500);"><%= new Date(post.scheduled_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></div>
                </td>
                <td data-label="Content">
                  <a href="/social/posts/<%= post.id %>/edit">
                    <%= post.content ? post.content.substring(0, 80) : '' %>
                  </a>
                </td>
                <td data-label="Campaign">
                  <% if (post.campaign_name) { %>
                  <span style="border-left: 3px solid <%= post.campaign_color || '#667eea' %>; padding-left: 8px; font-size: 13px;"><%= post.campaign_name %></span>
                  <% } else { %>-<% } %>
                </td>
                <td data-label="Platforms">
                  <% if (post.platforms) { post.platforms.forEach(p => { %>
                  <i class="<%= pIcons[p] || 'fas fa-globe' %>" style="margin-right: 3px;" title="<%= p %>"></i>
                  <% }); } %>
                </td>
                <td data-label="Status"><span class="status-badge <%= post.status %>"><%= post.status %></span></td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</main>

<%- include('../partials/footer') %>
