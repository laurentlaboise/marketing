<%- include('../../partials/head', { title, bodyClass: 'dashboard-layout' }) %>

<%- include('../../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title"><%= article ? 'Edit Article' : 'New Article' %></h1>
        <p class="page-subtitle">
          <a href="/content/articles" id="backToArticlesLink"><i class="fas fa-arrow-left"></i> Back to Articles</a>
        </p>
      </div>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <i class="fas fa-exclamation-circle"></i>
      <span><%= error %></span>
    </div>
    <% } %>

    <div class="card" style="max-width: 1100px; overflow: visible;">
      <div class="card-body" style="padding: 0;">
        <form id="articleForm" action="<%= article ? '/content/articles/' + article.id : '/content/articles' %>" method="POST">

          <!-- ===== STICKY ACTION BAR ===== -->
          <div class="sticky-action-bar" id="stickyActionBar">
            <div class="sticky-bar-left">
              <button type="button" id="aiArticleBtn" class="btn btn-secondary btn-sm">
                <i class="fas fa-robot"></i> AI Auto-fill
              </button>
              <div class="completion-indicator" id="completionIndicator">
                <span class="completion-dot" data-section="content" title="Content"></span>
                <span class="completion-dot" data-section="seo" title="SEO"></span>
                <span class="completion-dot" data-section="social" title="Social"></span>
                <span class="completion-dot" data-section="advanced" title="Advanced"></span>
                <span class="completion-dot" data-section="publish" title="Publish"></span>
                <span class="completion-text" id="completionText">0/5</span>
              </div>
            </div>
            <div class="sticky-bar-right">
              <span class="unsaved-badge" id="unsavedBadge" style="display: none;">
                <i class="fas fa-circle"></i> Unsaved
              </span>
              <a href="/content/articles" class="btn btn-secondary btn-sm" id="cancelBtn">Cancel</a>
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-save"></i> <%= article ? 'Update' : 'Create' %>
              </button>
            </div>
          </div>

          <!-- AI Analysis Status -->
          <div id="aiArticleStatus" style="display: none; padding: 0 24px; margin-bottom: 8px;"></div>

          <!-- ===== ORGANIZATION STRIP (Always Visible) ===== -->
          <div class="org-strip">
            <div class="org-strip-field">
              <label class="org-strip-label">Status</label>
              <select id="status" name="status" class="org-strip-select">
                <option value="draft" <%= !article || article.status === 'draft' ? 'selected' : '' %>>Draft</option>
                <option value="published" <%= article && article.status === 'published' ? 'selected' : '' %>>Published</option>
              </select>
            </div>
            <div class="org-strip-field">
              <label class="org-strip-label">Category</label>
              <select id="category" name="category" class="org-strip-select">
                <option value="">Select...</option>
                <option value="Digital Marketing" <%= article && article.category === 'Digital Marketing' ? 'selected' : '' %>>Digital Marketing</option>
                <option value="SEO" <%= article && article.category === 'SEO' ? 'selected' : '' %>>SEO</option>
                <option value="AI & Automation" <%= article && article.category === 'AI & Automation' ? 'selected' : '' %>>AI & Automation</option>
                <option value="Social Media Marketing" <%= article && article.category === 'Social Media Marketing' ? 'selected' : '' %>>Social Media Marketing</option>
                <option value="Content Strategy" <%= article && article.category === 'Content Strategy' ? 'selected' : '' %>>Content Strategy</option>
                <option value="Business Growth" <%= article && article.category === 'Business Growth' ? 'selected' : '' %>>Business Growth</option>
                <option value="Web Development" <%= article && article.category === 'Web Development' ? 'selected' : '' %>>Web Development</option>
                <option value="E-Commerce" <%= article && article.category === 'E-Commerce' ? 'selected' : '' %>>E-Commerce</option>
                <option value="Analytics & Data" <%= article && article.category === 'Analytics & Data' ? 'selected' : '' %>>Analytics & Data</option>
                <option value="Email Marketing" <%= article && article.category === 'Email Marketing' ? 'selected' : '' %>>Email Marketing</option>
                <option value="PPC & Paid Advertising" <%= article && article.category === 'PPC & Paid Advertising' ? 'selected' : '' %>>PPC & Paid Advertising</option>
                <option value="Branding & Design" <%= article && article.category === 'Branding & Design' ? 'selected' : '' %>>Branding & Design</option>
                <%/* Legacy category mapping */%>
                <option value="marketing" <%= article && article.category === 'marketing' ? 'selected' : '' %> style="display:none">Marketing (legacy)</option>
                <option value="seo" <%= article && article.category === 'seo' ? 'selected' : '' %> style="display:none">SEO (legacy)</option>
                <option value="ai" <%= article && article.category === 'ai' ? 'selected' : '' %> style="display:none">AI (legacy)</option>
                <option value="social-media" <%= article && article.category === 'social-media' ? 'selected' : '' %> style="display:none">Social Media (legacy)</option>
                <option value="content" <%= article && article.category === 'content' ? 'selected' : '' %> style="display:none">Content (legacy)</option>
                <option value="business" <%= article && article.category === 'business' ? 'selected' : '' %> style="display:none">Business (legacy)</option>
              </select>
            </div>
            <div class="org-strip-field">
              <label class="org-strip-checkbox">
                <input type="checkbox" name="featured" value="true" <%= article && article.featured ? 'checked' : '' %>>
                <span>Featured</span>
              </label>
            </div>
            <div class="org-strip-field" style="flex: 2;">
              <label class="org-strip-label">Tags</label>
              <input type="text" id="tags" name="tags" class="org-strip-select" placeholder="marketing, seo, tips" value="<%= article && article.tags ? article.tags.join(', ') : '' %>">
            </div>
          </div>

          <!-- ===== TAB NAVIGATION ===== -->
          <div class="form-tabs" id="formTabs">
            <button type="button" class="form-tab active" data-tab="content">
              <i class="fas fa-file-alt"></i> Content
            </button>
            <button type="button" class="form-tab" data-tab="seo">
              <i class="fas fa-search"></i> SEO
            </button>
            <button type="button" class="form-tab" data-tab="social">
              <i class="fas fa-share-alt"></i> Social
            </button>
            <button type="button" class="form-tab" data-tab="advanced">
              <i class="fas fa-cogs"></i> Advanced
            </button>
            <button type="button" class="form-tab" data-tab="publish">
              <i class="fas fa-rocket"></i> Publish
            </button>
          </div>

          <!-- ===== TAB: CONTENT ===== -->
          <div class="form-tab-panel active" id="panel-content" style="display:block;">
          <div class="form-section">
            <h3 class="form-section-title" style="margin-bottom: 16px;">Article Content</h3>

            <div class="form-group">
              <label class="form-label" for="title">Title *</label>
              <input type="text" id="title" name="title" class="form-input" value="<%= article ? article.title : '' %>" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="excerpt">Excerpt</label>
              <textarea id="excerpt" name="excerpt" class="form-input" rows="2" placeholder="Brief summary of the article"><%= article ? article.excerpt : '' %></textarea>
            </div>

            <div class="form-group">
              <label class="form-label" for="featured_image"><i class="fas fa-image"></i> Featured Image</label>
              <div class="featured-image-picker" id="featuredImagePicker">
                <div id="featuredImagePreview" class="featured-image-preview" style="<%= article && article.featured_image ? '' : 'display:none;' %>">
                  <img id="featuredImageThumb" src="<%= article && article.featured_image ? article.featured_image : '' %>" alt="Featured image preview">
                  <button type="button" class="featured-image-remove" id="removeFeaturedImageBtn" title="Remove image">&times;</button>
                </div>
                <div id="featuredImageEmpty" class="featured-image-empty" style="<%= article && article.featured_image ? 'display:none;' : '' %>">
                  <i class="fas fa-image"></i>
                  <span>No featured image selected</span>
                </div>
                <div class="image-url-row" style="margin-top: 8px;">
                  <button type="button" class="btn btn-secondary btn-sm" id="openFeaturedImageBtn">
                    <i class="fas fa-photo-video"></i> Choose from Library
                  </button>
                  <input type="url" id="featured_image" name="featured_image" class="form-input" placeholder="Or paste image URL" value="<%= article ? article.featured_image : '' %>" style="font-size: 13px;">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="text_article"><i class="fas fa-file-alt"></i> Text Article</label>
              <textarea id="text_article" name="text_article" class="form-input" rows="15" placeholder="Enter the main article text content here"><%= article ? article.text_article : '' %></textarea>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                <p class="form-help" style="margin: 0;">The main text content of your article.</p>
                <span id="liveWordCount" class="char-counter" style="font-size: 13px;">0 words</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="content"><i class="fas fa-file-code"></i> Sidemenu Content *</label>
              <textarea id="content" name="content" class="form-input" rows="15" required placeholder="Enter full HTML for the sidebar panel. Use standard HTML: &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;a&gt; tags. This appears in the slide-in panel when readers click 'Read More' on the article card."><%= article ? article.content : '' %></textarea>
              <p class="form-help">Full HTML content for the slide-in sidebar panel. This is the rich preview shown when a reader clicks on the article card from the listing page. Use standard HTML markup â€” headings, paragraphs, lists, links. You can use the <strong>Auto-Hyperlink</strong> button below to add internal links automatically.</p>
            </div>

            <!-- Auto-Hyperlink Button -->
            <div class="form-group" style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 14px;">
              <div class="autolink-header">
                <label class="form-label" style="margin-bottom: 0;"><i class="fas fa-link" style="color: var(--primary);"></i> Auto-Hyperlink Content</label>
                <div class="autolink-buttons">
                  <button type="button" id="autoHyperlinkContentBtn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-magic"></i> Auto-Link Sidemenu
                  </button>
                  <button type="button" id="autoHyperlinkTextBtn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-magic"></i> Auto-Link Text Article
                  </button>
                </div>
              </div>
              <p class="form-help" style="margin: 0;">Scans content and auto-creates hyperlinks for glossary terms, SEO terms, and AI tools from your database. First occurrence of each term gets linked.</p>
              <div id="hyperlinkStatus" style="display: none; margin-top: 8px;"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="published_url">Article Published URL</label>
              <input type="url" id="published_url" name="published_url" class="form-input" placeholder="https://example.com/article-slug" value="<%= article ? article.published_url : '' %>">
            </div>

            <div class="form-group">
              <label class="form-label" for="article_code"><i class="fas fa-code"></i> HTML Article Page</label>
              <textarea id="article_code" name="article_code" class="form-input" rows="10" placeholder="Enter the full HTML code for the article page"><%= article ? article.article_code : '' %></textarea>
              <p class="form-help">The actual HTML code of the article page.</p>
            </div>

            <div class="form-group">
              <label class="form-label">Article Images</label>
              <p class="form-help">Add images from the library to this article</p>
              <button type="button" id="addArticleImageBtn" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Article Image
              </button>
              <input type="hidden" id="article_images" name="article_images" value="<%= article && article.article_images ? (typeof article.article_images === 'string' ? article.article_images : JSON.stringify(article.article_images)) : '[]' %>">
              <div id="articleImagesList" class="article-images-list"></div>
            </div>
          </div>

          <!-- Author Settings -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-user-edit"></i> Author</h3>

            <div class="form-group">
              <label class="form-label" for="author_type">Author Type</label>
              <select id="author_type" name="author_type" class="form-input" style="max-width: 300px;">
                <option value="organization" <%= !article || !article.author_type || article.author_type === 'organization' ? 'selected' : '' %>>Organization (Words That Sells)</option>
                <option value="person" <%= article && article.author_type === 'person' ? 'selected' : '' %>>Person</option>
              </select>
              <p class="form-help">Google prefers Person author for E-E-A-T signals. Organization is default.</p>
            </div>

            <div id="personAuthorFields" style="display: <%= article && article.author_type === 'person' ? 'block' : 'none' %>;">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="author_name">Author Name *</label>
                  <input type="text" id="author_name" name="author_name" class="form-input" placeholder="e.g. Laurent Laboise" value="<%= article && article.author_name ? article.author_name : '' %>">
                </div>
                <div class="form-group">
                  <label class="form-label" for="author_job_title">Job Title</label>
                  <input type="text" id="author_job_title" name="author_job_title" class="form-input" placeholder="e.g. Digital Marketing Director" value="<%= article && article.author_job_title ? article.author_job_title : '' %>">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="author_url">Author URL (LinkedIn / Website)</label>
                <input type="url" id="author_url" name="author_url" class="form-input" placeholder="https://www.linkedin.com/in/your-profile" value="<%= article && article.author_url ? article.author_url : '' %>">
                <p class="form-help">Used in schema.org sameAs for author entity linking</p>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-calendar-alt"></i> Article Metadata</h3>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="published_at"><i class="fas fa-calendar"></i> Published Date</label>
                <input type="datetime-local" id="published_at" name="published_at" class="form-input" value="<%= article && article.published_at ? new Date(article.published_at).toISOString().slice(0, 16) : '' %>">
                <p class="form-help">When the article was first published. Auto-set when status changes to Published.</p>
              </div>
              <div class="form-group">
                <label class="form-label" for="updated_at"><i class="fas fa-clock"></i> Updated Date</label>
                <input type="datetime-local" id="updated_at" name="updated_at" class="form-input" value="<%= article && article.updated_at ? new Date(article.updated_at).toISOString().slice(0, 16) : '' %>">
                <p class="form-help">When the article was last updated. Auto-set on save if left empty.</p>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="time_to_read"><i class="fas fa-book-open"></i> Time to Read (minutes)</label>
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <input type="number" id="time_to_read" name="time_to_read" class="form-input" min="1" placeholder="e.g. 5" value="<%= article && article.time_to_read ? article.time_to_read : '' %>" style="flex: 1; min-width: 0;">
                <button type="button" id="calcReadTimeBtn" class="btn btn-secondary btn-sm" title="Auto-calculate from content">
                  <i class="fas fa-calculator"></i> Calculate
                </button>
              </div>
              <p class="form-help">Estimated reading time in minutes. Click Calculate to auto-compute from content word count.</p>
            </div>
          </div>

          </div><!-- /panel-content -->

          <!-- ===== TAB: SEO ===== -->
          <div class="form-tab-panel" id="panel-seo" style="display:none;">
          <div class="form-section">
            <div class="section-header-row">
              <h3 class="form-section-title" style="margin-bottom: 0;"><i class="fas fa-search"></i> SEO Settings</h3>
              <button type="button" class="btn btn-secondary btn-sm" id="aiSuggestSeoBtn">
                <i class="fas fa-robot"></i> AI Suggest SEO
              </button>
            </div>

            <div class="form-group">
              <label class="form-label" for="seo_title">SEO Title</label>
              <input type="text" id="seo_title" name="seo_title" class="form-input" maxlength="70" placeholder="Optimized title for search results (50-60 chars ideal)" value="<%= article ? article.seo_title : '' %>" >
              <div class="char-counter-row">
                <p class="form-help">Appears as the clickable headline in search results</p>
                <span id="seoTitleCount" class="char-counter"></span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="seo_description">SEO Description</label>
              <textarea id="seo_description" name="seo_description" class="form-input" rows="2" maxlength="320" placeholder="Meta description for search results (150-160 chars ideal)" ><%= article ? article.seo_description : '' %></textarea>
              <div class="char-counter-row">
                <p class="form-help">Appears below the title in search results</p>
                <span id="seoDescCount" class="char-counter"></span>
              </div>
            </div>

            <div class="form-group" style="position: relative;">
              <label class="form-label" for="seo_keywords">SEO Keywords</label>
              <input type="text" id="seo_keywords" name="seo_keywords" class="form-input" placeholder="Type to search SEO terms..." value="<%= article && article.seo_keywords ? article.seo_keywords.join(', ') : '' %>" autocomplete="off">
              <div id="seoKeywordsSuggestions" class="keyword-suggestions" style="display:none;"></div>
              <p class="form-help">Select from the SEO terms database or type custom keywords (comma-separated)</p>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="canonical_url"><i class="fas fa-link"></i> Canonical URL</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="url" id="canonical_url" name="canonical_url" class="form-input" placeholder="Auto-generated from slug" value="<%= article && article.canonical_url ? article.canonical_url : '' %>">
                  <button type="button" id="autoCanonicalBtn" class="btn btn-secondary btn-sm" title="Auto-generate from title slug">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
                <p class="form-help">Auto-filled from article slug on save. Click sync to regenerate.</p>
                <div id="canonicalMismatchWarning" style="display: none; margin-top: 6px; padding: 8px 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; font-size: 13px; color: #92400e;">
                  <i class="fas fa-exclamation-triangle"></i> <strong>Mismatch:</strong> Canonical URL slug does not match the article title slug. This may cause SEO issues.
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="robots_meta"><i class="fas fa-robot"></i> Robots Meta</label>
                <select id="robots_meta" name="robots_meta" class="form-input">
                  <option value="index, follow" <%= (!article || !article.robots_meta || article.robots_meta === 'index, follow') ? 'selected' : '' %>>Index, Follow (default)</option>
                  <option value="noindex, follow" <%= (article && article.robots_meta === 'noindex, follow') ? 'selected' : '' %>>No Index, Follow</option>
                  <option value="index, nofollow" <%= (article && article.robots_meta === 'index, nofollow') ? 'selected' : '' %>>Index, No Follow</option>
                  <option value="noindex, nofollow" <%= (article && article.robots_meta === 'noindex, nofollow') ? 'selected' : '' %>>No Index, No Follow</option>
                </select>
                <p class="form-help">Controls how search engines index and follow links</p>
              </div>
            </div>

            <!-- Google SERP Preview -->
            <div class="form-group">
              <label class="form-label"><i class="fab fa-google"></i> Google Search Preview</label>
              <div class="serp-preview" id="serpPreview">
                <div class="serp-url" id="serpUrl">wordsthatsells.website > articles > ...</div>
                <div class="serp-title" id="serpTitle">Article Title</div>
                <div class="serp-description" id="serpDescription">Article description will appear here...</div>
              </div>
            </div>
          </div>

          </div><!-- /panel-seo -->

          <!-- ===== TAB: SOCIAL ===== -->
          <div class="form-tab-panel" id="panel-social" style="display:none;">
          <!-- Social Preview Section -->
          <div class="form-section">
            <div class="section-header-row">
              <h3 class="form-section-title" style="margin-bottom: 0;"><i class="fas fa-share-alt"></i> Social Preview (Open Graph / Twitter Cards)</h3>
              <button type="button" class="btn btn-secondary btn-sm" id="aiSuggestSocialBtn">
                <i class="fas fa-robot"></i> AI Suggest Social
              </button>
            </div>
            <p class="form-help" style="margin-bottom: 16px;">Control how your article appears when shared on social platforms.</p>

            <!-- Social Metadata Completeness Score -->
            <div class="social-score-card" id="socialScoreCard">
              <div class="social-score-header">
                <span class="social-score-label"><i class="fas fa-chart-line"></i> Social Metadata Score</span>
                <span class="social-score-value" id="socialScoreValue">0%</span>
              </div>
              <div class="social-score-bar">
                <div class="social-score-fill" id="socialScoreFill" style="width: 0%;"></div>
              </div>
              <div class="social-score-checklist" id="socialChecklist"></div>
            </div>

            <!-- Auto-populate button -->
            <div class="form-group" style="margin-bottom: 20px;">
              <button type="button" class="btn btn-secondary" id="autoPopulateSocialBtn">
                <i class="fas fa-magic"></i> Auto-fill from Article Data
              </button>
              <p class="form-help" style="margin-top: 4px;">Populates OG & Twitter fields from your article title, excerpt, and featured image</p>
            </div>

            <!-- Platform Tabs -->
            <div class="social-tabs" id="socialTabs">
              <button type="button" class="social-tab active" data-tab="og">
                <i class="fab fa-facebook"></i> OG Fields (Facebook / LinkedIn)
              </button>
              <button type="button" class="social-tab" data-tab="previews">
                <i class="fas fa-eye"></i> Live Previews
              </button>
            </div>

            <!-- Open Graph Tab -->
            <div class="social-tab-content active" id="tab-og">
              <div class="form-group">
                <label class="form-label" for="og_title"><i class="fab fa-facebook-square" style="color: #1877F2;"></i> OG Title</label>
                <input type="text" id="og_title" name="og_title" class="form-input" maxlength="95" placeholder="Title as it appears on Facebook, LinkedIn, WhatsApp, Pinterest (40-60 chars)" value="<%= article && article.og_title ? article.og_title : '' %>" >
                <div class="char-counter-row">
                  <p class="form-help">Best practice: 40-60 characters. Used by Facebook, LinkedIn, WhatsApp, Slack, Discord, Pinterest.</p>
                  <span id="ogTitleCount" class="char-counter"></span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="og_description"><i class="fab fa-facebook-square" style="color: #1877F2;"></i> OG Description</label>
                <textarea id="og_description" name="og_description" class="form-input" rows="2" maxlength="300" placeholder="Description for social sharing (100-200 chars ideal)" ><%= article && article.og_description ? article.og_description : '' %></textarea>
                <div class="char-counter-row">
                  <p class="form-help">Best practice: 100-200 characters. Keep it compelling and actionable.</p>
                  <span id="ogDescCount" class="char-counter"></span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="og_image"><i class="fas fa-image" style="color: #1877F2;"></i> OG Image URL</label>
                <div class="image-url-row">
                  <input type="url" id="og_image" name="og_image" class="form-input" placeholder="https://example.com/image.jpg (1200x630px recommended)" value="<%= article && article.og_image ? article.og_image : '' %>">
                  <button type="button" class="btn btn-secondary" id="openOgImageBtn">
                    <i class="fas fa-photo-video"></i> Library
                  </button>
                </div>
                <p class="form-help">Recommended: 1200x630px (1.91:1 ratio). Min 600x315px. Max 8MB. Formats: JPG, PNG, WebP.</p>
                <div id="ogImagePreview" class="og-image-preview" style="display: none;">
                  <img id="ogImagePreviewImg" src="" alt="OG Image Preview">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="og_type">OG Type</label>
                  <select id="og_type" name="og_type" class="form-input">
                    <option value="article" <%= (!article || !article.og_type || article.og_type === 'article') ? 'selected' : '' %>>Article</option>
                    <option value="website" <%= (article && article.og_type === 'website') ? 'selected' : '' %>>Website</option>
                    <option value="blog" <%= (article && article.og_type === 'blog') ? 'selected' : '' %>>Blog</option>
                    <option value="product" <%= (article && article.og_type === 'product') ? 'selected' : '' %>>Product</option>
                  </select>
                  <p class="form-help">Usually "article" for blog posts</p>
                </div>
              </div>
            </div>

            <!-- Twitter Customize Toggle -->
            <div style="margin: 20px 0; padding: 12px 16px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                <input type="checkbox" id="twitterCustomizeToggle">
                <span>Customize X/Twitter fields separately</span>
              </label>
              <p class="form-help" style="margin: 4px 0 0 26px;">When unchecked, X/Twitter cards automatically use your OG values above.</p>
            </div>

            <!-- Twitter Fields (hidden by default) -->
            <div id="tab-twitter" style="display: none;">
              <div class="form-group">
                <label class="form-label" for="twitter_card"><i class="fab fa-x-twitter"></i> Card Type</label>
                <select id="twitter_card" name="twitter_card" class="form-input">
                  <option value="summary_large_image" <%= (!article || !article.twitter_card || article.twitter_card === 'summary_large_image') ? 'selected' : '' %>>Summary with Large Image (recommended)</option>
                  <option value="summary" <%= (article && article.twitter_card === 'summary') ? 'selected' : '' %>>Summary (small thumbnail)</option>
                </select>
                <p class="form-help">"Summary with Large Image" gets 2x higher engagement on average</p>
              </div>

              <div class="form-group">
                <label class="form-label" for="twitter_title"><i class="fab fa-x-twitter"></i> X Title</label>
                <input type="text" id="twitter_title" name="twitter_title" class="form-input" maxlength="70" placeholder="Title for X/Twitter cards (max 70 chars)" value="<%= article && article.twitter_title ? article.twitter_title : '' %>" >
                <div class="char-counter-row">
                  <p class="form-help">Falls back to OG Title if empty. Max 70 characters.</p>
                  <span id="twitterTitleCount" class="char-counter"></span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="twitter_description"><i class="fab fa-x-twitter"></i> X Description</label>
                <textarea id="twitter_description" name="twitter_description" class="form-input" rows="2" maxlength="200" placeholder="Description for X/Twitter (max 200 chars)" ><%= article && article.twitter_description ? article.twitter_description : '' %></textarea>
                <div class="char-counter-row">
                  <p class="form-help">Falls back to OG Description if empty. Keep it concise.</p>
                  <span id="twitterDescCount" class="char-counter"></span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="twitter_image"><i class="fas fa-image"></i> X Image URL</label>
                <div class="image-url-row">
                  <input type="url" id="twitter_image" name="twitter_image" class="form-input" placeholder="https://example.com/image.jpg (leave empty to use OG image)" value="<%= article && article.twitter_image ? article.twitter_image : '' %>">
                  <button type="button" class="btn btn-secondary" id="openTwitterImageBtn">
                    <i class="fas fa-photo-video"></i> Library
                  </button>
                </div>
                <p class="form-help">Recommended: 1200x675px (16:9) for large image, 144x144px for summary. Falls back to OG Image.</p>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="twitter_site">@Site Handle</label>
                  <input type="text" id="twitter_site" name="twitter_site" class="form-input" placeholder="@wordsthatsells" value="<%= article && article.twitter_site ? article.twitter_site : '' %>">
                  <p class="form-help">Your brand's X handle (e.g. @wordsthatsells)</p>
                </div>
                <div class="form-group">
                  <label class="form-label" for="twitter_creator">@Author Handle</label>
                  <input type="text" id="twitter_creator" name="twitter_creator" class="form-input" placeholder="@authorname" value="<%= article && article.twitter_creator ? article.twitter_creator : '' %>">
                  <p class="form-help">The content creator's X handle (must start with @)</p>
                  <div id="twitterCreatorWarning" style="display: none; margin-top: 4px; font-size: 12px; color: #dc2626;">
                    <i class="fas fa-exclamation-circle"></i> Handle must start with @ (e.g. @wordsthatsells)
                  </div>
                </div>
              </div>
            </div>

            <!-- Live Previews Tab -->
            <div class="social-tab-content" id="tab-previews">
              <div class="preview-grid">
                <!-- Facebook Preview -->
                <div class="preview-card">
                  <div class="preview-card-header">
                    <i class="fab fa-facebook" style="color: #1877F2;"></i> Facebook / Meta Preview
                  </div>
                  <div class="facebook-preview">
                    <div class="fb-preview-image" id="fbPreviewImage">
                      <i class="fas fa-image"></i>
                      <span>1200 x 630px</span>
                    </div>
                    <div class="fb-preview-content">
                      <div class="fb-preview-domain" id="fbPreviewDomain">wordsthatsells.website</div>
                      <div class="fb-preview-title" id="fbPreviewTitle">Your Article Title</div>
                      <div class="fb-preview-desc" id="fbPreviewDesc">Your article description will appear here...</div>
                    </div>
                  </div>
                </div>

                <!-- Twitter Preview -->
                <div class="preview-card">
                  <div class="preview-card-header">
                    <i class="fab fa-x-twitter"></i> X (Twitter) Preview
                  </div>
                  <div class="twitter-preview" id="twitterPreviewCard">
                    <div class="tw-preview-image" id="twPreviewImage">
                      <i class="fas fa-image"></i>
                      <span>1200 x 675px</span>
                    </div>
                    <div class="tw-preview-content">
                      <div class="tw-preview-title" id="twPreviewTitle">Your Article Title</div>
                      <div class="tw-preview-desc" id="twPreviewDesc">Your article description will appear here...</div>
                      <div class="tw-preview-domain" id="twPreviewDomain"><i class="fas fa-link"></i> wordsthatsells.website</div>
                    </div>
                  </div>
                </div>

                <!-- LinkedIn Preview -->
                <div class="preview-card">
                  <div class="preview-card-header">
                    <i class="fab fa-linkedin" style="color: #0A66C2;"></i> LinkedIn Preview
                  </div>
                  <div class="linkedin-preview">
                    <div class="li-preview-image" id="liPreviewImage">
                      <i class="fas fa-image"></i>
                      <span>1200 x 627px</span>
                    </div>
                    <div class="li-preview-content">
                      <div class="li-preview-title" id="liPreviewTitle">Your Article Title</div>
                      <div class="li-preview-domain" id="liPreviewDomain">wordsthatsells.website</div>
                    </div>
                  </div>
                </div>

                <!-- WhatsApp Preview -->
                <div class="preview-card">
                  <div class="preview-card-header">
                    <i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp / Slack / Discord Preview
                  </div>
                  <div class="whatsapp-preview">
                    <div class="wa-preview-bar"></div>
                    <div class="wa-preview-body">
                      <div class="wa-preview-image" id="waPreviewImage">
                        <i class="fas fa-image"></i>
                      </div>
                      <div class="wa-preview-title" id="waPreviewTitle">Your Article Title</div>
                      <div class="wa-preview-desc" id="waPreviewDesc">Your article description...</div>
                      <div class="wa-preview-domain" id="waPreviewDomain">wordsthatsells.website</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          </div><!-- /panel-social -->

          <!-- ===== TAB: ADVANCED ===== -->
          <div class="form-tab-panel" id="panel-advanced" style="display:none;">

          <!-- Article Audio Section -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-headphones"></i> Article Audio (Listen to this Article)</h3>
            <p class="form-help" style="margin-bottom: 12px;">Enable multi-language audio playback. The audio widget appears beneath the article title on the published page.</p>

            <input type="hidden" id="audio_files" name="audio_files" value="<%= article && article.audio_files ? (typeof article.audio_files === 'string' ? article.audio_files : JSON.stringify(article.audio_files)) : '{}' %>">

            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="audioEnabledToggle" style="width: 18px; height: 18px; cursor: pointer;">
                <span>Enable audio widget for this article</span>
              </label>
            </div>

            <div id="audioFieldsPanel" style="display: none;">
              <div id="audioLangRows"></div>

              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 12px;">
                <select id="audioNewLangSelect" class="form-input" style="max-width: 180px; font-size: 13px;">
                  <option value="">Add language...</option>
                  <option value="en">English</option>
                  <option value="lo">Lao</option>
                  <option value="th">Thai</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="zh">Chinese</option>
                  <option value="ja">Japanese</option>
                  <option value="ko">Korean</option>
                  <option value="vi">Vietnamese</option>
                  <option value="km">Khmer</option>
                  <option value="my">Burmese</option>
                </select>
                <button type="button" id="addAudioLangBtn" class="btn btn-secondary btn-sm">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
              <p class="form-help" style="margin-top: 4px;">Paste the direct URL to each language's MP3/WAV audio file.</p>
            </div>
          </div>

          <!-- Citations / Sources Section -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-quote-right"></i> Citations &amp; Sources</h3>
            <p class="form-help" style="margin-bottom: 12px;">Link to official sources, government sites, and data origins. Improves AI search engine trust (Perplexity, SearchGPT).</p>
            <input type="hidden" id="citations" name="citations" value="<%= article && article.citations ? (typeof article.citations === 'string' ? article.citations : JSON.stringify(article.citations)) : '[]' %>">

            <div id="citationsList" class="citation-list"></div>
            <button type="button" id="addCitationBtn" class="btn btn-secondary" style="margin-top: 8px;">
              <i class="fas fa-plus"></i> Add Citation
            </button>
          </div>

          <!-- Schema.org / Structured Data Section (Accordion) -->
          <div class="form-section">
            <button type="button" class="accordion-header" id="schemaAccordionBtn">
              <span><i class="fas fa-code"></i> Structured Data (Schema.org / JSON-LD)</span>
              <i class="fas fa-chevron-down accordion-arrow"></i>
            </button>
            <p class="form-help" style="margin-bottom: 8px;">Structured data helps search engines and AI systems understand your content.</p>

            <div id="schemaAccordion" class="accordion-body" style="display: none;">
              <div class="form-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button type="button" id="genSchemaBtn" class="btn btn-secondary">
                  <i class="fas fa-cogs"></i> Auto-Generate Schema Markup
                </button>
                <button type="button" id="genOgPreviewBtn" class="btn btn-secondary">
                  <i class="fas fa-share-alt"></i> Preview OG &amp; Meta Tags
                </button>
              </div>

              <div class="form-group">
                <label class="form-label" for="schema_markup">JSON-LD Schema Markup</label>
                <textarea id="schema_markup" name="schema_markup" class="form-input code-textarea" rows="12" placeholder='Click "Auto-Generate" to create schema markup from your article data'><%= article && article.schema_markup ? JSON.stringify(article.schema_markup, null, 2) : '' %></textarea>
                <p class="form-help">This will be embedded as &lt;script type="application/ld+json"&gt; in the article page.</p>
              </div>

              <div id="ogMetaPreviewSection" class="form-group" style="display: none;">
                <label class="form-label">Open Graph &amp; Meta Tags Preview</label>
                <textarea id="og_meta_preview" class="form-input code-textarea" rows="18" readonly></textarea>
                <p class="form-help">Read-only preview of all meta tags. Copy if needed for manual use.</p>
              </div>
            </div>
          </div>

          <!-- Content Labels / Sidebar Card Section -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-id-card"></i> Content Labels (Article Sidebar Card)</h3>
            <p class="form-help" style="margin-bottom: 12px;">Configure the sidebar preview card shown alongside the article. This standardized card helps readers understand the article at a glance.</p>
            <input type="hidden" id="content_labels" name="content_labels" value="<%= article && article.content_labels ? (typeof article.content_labels === 'string' ? article.content_labels : JSON.stringify(article.content_labels)) : '{}' %>">

            <div class="form-group">
              <label class="form-label" for="cl_description"><i class="fas fa-align-left"></i> Card Description</label>
              <textarea id="cl_description" name="cl_description" class="form-input" rows="3" placeholder="A short description that appears on the sidebar card..."></textarea>
              <p class="form-help">Shown at the top of the sidebar card below the title.</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="cl_who_should_read"><i class="fas fa-users"></i> Who Should Read This</label>
              <textarea id="cl_who_should_read" name="cl_who_should_read" class="form-input" rows="4" placeholder="Marketing professionals&#10;Business owners&#10;SEO specialists"></textarea>
              <p class="form-help">One audience type per line. Displayed as a bullet list.</p>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-lightbulb"></i> What You'll Learn (Key Points)</label>
              <p class="form-help" style="margin-bottom: 8px;">Add key points with a bold title and description.</p>
              <div id="keyPointsList" class="key-points-list"></div>
              <button type="button" id="addKeyPointBtn" class="btn btn-secondary" style="margin-top: 8px;">
                <i class="fas fa-plus"></i> Add Key Point
              </button>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-book-open"></i> Sources Referenced</label>
              <p class="form-help" style="margin-bottom: 8px;">Add source badges and links shown on the sidebar card.</p>
              <div id="sidebarSourcesList" class="sidebar-sources-list"></div>
              <button type="button" id="addSidebarSourceBtn" class="btn btn-secondary" style="margin-top: 8px;">
                <i class="fas fa-plus"></i> Add Source
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="cl_faqs_count"><i class="fas fa-question-circle"></i> FAQs Count</label>
                <input type="number" id="cl_faqs_count" name="cl_faqs_count" class="form-input" min="0" placeholder="e.g. 5">
                <p class="form-help">Number of FAQs in the article</p>
              </div>
              <div class="form-group">
                <label class="form-label" for="cl_cta_text"><i class="fas fa-mouse-pointer"></i> CTA Button Text</label>
                <input type="text" id="cl_cta_text" name="cl_cta_text" class="form-input" placeholder="Read Full Article">
                <p class="form-help">Custom text for the call-to-action button (default: "Read Full Article")</p>
              </div>
            </div>
          </div>

          </div><!-- /panel-advanced -->

          <!-- ===== TAB: PUBLISH ===== -->
          <div class="form-tab-panel" id="panel-publish" style="display:none;">

          <!-- SEO Audit Panel -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-clipboard-check"></i> Pre-Publish SEO Audit</h3>
            <p class="form-help" style="margin-bottom: 12px;">Review SEO readiness before publishing. Issues are checked in real-time as you edit.</p>

            <div id="seoAuditPanel" class="seo-audit-panel">
              <div class="seo-audit-header">
                <span class="seo-audit-score" id="seoAuditScore">0/0</span>
                <span class="seo-audit-label">SEO checks passed</span>
                <button type="button" id="refreshAuditBtn" class="btn btn-secondary btn-sm">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
              <div class="seo-audit-bar">
                <div class="seo-audit-fill" id="seoAuditFill" style="width: 0%;"></div>
              </div>
              <div id="seoAuditChecks" class="seo-audit-checks">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>

          <!-- Auto-Hyperlink Section -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-link"></i> Intelligent Hyperlinking</h3>
            <p class="form-help" style="margin-bottom: 12px;">Automatically scan article content and create hyperlinks for glossary terms, SEO terms, and AI tools from your database.</p>

            <div class="publish-hyperlink-controls">
              <div class="hyperlink-button-row">
                <button type="button" id="pubAutoHyperlinkBtn" class="btn btn-primary">
                  <i class="fas fa-magic"></i> Auto-Hyperlink All Content
                </button>
                <button type="button" id="pubPreviewLinksBtn" class="btn btn-secondary">
                  <i class="fas fa-eye"></i> Preview Linked Content
                </button>
                <button type="button" id="pubUndoLinksBtn" class="btn btn-secondary" style="display: none;">
                  <i class="fas fa-undo"></i> Undo Links
                </button>
              </div>

              <div id="pubHyperlinkStats" style="display: none;" class="hyperlink-stats">
                <!-- Stats will be populated by JS -->
              </div>
              <div id="pubHyperlinkStatus" style="display: none;"></div>
            </div>
          </div>

          <!-- Article Preview Section -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-eye"></i> Article Preview</h3>
            <p class="form-help" style="margin-bottom: 12px;">Preview how the article will look when published as a static HTML page on GitHub Pages.</p>

            <div class="preview-button-row">
              <button type="button" id="generatePreviewBtn" class="btn btn-primary">
                <i class="fas fa-eye"></i> Generate Preview
              </button>
              <button type="button" id="openPreviewNewTabBtn" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-external-link-alt"></i> Open in New Tab
              </button>
            </div>

            <div id="articlePreviewContainer" class="article-preview-container" style="display: none;">
              <iframe id="articlePreviewFrame" class="article-preview-frame" sandbox="allow-same-origin"></iframe>
            </div>
          </div>

          <!-- GitHub Publishing Section -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fab fa-github"></i> Publish to GitHub Pages</h3>
            <p class="form-help" style="margin-bottom: 12px;">Generate a static HTML article file and push it to your GitHub repository. The article will be live on GitHub Pages after deployment.</p>

            <!-- GitHub Settings -->
            <div class="github-settings" style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 12px;"><i class="fas fa-cog"></i> GitHub Settings</h4>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="gh_token">Personal Access Token</label>
                  <input type="password" id="gh_token" class="form-input" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
                  <p class="form-help">Stored in browser localStorage. Needs repo write access.</p>
                </div>
                <div class="form-group">
                  <label class="form-label" for="gh_repo">Repository</label>
                  <input type="text" id="gh_repo" class="form-input" value="laurentlaboise/marketing" placeholder="owner/repo">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="gh_branch">Branch</label>
                  <input type="text" id="gh_branch" class="form-input" value="main" placeholder="main">
                </div>
                <div class="form-group">
                  <label class="form-label" for="gh_path">File Path</label>
                  <input type="text" id="gh_path" class="form-input" placeholder="en/articles/your-slug.html" readonly>
                  <p class="form-help">Auto-generated from article slug</p>
                </div>
              </div>

              <div class="gh-settings-buttons">
                <button type="button" id="saveGhSettingsBtn" class="btn btn-secondary btn-sm">
                  <i class="fas fa-save"></i> Save Settings
                </button>
                <button type="button" id="testGhConnectionBtn" class="btn btn-secondary btn-sm">
                  <i class="fas fa-plug"></i> Test Connection
                </button>
              </div>
              <div id="ghConnectionStatus" style="display: none; margin-top: 8px;"></div>
            </div>

            <!-- Publish Actions -->
            <div class="publish-actions" style="background: linear-gradient(135deg, #f0f9ff 0%, #e8f5e9 100%); border: 1px solid #c8e6c9; border-radius: 8px; padding: 20px;">
              <div class="deploy-header">
                <div>
                  <h4 style="font-size: 16px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Deploy Article</h4>
                  <p style="font-size: 13px; color: var(--gray-600); margin: 0;">Generate static HTML and push to GitHub Pages</p>
                </div>
                <div>
                  <button type="button" id="publishToGithubBtn" class="btn btn-primary" style="background: #28a745; border-color: #28a745;">
                    <i class="fab fa-github"></i> Publish to GitHub
                  </button>
                </div>
              </div>

              <!-- Progress Indicator -->
              <div id="publishProgress" style="display: none; margin-top: 16px;">
                <div class="publish-progress-bar">
                  <div class="publish-progress-fill" id="publishProgressFill"></div>
                </div>
                <div id="publishProgressText" style="font-size: 13px; color: var(--gray-600); margin-top: 6px;"></div>
              </div>

              <!-- Result -->
              <div id="publishResult" style="display: none; margin-top: 12px;"></div>
            </div>
          </div>

          </div><!-- /panel-publish -->

          <!-- Bottom save bar (non-sticky fallback) -->
          <div class="form-actions" style="padding: 16px 24px; border-top: 1px solid var(--gray-200);">
            <a href="/content/articles" class="btn btn-secondary" id="cancelBtnBottom">Cancel</a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> <%= article ? 'Update Article' : 'Create Article' %>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<!-- AI Confirmation Modal -->
<div id="aiConfirmModal" class="modal">
  <div class="modal-content" style="max-width: 460px;">
    <div class="modal-header">
      <h2><i class="fas fa-robot"></i> AI Auto-fill</h2>
      <button class="modal-close" id="aiConfirmCloseX">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 12px;">This will use AI to auto-fill the following fields:</p>
      <ul style="font-size: 13px; color: var(--gray-700); margin: 0 0 16px 16px; line-height: 1.8;">
        <li>SEO Title, Description, Keywords</li>
        <li>OG Title & Description</li>
        <li>X/Twitter Title & Description</li>
        <li>Content Labels & Key Points</li>
        <li>Category, Tags, Excerpt (if empty)</li>
      </ul>
      <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;"><strong>Note:</strong> Existing values in SEO, OG, and Twitter fields will be overwritten.</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
        <button type="button" class="btn btn-secondary" id="aiConfirmCancelBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="aiConfirmGoBtn">
          <i class="fas fa-robot"></i> Continue
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Unsaved Changes Modal -->
<div id="unsavedModal" class="modal">
  <div class="modal-content" style="max-width: 420px;">
    <div class="modal-header">
      <h2>Unsaved Changes</h2>
      <button class="modal-close" id="unsavedCloseX">&times;</button>
    </div>
    <div class="modal-body">
      <p>You have unsaved changes that will be lost. Are you sure you want to leave?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; margin-top: 16px;">
        <button type="button" class="btn btn-secondary" id="unsavedStayBtn">Stay</button>
        <button type="button" class="btn btn-danger" id="unsavedLeaveBtn">Leave</button>
      </div>
    </div>
  </div>
</div>

<!-- Image Selector Modal -->
<div id="imageSelectorModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>Select Image from Library</h2>
      <button class="modal-close" id="imageModalCloseX">&times;</button>
    </div>
    <div class="modal-body">
      <div class="image-modal-search">
        <input type="text" id="imageSearchInput" class="form-input" placeholder="Search images...">
        <select id="imageCategoryFilter" class="form-input">
          <option value="">All Categories</option>
          <option value="hero">Hero</option>
          <option value="portfolio">Portfolio</option>
          <option value="logos">Logos</option>
          <option value="articles">Articles</option>
          <option value="og">Open Graph</option>
          <option value="icons">Icons</option>
          <option value="general">General</option>
        </select>
        <button type="button" class="btn btn-secondary" id="imageSearchBtn">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
      <div id="imageGridContainer" class="image-modal-grid">
        <!-- Images will be loaded here -->
      </div>
      <div id="imageModalPagination" style="margin-top: 16px; text-align: center;">
        <!-- Pagination will be loaded here -->
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.6);
}

.modal-content {
  background-color: var(--white);
  margin: 5% auto;
  padding: 0;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  max-width: 600px;
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
  color: var(--gray-900);
}

.modal-close {
  background: none;
  border: none;
  font-size: 28px;
  font-weight: bold;
  color: var(--gray-500);
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  color: var(--gray-900);
}

.modal-body {
  padding: 24px;
}

.article-images-list {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.article-image-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px;
  background: var(--gray-50);
  border-radius: 4px;
  border: 1px solid var(--gray-200);
}

.article-image-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
}

.article-image-info {
  flex: 1;
}

.article-image-info strong {
  display: block;
  color: var(--gray-900);
  font-size: 14px;
}

.article-image-info small {
  color: var(--gray-600);
  font-size: 12px;
}

.image-selector-item {
  cursor: pointer;
  border: 2px solid var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  transition: all 0.2s;
  position: relative;
  padding-bottom: 100%;
}

.image-selector-item img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-selector-item:hover {
  border-color: var(--primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.image-selector-item.selected {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px var(--primary);
}

/* Character counter */
.char-counter-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
}
.char-counter {
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  padding: 2px 8px;
  border-radius: 10px;
}
.char-counter.good { color: #059669; background: #d1fae5; }
.char-counter.warn { color: #d97706; background: #fef3c7; }
.char-counter.over { color: #dc2626; background: #fee2e2; }

/* SEO Audit Panel */
.seo-audit-panel {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  padding: 16px;
}
.seo-audit-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.seo-audit-score {
  font-size: 20px;
  font-weight: 700;
  color: var(--gray-900);
}
.seo-audit-label {
  font-size: 14px;
  color: var(--gray-600);
  flex: 1;
}
.seo-audit-bar {
  height: 8px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 14px;
}
.seo-audit-fill {
  height: 100%;
  border-radius: 4px;
  background: #059669;
  transition: width 0.4s ease, background-color 0.4s ease;
}
.seo-audit-checks {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  font-size: 13px;
}
.seo-audit-check {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  padding: 4px 0;
}
.seo-audit-check .check-icon {
  flex-shrink: 0;
  width: 18px;
  text-align: center;
}
.seo-audit-check.pass .check-icon { color: #059669; }
.seo-audit-check.fail .check-icon { color: #dc2626; }
.seo-audit-check.warn .check-icon { color: #d97706; }
@media (max-width: 640px) {
  .seo-audit-checks { grid-template-columns: 1fr; }
}

/* SERP Preview */
.serp-preview {
  background: #fff;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  padding: 16px;
  max-width: 600px;
  font-family: Arial, sans-serif;
}
.serp-url {
  font-size: 12px;
  color: #202124;
  margin-bottom: 4px;
}
.serp-title {
  font-size: 20px;
  color: #1a0dab;
  line-height: 1.3;
  margin-bottom: 4px;
  cursor: pointer;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.serp-title:hover { text-decoration: underline; }
.serp-description {
  font-size: 14px;
  color: #4d5156;
  line-height: 1.58;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Social tabs */
.social-tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--gray-200);
  margin-bottom: 20px;
}
.social-tab {
  padding: 10px 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-600);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.social-tab:hover { color: var(--gray-900); background: var(--gray-50); }
.social-tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}
.social-tab-content { display: none; }
.social-tab-content.active { display: block; }

/* Social score card */
.social-score-card {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}
.social-score-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.social-score-label {
  font-weight: 600;
  font-size: 14px;
  color: var(--gray-700);
}
.social-score-value {
  font-weight: 700;
  font-size: 18px;
}
.social-score-bar {
  height: 8px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 12px;
}
.social-score-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease, background-color 0.4s ease;
}
.social-score-checklist {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(220px, 100%), 1fr));
  gap: 4px;
  font-size: 12px;
}
.score-item {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--gray-600);
}
.score-item.done { color: #059669; }
.score-item.missing { color: #dc2626; }

/* OG Image Preview */
.og-image-preview {
  margin-top: 8px;
  border-radius: 4px;
  overflow: hidden;
  max-width: 300px;
}
.og-image-preview img {
  width: 100%;
  height: auto;
  border-radius: 4px;
  border: 1px solid var(--gray-200);
}

/* Preview Grid */
.preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(340px, 100%), 1fr));
  gap: 20px;
}
.preview-card {
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  overflow: hidden;
}
.preview-card-header {
  padding: 10px 14px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
  font-weight: 600;
  font-size: 13px;
  color: var(--gray-700);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Facebook Preview */
.facebook-preview {
  background: #fff;
  border: 1px solid #dadde1;
  margin: 12px;
  border-radius: 0;
}
.fb-preview-image {
  width: 100%;
  height: 170px;
  background: #f0f2f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #65676b;
  font-size: 12px;
  gap: 6px;
  background-size: cover;
  background-position: center;
}
.fb-preview-image i { font-size: 32px; }
.fb-preview-image.has-image { color: transparent; }
.fb-preview-content {
  padding: 10px 12px;
  border-top: 1px solid #dadde1;
  background: #f2f3f5;
}
.fb-preview-domain {
  font-size: 12px;
  color: #606770;
  text-transform: uppercase;
}
.fb-preview-title {
  font-size: 16px;
  font-weight: 600;
  color: #1d2129;
  line-height: 1.38;
  margin: 2px 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.fb-preview-desc {
  font-size: 14px;
  color: #606770;
  line-height: 1.34;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Twitter Preview */
.twitter-preview {
  background: #fff;
  border: 1px solid #cfd9de;
  border-radius: 16px;
  margin: 12px;
  overflow: hidden;
}
.tw-preview-image {
  width: 100%;
  height: 160px;
  background: #eff3f4;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #536471;
  font-size: 12px;
  gap: 6px;
  background-size: cover;
  background-position: center;
}
.tw-preview-image i { font-size: 28px; }
.tw-preview-image.has-image { color: transparent; }
.tw-preview-content {
  padding: 10px 12px;
}
.tw-preview-title {
  font-size: 15px;
  font-weight: 700;
  color: #0f1419;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.tw-preview-desc {
  font-size: 15px;
  color: #536471;
  line-height: 1.3;
  margin: 2px 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.tw-preview-domain {
  font-size: 15px;
  color: #536471;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* LinkedIn Preview */
.linkedin-preview {
  background: #fff;
  border: 1px solid #e0e0e0;
  margin: 12px;
}
.li-preview-image {
  width: 100%;
  height: 160px;
  background: #f3f2ef;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #666;
  font-size: 12px;
  gap: 6px;
  background-size: cover;
  background-position: center;
}
.li-preview-image i { font-size: 28px; }
.li-preview-image.has-image { color: transparent; }
.li-preview-content {
  padding: 10px 12px;
  background: #f9fafb;
  border-top: 1px solid #e0e0e0;
}
.li-preview-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(0,0,0,0.9);
  line-height: 1.42;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.li-preview-domain {
  font-size: 12px;
  color: rgba(0,0,0,0.6);
}

/* WhatsApp Preview */
.whatsapp-preview {
  background: #e5ddd5;
  padding: 12px;
  margin: 12px;
  border-radius: 8px;
}
.wa-preview-body {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  border-left: 4px solid #25D366;
}
.wa-preview-bar { display: none; }
.wa-preview-image {
  width: 100%;
  height: 120px;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  background-size: cover;
  background-position: center;
}
.wa-preview-image i { font-size: 24px; }
.wa-preview-image.has-image { color: transparent; }
.wa-preview-title {
  padding: 8px 10px 2px;
  font-size: 13px;
  font-weight: 600;
  color: #1d1d1d;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.wa-preview-desc {
  padding: 0 10px;
  font-size: 12px;
  color: #8c8c8c;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.wa-preview-domain {
  padding: 2px 10px 8px;
  font-size: 11px;
  color: #8c8c8c;
}

/* Code textarea for JSON-LD and meta previews */
.code-textarea {
  font-family: 'Courier New', Courier, monospace;
  font-size: 13px;
  line-height: 1.5;
  background: #1e1e1e;
  color: #d4d4d4;
  border: 1px solid #3c3c3c;
  border-radius: 4px;
  padding: 12px;
}
.code-textarea::placeholder {
  color: #6a6a6a;
}

/* Keyword autocomplete suggestions */
.keyword-suggestions {
  position: absolute;
  z-index: 100;
  background: var(--white);
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  max-height: 200px;
  overflow-y: auto;
  width: 100%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.keyword-suggestion-item {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.keyword-suggestion-item:hover {
  background: var(--primary);
  color: #fff;
}
.keyword-suggestion-item .category-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 3px;
  background: var(--gray-100);
  color: var(--gray-600);
}
.keyword-suggestion-item:hover .category-badge {
  background: rgba(255,255,255,0.2);
  color: #fff;
}

/* Key points list */
.key-points-list { margin-top: 8px; }
.key-point-item {
  display: flex;
  gap: 8px;
  margin-bottom: 6px;
  align-items: flex-start;
}
.key-point-item input { flex: 0.35; }
.key-point-item textarea { flex: 0.65; min-height: 36px; }

/* Sidebar sources list */
.sidebar-sources-list { margin-top: 8px; }
.sidebar-source-item {
  display: flex;
  gap: 8px;
  margin-bottom: 6px;
  align-items: center;
}
.sidebar-source-item input { flex: 1; }

/* Citations list */
.citation-list { margin-top: 8px; }
.citation-item {
  display: flex;
  gap: 8px;
  margin-bottom: 6px;
  align-items: center;
}
.citation-item input {
  flex: 1;
}
.citation-item .btn-remove {
  padding: 4px 8px;
  background: #dc3545;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}
.citation-item .btn-remove:hover {
  background: #c82333;
}

/* ===== STICKY ACTION BAR ===== */
.sticky-action-bar {
  position: sticky;
  top: 0;
  z-index: 90;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 24px;
  background: #fff;
  border-bottom: 1px solid var(--gray-200);
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.sticky-bar-left, .sticky-bar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.unsaved-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #d97706;
  font-weight: 600;
}
.unsaved-badge i { font-size: 8px; }

/* ===== COMPLETION INDICATOR ===== */
.completion-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
}
.completion-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--gray-300);
  transition: background 0.3s;
}
.completion-dot.partial { background: #f59e0b; }
.completion-dot.complete { background: #10b981; }
.completion-text {
  font-size: 12px;
  color: var(--gray-500);
  font-weight: 500;
}

/* ===== ORGANIZATION STRIP ===== */
.org-strip {
  display: flex;
  gap: 16px;
  align-items: flex-end;
  padding: 12px 24px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
  flex-wrap: wrap;
}
.org-strip-field { display: flex; flex-direction: column; gap: 4px; }
.org-strip-label { font-size: 11px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
.org-strip-select {
  padding: 6px 10px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 13px;
  background: #fff;
  color: var(--gray-800);
}
.org-strip-checkbox {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  padding: 6px 0;
}

/* ===== FORM TABS ===== */
.form-tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--gray-200);
  padding: 0 24px;
  background: #fff;
}
.form-tab {
  padding: 12px 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-500);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.form-tab:hover { color: var(--gray-800); background: var(--gray-50); }
.form-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.form-tab-panel { display: none; padding: 24px; }
.form-tab-panel.active { display: block; }

/* ===== FEATURED IMAGE PICKER ===== */
.featured-image-picker {
  border: 1px dashed var(--gray-300);
  border-radius: 8px;
  padding: 12px;
  background: var(--gray-50);
}
.featured-image-preview {
  position: relative;
  display: inline-block;
  max-width: 280px;
  margin-bottom: 4px;
}
.featured-image-preview img {
  width: 100%;
  height: auto;
  border-radius: 6px;
  border: 1px solid var(--gray-200);
}
.featured-image-remove {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.featured-image-empty {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--gray-400);
  font-size: 14px;
  padding: 12px 0;
}
.featured-image-empty i { font-size: 24px; }

/* ===== ACCORDION ===== */
.accordion-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 12px 0;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-800);
}
.accordion-header:hover { color: var(--primary); }
.accordion-arrow { transition: transform 0.2s; font-size: 14px; color: var(--gray-500); }
.accordion-header.open .accordion-arrow { transform: rotate(180deg); }
.accordion-body { padding-top: 8px; }

/* ===== BTN DANGER ===== */
.btn-danger {
  background: #dc3545;
  color: #fff;
  border: 1px solid #dc3545;
}
.btn-danger:hover { background: #c82333; }

/* ===== PUBLISH TAB STYLES ===== */
.hyperlink-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(160px, 100%), 1fr));
  gap: 8px;
  padding: 12px;
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
}
.hyperlink-stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--gray-700);
}
.hyperlink-stat-item i {
  width: 20px;
  text-align: center;
  color: var(--primary);
}
.hyperlink-stat-item .stat-count {
  font-weight: 700;
  color: var(--gray-900);
}

.article-preview-container {
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  overflow: hidden;
  background: #fff;
}
.article-preview-frame {
  width: 100%;
  height: 600px;
  border: none;
}

.publish-progress-bar {
  height: 8px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
}
.publish-progress-fill {
  height: 100%;
  border-radius: 4px;
  background: #28a745;
  transition: width 0.4s ease;
  width: 0%;
}

/* ===== RESPONSIVE UTILITY CLASSES (article form) ===== */
.autolink-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.autolink-buttons {
  display: flex;
  gap: 8px;
}
.section-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.image-url-row {
  display: flex;
  gap: 8px;
}
.image-url-row .form-input {
  flex: 1;
}
.image-modal-search {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
.image-modal-search .form-input:first-child {
  flex: 1;
}
.image-modal-search select.form-input {
  width: 150px;
}
.image-modal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(150px, 100%), 1fr));
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
}
.deploy-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.gh-settings-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.hyperlink-button-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.preview-button-row {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

/* ===== ARTICLE FORM RESPONSIVE ===== */
@media (max-width: 768px) {
  .autolink-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .autolink-buttons {
    flex-wrap: wrap;
  }
  .section-header-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .image-url-row {
    flex-direction: column;
  }
  .image-url-row .form-input {
    flex: unset;
    width: 100%;
  }
  .image-modal-search {
    flex-wrap: wrap;
  }
  .image-modal-search .form-input:first-child {
    flex: 1 1 100%;
  }
  .image-modal-search select.form-input {
    width: 100%;
    flex: 1;
  }
  .image-modal-grid {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    max-height: 300px;
  }
  .deploy-header {
    flex-direction: column;
    align-items: stretch;
  }
}

@media (max-width: 480px) {
  .autolink-buttons {
    flex-direction: column;
    width: 100%;
  }
  .autolink-buttons .btn {
    width: 100%;
    justify-content: center;
  }
  .hyperlink-button-row {
    flex-direction: column;
  }
  .hyperlink-button-row .btn {
    width: 100%;
    justify-content: center;
  }
  .preview-button-row {
    flex-direction: column;
  }
  .preview-button-row .btn {
    width: 100%;
    justify-content: center;
  }
}
</style>

<script>
let currentPage = 1;
let articleImages = [];

// Initialize article images from hidden field
document.addEventListener('DOMContentLoaded', function() {
  try {
    const articleImagesValue = document.getElementById('article_images').value;
    articleImages = articleImagesValue ? JSON.parse(articleImagesValue) : [];
    renderArticleImages();
  } catch (e) {
    console.error('Error parsing article images:', e);
    articleImages = [];
  }
});

function openImageSelector() {
  document.getElementById('imageSelectorModal').style.display = 'block';
  loadImages(1);
}

function closeImageSelector() {
  document.getElementById('imageSelectorModal').style.display = 'none';
}

function searchImages() {
  currentPage = 1;
  loadImages(currentPage);
}

async function loadImages(page) {
  const search = document.getElementById('imageSearchInput').value;
  const category = document.getElementById('imageCategoryFilter').value;
  const url = `/images/api/list?page=${page}&search=${encodeURIComponent(search)}&category=${encodeURIComponent(category)}`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    const container = document.getElementById('imageGridContainer');
    container.innerHTML = '';
    
    if (data.images && data.images.length > 0) {
      data.images.forEach(image => {
        const div = document.createElement('div');
        div.className = 'image-selector-item';
        div.onclick = () => selectImage(image);
        
        const img = document.createElement('img');
        img.src = image.cdn_url || '/images-serve/' + encodeURIComponent(image.filename);
        img.alt = image.alt_text || image.filename;
        img.loading = 'lazy';
        
        div.appendChild(img);
        container.appendChild(div);
      });
      
      // Render pagination
      renderPagination(data.pagination);
    } else {
      container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--gray-500);">No images found</p>';
    }
  } catch (error) {
    console.error('Error loading images:', error);
    document.getElementById('imageGridContainer').innerHTML = '<p style="color: var(--danger);">Error loading images</p>';
  }
}

function renderPagination(pagination) {
  var container = document.getElementById('imageModalPagination');
  if (pagination.totalPages <= 1) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = '';
  var wrapper = document.createElement('div');
  wrapper.style.display = 'flex';
  wrapper.style.gap = '4px';
  wrapper.style.justifyContent = 'center';

  function makePageBtn(page, label, isPrimary, isIcon) {
    var btn = document.createElement('button');
    btn.className = 'btn btn-sm ' + (isPrimary ? 'btn-primary' : 'btn-secondary');
    if (isIcon) {
      var icon = document.createElement('i');
      icon.className = 'fas ' + label;
      btn.appendChild(icon);
    } else {
      btn.textContent = label;
    }
    if (!isPrimary) {
      btn.addEventListener('click', (function(p) { return function() { loadImages(p); }; })(page));
    }
    return btn;
  }

  if (pagination.page > 1) {
    wrapper.appendChild(makePageBtn(pagination.page - 1, 'fa-chevron-left', false, true));
  }

  for (var i = 1; i <= pagination.totalPages; i++) {
    if (i === pagination.page) {
      wrapper.appendChild(makePageBtn(i, String(i), true, false));
    } else if (i === 1 || i === pagination.totalPages || (i >= pagination.page - 1 && i <= pagination.page + 1)) {
      wrapper.appendChild(makePageBtn(i, String(i), false, false));
    } else if (i === pagination.page - 2 || i === pagination.page + 2) {
      var dots = document.createElement('span');
      dots.style.padding = '0 4px';
      dots.textContent = '...';
      wrapper.appendChild(dots);
    }
  }

  if (pagination.page < pagination.totalPages) {
    wrapper.appendChild(makePageBtn(pagination.page + 1, 'fa-chevron-right', false, true));
  }

  container.appendChild(wrapper);
}

function selectImage(image) {
  // Check if image is already added
  const exists = articleImages.some(img => img.id === image.id);
  if (exists) {
    alert('This image is already added to the article');
    return;
  }
  
  articleImages.push({
    id: image.id,
    cdn_url: image.cdn_url,
    filename: image.filename,
    alt_text: image.alt_text || '',
    title: image.title || '',
    width: image.width || null,
    height: image.height || null
  });
  
  updateArticleImagesField();
  renderArticleImages();
  closeImageSelector();
}

function removeArticleImage(index) {
  if (confirm('Remove this image from the article?')) {
    articleImages.splice(index, 1);
    updateArticleImagesField();
    renderArticleImages();
  }
}

function updateArticleImagesField() {
  document.getElementById('article_images').value = JSON.stringify(articleImages);
}

function renderArticleImages() {
  const container = document.getElementById('articleImagesList');

  // Clear existing content
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }

  if (articleImages.length === 0) {
    const p = document.createElement('p');
    p.textContent = 'No images added yet';
    p.style.color = 'var(--gray-500)';
    p.style.fontSize = '14px';
    p.style.marginTop = '8px';
    container.appendChild(p);
    return;
  }

  articleImages.forEach((image, index) => {
    const item = document.createElement('div');
    item.className = 'article-image-item';

    const img = document.createElement('img');
    if (image.cdn_url) {
      img.setAttribute('src', image.cdn_url);
    }
    const altText = image.alt_text || image.filename || '';
    img.setAttribute('alt', altText);
    item.appendChild(img);

    const info = document.createElement('div');
    info.className = 'article-image-info';

    const strong = document.createElement('strong');
    strong.textContent = image.filename || '';
    info.appendChild(strong);

    const small = document.createElement('small');
    small.textContent = 'ID: ' + (image.id != null ? image.id : '');
    info.appendChild(small);

    item.appendChild(info);

    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-sm btn-danger';
    button.title = 'Remove';
    button.addEventListener('click', function() {
      removeArticleImage(index);
    });

    const icon = document.createElement('i');
    icon.className = 'fas fa-trash';
    button.appendChild(icon);

    item.appendChild(button);

    container.appendChild(item);
  });
}

// Button event listener
document.getElementById('addArticleImageBtn').addEventListener('click', openImageSelector);

// Close modal on outside click
window.addEventListener('click', function(event) {
  const modal = document.getElementById('imageSelectorModal');
  if (event.target === modal) {
    closeImageSelector();
  }
});

// ==================== Character Counter ====================
function updateCharCount(input, counterId, optimal) {
  const counter = document.getElementById(counterId);
  if (!counter) return;
  const len = input.value.length;
  const max = parseInt(input.getAttribute('maxlength')) || optimal * 1.5;
  counter.textContent = len + ' / ' + optimal;

  counter.className = 'char-counter';
  if (len === 0) {
    counter.textContent = '0 / ' + optimal;
    counter.classList.add('warn');
  } else if (len <= optimal) {
    counter.classList.add('good');
  } else if (len <= max) {
    counter.classList.add('warn');
  } else {
    counter.classList.add('over');
  }
}

// ==================== SERP Preview ====================
function updateSerpPreview() {
  var title = document.getElementById('seo_title').value || document.getElementById('title').value || 'Article Title';
  var desc = document.getElementById('seo_description').value || document.getElementById('excerpt').value || 'Article description will appear here...';
  var url = document.getElementById('published_url').value || document.getElementById('canonical_url').value || 'wordsthatsells.website/articles/...';

  var serpTitle = document.getElementById('serpTitle');
  var serpDesc = document.getElementById('serpDescription');
  var serpUrl = document.getElementById('serpUrl');

  if (serpTitle) serpTitle.textContent = title.substring(0, 70);
  if (serpDesc) serpDesc.textContent = desc.substring(0, 160);
  if (serpUrl) {
    try {
      var parsed = new URL(url);
      serpUrl.textContent = parsed.hostname + ' > ' + parsed.pathname.split('/').filter(Boolean).join(' > ');
    } catch(e) {
      serpUrl.textContent = 'wordsthatsells.website > articles > ...';
    }
  }
}

// ==================== Social Tabs ====================
function switchSocialTab(tabName) {
  // Deactivate all tabs and content
  var tabs = document.querySelectorAll('.social-tab');
  var contents = document.querySelectorAll('.social-tab-content');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove('active');
  }
  for (var i = 0; i < contents.length; i++) {
    contents[i].classList.remove('active');
  }

  // Activate clicked tab
  var clickedTab = document.querySelector('.social-tab[data-tab="' + tabName + '"]');
  var tabContent = document.getElementById('tab-' + tabName);
  if (clickedTab) clickedTab.classList.add('active');
  if (tabContent) tabContent.classList.add('active');

  // Update previews when switching to previews tab
  if (tabName === 'previews') {
    updateSocialPreviews();
  }
}

// ==================== Social Previews ====================
function updateSocialPreviews() {
  var articleTitle = document.getElementById('title').value || 'Your Article Title';
  var articleExcerpt = document.getElementById('excerpt').value || '';
  var articleImage = document.getElementById('featured_image').value || '';

  var ogTitle = document.getElementById('og_title').value || articleTitle;
  var ogDesc = document.getElementById('og_description').value || articleExcerpt || 'Your article description will appear here...';
  var ogImage = document.getElementById('og_image').value || articleImage;
  var twitterTitle = document.getElementById('twitter_title').value || ogTitle;
  var twitterDesc = document.getElementById('twitter_description').value || ogDesc;
  var twitterImage = document.getElementById('twitter_image').value || ogImage;

  // Facebook preview
  var fbTitle = document.getElementById('fbPreviewTitle');
  var fbDesc = document.getElementById('fbPreviewDesc');
  var fbImage = document.getElementById('fbPreviewImage');
  if (fbTitle) fbTitle.textContent = ogTitle.substring(0, 60);
  if (fbDesc) fbDesc.textContent = ogDesc.substring(0, 200);
  if (fbImage) {
    if (ogImage) {
      fbImage.style.backgroundImage = 'url(' + ogImage + ')';
      fbImage.className = 'fb-preview-image has-image';
    } else {
      fbImage.style.backgroundImage = '';
      fbImage.className = 'fb-preview-image';
    }
  }

  // Twitter preview
  var twTitle = document.getElementById('twPreviewTitle');
  var twDesc = document.getElementById('twPreviewDesc');
  var twImage = document.getElementById('twPreviewImage');
  var twDomain = document.getElementById('twPreviewDomain');
  if (twTitle) twTitle.textContent = twitterTitle.substring(0, 70);
  if (twDesc) twDesc.textContent = twitterDesc.substring(0, 200);
  if (twImage) {
    if (twitterImage) {
      twImage.style.backgroundImage = 'url(' + twitterImage + ')';
      twImage.className = 'tw-preview-image has-image';
    } else {
      twImage.style.backgroundImage = '';
      twImage.className = 'tw-preview-image';
    }
  }
  var twitterSite = document.getElementById('twitter_site').value;
  if (twDomain && twitterSite) {
    twDomain.innerHTML = '<i class="fas fa-link"></i> wordsthatsells.website';
  }

  // LinkedIn preview (uses OG tags)
  var liTitle = document.getElementById('liPreviewTitle');
  var liImage = document.getElementById('liPreviewImage');
  if (liTitle) liTitle.textContent = ogTitle.substring(0, 60);
  if (liImage) {
    if (ogImage) {
      liImage.style.backgroundImage = 'url(' + ogImage + ')';
      liImage.className = 'li-preview-image has-image';
    } else {
      liImage.style.backgroundImage = '';
      liImage.className = 'li-preview-image';
    }
  }

  // WhatsApp preview (uses OG tags)
  var waTitle = document.getElementById('waPreviewTitle');
  var waDesc = document.getElementById('waPreviewDesc');
  var waImage = document.getElementById('waPreviewImage');
  if (waTitle) waTitle.textContent = ogTitle.substring(0, 60);
  if (waDesc) waDesc.textContent = ogDesc.substring(0, 100);
  if (waImage) {
    if (ogImage) {
      waImage.style.backgroundImage = 'url(' + ogImage + ')';
      waImage.className = 'wa-preview-image has-image';
    } else {
      waImage.style.backgroundImage = '';
      waImage.className = 'wa-preview-image';
    }
  }

  // OG image preview thumbnail
  var ogImagePreview = document.getElementById('ogImagePreview');
  var ogImagePreviewImg = document.getElementById('ogImagePreviewImg');
  if (ogImagePreview && ogImagePreviewImg) {
    if (document.getElementById('og_image').value) {
      ogImagePreviewImg.src = document.getElementById('og_image').value;
      ogImagePreview.style.display = 'block';
    } else {
      ogImagePreview.style.display = 'none';
    }
  }

  // Update SERP preview too
  updateSerpPreview();
}

// ==================== Social Score ====================
function updateSocialScore() {
  var checks = [
    { id: 'og_title', label: 'OG Title', done: false },
    { id: 'og_description', label: 'OG Description', done: false },
    { id: 'og_image', label: 'OG Image', done: false },
    { id: 'twitter_card', label: 'Twitter Card Type', done: false },
    { id: 'twitter_title', label: 'X Title (or OG fallback)', done: false },
    { id: 'twitter_description', label: 'X Description (or OG fallback)', done: false },
    { id: 'twitter_image', label: 'X Image (or OG fallback)', done: false },
    { id: 'twitter_site', label: 'X @Site Handle', done: false },
    { id: 'seo_title', label: 'SEO Title', done: false },
    { id: 'seo_description', label: 'SEO Description', done: false }
  ];

  var filled = 0;
  for (var i = 0; i < checks.length; i++) {
    var el = document.getElementById(checks[i].id);
    if (el && el.value && el.value.trim()) {
      checks[i].done = true;
      filled++;
    } else if (checks[i].id === 'twitter_title' && document.getElementById('og_title').value.trim()) {
      checks[i].done = true;
      filled++;
    } else if (checks[i].id === 'twitter_description' && document.getElementById('og_description').value.trim()) {
      checks[i].done = true;
      filled++;
    } else if (checks[i].id === 'twitter_image' && document.getElementById('og_image').value.trim()) {
      checks[i].done = true;
      filled++;
    }
  }

  var score = Math.round((filled / checks.length) * 100);
  var scoreValue = document.getElementById('socialScoreValue');
  var scoreFill = document.getElementById('socialScoreFill');
  var checklist = document.getElementById('socialChecklist');

  if (scoreValue) {
    scoreValue.textContent = score + '%';
    if (score >= 80) { scoreValue.style.color = '#059669'; }
    else if (score >= 50) { scoreValue.style.color = '#d97706'; }
    else { scoreValue.style.color = '#dc2626'; }
  }

  if (scoreFill) {
    scoreFill.style.width = score + '%';
    if (score >= 80) { scoreFill.style.backgroundColor = '#059669'; }
    else if (score >= 50) { scoreFill.style.backgroundColor = '#d97706'; }
    else { scoreFill.style.backgroundColor = '#dc2626'; }
  }

  if (checklist) {
    var html = '';
    for (var j = 0; j < checks.length; j++) {
      var cls = checks[j].done ? 'score-item done' : 'score-item missing';
      var icon = checks[j].done ? 'fa-check-circle' : 'fa-times-circle';
      html += '<div class="' + cls + '"><i class="fas ' + icon + '"></i> ' + checks[j].label + '</div>';
    }
    checklist.innerHTML = html;
  }
}

// ==================== Auto-populate Social Fields ====================
function autoPopulateSocial() {
  var title = document.getElementById('title').value || '';
  var excerpt = document.getElementById('excerpt').value || '';
  var image = document.getElementById('featured_image').value || '';
  var seoTitle = document.getElementById('seo_title').value || '';
  var seoDesc = document.getElementById('seo_description').value || '';

  // Use SEO title if available, otherwise article title
  var socialTitle = seoTitle || title;
  var socialDesc = seoDesc || excerpt;

  // Populate OG fields
  if (!document.getElementById('og_title').value) {
    document.getElementById('og_title').value = socialTitle.substring(0, 90);
    updateCharCount(document.getElementById('og_title'), 'ogTitleCount', 60);
  }
  if (!document.getElementById('og_description').value) {
    document.getElementById('og_description').value = socialDesc.substring(0, 200);
    updateCharCount(document.getElementById('og_description'), 'ogDescCount', 200);
  }
  if (!document.getElementById('og_image').value && image) {
    document.getElementById('og_image').value = image;
  }

  // Populate Twitter fields (can be customized separately)
  if (!document.getElementById('twitter_title').value) {
    document.getElementById('twitter_title').value = socialTitle.substring(0, 70);
    updateCharCount(document.getElementById('twitter_title'), 'twitterTitleCount', 70);
  }
  if (!document.getElementById('twitter_description').value) {
    document.getElementById('twitter_description').value = socialDesc.substring(0, 200);
    updateCharCount(document.getElementById('twitter_description'), 'twitterDescCount', 200);
  }
  if (!document.getElementById('twitter_image').value && image) {
    document.getElementById('twitter_image').value = image;
  }

  updateSocialPreviews();
  updateSocialScore();
}

// ==================== Citations Management ====================
var citationsData = [];

document.addEventListener('DOMContentLoaded', function() {
  try {
    var citVal = document.getElementById('citations').value;
    citationsData = citVal ? JSON.parse(citVal) : [];
  } catch(e) { citationsData = []; }
  renderCitations();
});

function addCitation() {
  citationsData.push({ name: '', url: '' });
  updateCitationsField();
  renderCitations();
}

function removeCitation(index) {
  citationsData.splice(index, 1);
  updateCitationsField();
  renderCitations();
}

function updateCitationField(index, field, value) {
  citationsData[index][field] = value;
  updateCitationsField();
}

function updateCitationsField() {
  document.getElementById('citations').value = JSON.stringify(citationsData);
}

function renderCitations() {
  var container = document.getElementById('citationsList');
  container.innerHTML = '';
  if (citationsData.length === 0) {
    container.innerHTML = '<p style="color: var(--gray-500); font-size: 14px; margin: 4px 0;">No citations added yet</p>';
    return;
  }
  citationsData.forEach(function(cit, i) {
    var div = document.createElement('div');
    div.className = 'citation-item';

    var nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'form-input';
    nameInput.placeholder = 'Source name (e.g. AI Basic Act)';
    nameInput.value = cit.name || '';
    nameInput.style.flex = '0.4';
    nameInput.addEventListener('input', (function(idx) { return function() { updateCitationField(idx, 'name', this.value); }; })(i));

    var urlInput = document.createElement('input');
    urlInput.type = 'url';
    urlInput.className = 'form-input';
    urlInput.placeholder = 'https://official-source-url.com';
    urlInput.value = cit.url || '';
    urlInput.style.flex = '0.6';
    urlInput.addEventListener('input', (function(idx) { return function() { updateCitationField(idx, 'url', this.value); }; })(i));

    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-remove';
    var removeIcon = document.createElement('i');
    removeIcon.className = 'fas fa-times';
    removeBtn.appendChild(removeIcon);
    removeBtn.addEventListener('click', (function(idx) { return function() { removeCitation(idx); }; })(i));

    div.appendChild(nameInput);
    div.appendChild(urlInput);
    div.appendChild(removeBtn);
    container.appendChild(div);
  });
}

// ==================== SEO Keywords Autocomplete ====================
var seoTermsCache = null;

function loadSeoTerms(callback) {
  if (seoTermsCache) return callback(seoTermsCache);
  fetch('/content/seo-terms/api/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      seoTermsCache = data.terms || [];
      callback(seoTermsCache);
    })
    .catch(function() { callback([]); });
}

document.addEventListener('DOMContentLoaded', function() {
  var input = document.getElementById('seo_keywords');
  var dropdown = document.getElementById('seoKeywordsSuggestions');

  input.addEventListener('input', function() {
    var val = this.value;
    var parts = val.split(',');
    var current = parts[parts.length - 1].trim().toLowerCase();
    if (current.length < 1) { dropdown.style.display = 'none'; return; }

    loadSeoTerms(function(terms) {
      var existing = parts.slice(0, -1).map(function(p) { return p.trim().toLowerCase(); });
      var matches = terms.filter(function(t) {
        return t.term.toLowerCase().indexOf(current) !== -1 && existing.indexOf(t.term.toLowerCase()) === -1;
      }).slice(0, 8);

      if (matches.length === 0) { dropdown.style.display = 'none'; return; }
      dropdown.innerHTML = '';
      matches.forEach(function(t) {
        var item = document.createElement('div');
        item.className = 'keyword-suggestion-item';
        item.innerHTML = '<span>' + t.term + '</span>' + (t.category ? '<span class="category-badge">' + t.category + '</span>' : '');
        item.addEventListener('click', function() {
          parts[parts.length - 1] = ' ' + t.term;
          input.value = parts.join(',') + ', ';
          dropdown.style.display = 'none';
          input.focus();
        });
        dropdown.appendChild(item);
      });
      dropdown.style.display = 'block';
    });
  });

  document.addEventListener('click', function(e) {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });
});

// ==================== Schema.org Markup Generator ====================
var SOCIAL_LINKS = [
  "https://www.linkedin.com/company/wordsthatsells",
  "https://www.instagram.com/wordsthatsells",
  "https://github.com/laurentlaboise"
];

function getArticleSlug(title) {
  return title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

function getArticleImageObjects() {
  var imageObjects = [];
  try {
    var articleImagesJson = document.getElementById('article_images').value;
    if (articleImagesJson) {
      var articleImgs = JSON.parse(articleImagesJson);
      if (Array.isArray(articleImgs)) {
        articleImgs.forEach(function(img, idx) {
          var url = img.cdn_url || img.url || '';
          if (!url) return;
          var obj = {
            "@type": "ImageObject",
            "url": url,
            "name": img.title || img.filename || ''
          };
          if (img.alt_text) obj.caption = img.alt_text;
          if (img.width) obj.width = { "@type": "QuantitativeValue", "value": img.width, "unitCode": "E37" };
          if (img.height) obj.height = { "@type": "QuantitativeValue", "value": img.height, "unitCode": "E37" };
          if (idx === 0) obj.representativeOfPage = true;
          imageObjects.push(obj);
        });
      }
    }
  } catch(e) { /* ignore parse errors */ }
  return imageObjects;
}

function getWordCount() {
  var content = document.getElementById('content').value || '';

  // Strip HTML tags from the content without interpreting it as HTML
  var text = content.replace(/<[^>]*>/g, ' ');

  // Split on whitespace and count non-empty words
  var words = text.split(/\s+/).filter(function(w) { return w.length > 0; });
  return words.length;
}

function getCitations() {
  try {
    var val = document.getElementById('citations').value;
    return val ? JSON.parse(val) : [];
  } catch(e) { return []; }
}

function generateSchemaMarkup() {
  var title = document.getElementById('title').value || '';
  var excerpt = document.getElementById('excerpt').value || '';
  var seoDesc = document.getElementById('seo_description').value || '';
  var publishedAt = document.getElementById('published_at').value || '';
  var updatedAt = document.getElementById('updated_at').value || '';
  var category = document.getElementById('category').value || '';
  var tags = document.getElementById('tags').value || '';
  var publishedUrl = document.getElementById('published_url').value || document.getElementById('canonical_url').value || '';
  var timeToRead = document.getElementById('time_to_read').value || '';
  var slug = getArticleSlug(title);
  var articleUrl = publishedUrl || ('https://wordsthatsells.website/en/articles/' + slug + '.html');
  var imageObjects = getArticleImageObjects();
  var wordCount = getWordCount();
  var citations = getCitations();

  // Unified image: prefer og_image, then featured_image, then article_images
  var ogImage = document.getElementById('og_image').value || '';
  var featuredImage = document.getElementById('featured_image').value || '';
  var primaryImage = ogImage || featuredImage;

  // Build Article object
  var articleObj = {
    "@type": "Article",
    "@id": articleUrl + '#article',
    "headline": title,
    "description": seoDesc || excerpt
  };

  // Image: use og_image/featured_image as primary, then article_images library
  if (primaryImage) {
    var imgObj = { "@type": "ImageObject", "url": primaryImage, "representativeOfPage": true };
    if (imageObjects.length > 0) {
      articleObj.image = [imgObj].concat(imageObjects);
    } else {
      articleObj.image = [imgObj];
    }
  } else if (imageObjects.length > 0) {
    articleObj.image = imageObjects;
  }

  if (publishedAt) articleObj.datePublished = new Date(publishedAt).toISOString();
  if (updatedAt) articleObj.dateModified = new Date(updatedAt).toISOString();

  // Author: Person or Organization based on selector
  var authorType = document.getElementById('author_type').value || 'organization';
  if (authorType === 'person') {
    var authorName = document.getElementById('author_name').value || '';
    var authorJobTitle = document.getElementById('author_job_title').value || '';
    var authorUrl = document.getElementById('author_url').value || '';
    articleObj.author = { "@type": "Person", "name": authorName || 'Words That Sells' };
    if (authorJobTitle) articleObj.author.jobTitle = authorJobTitle;
    if (authorUrl) articleObj.author.sameAs = [authorUrl];
  } else {
    articleObj.author = {
      "@type": "Organization",
      "name": "Words That Sells",
      "url": "https://wordsthatsells.website",
      "sameAs": SOCIAL_LINKS
    };
  }

  articleObj.publisher = {
    "@type": "Organization",
    "name": "Words That Sells",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wordsthatsells.website/assets/images/logo.png"
    },
    "sameAs": SOCIAL_LINKS
  };

  articleObj.mainEntityOfPage = {
    "@type": "WebPage",
    "@id": articleUrl
  };

  if (category) articleObj.articleSection = category;
  if (timeToRead) articleObj.timeRequired = 'PT' + timeToRead + 'M';
  if (wordCount > 0) articleObj.wordCount = String(wordCount);

  // About with entity linking (from tags) - normalized to human-readable names
  if (tags) {
    var tagArray = tags.split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; });
    if (tagArray.length > 0) {
      articleObj.about = tagArray.map(function(tag) {
        // Normalize: "ai-marketing" â†’ "AI Marketing"
        var normalized = tag.replace(/-/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
        return { "@type": "Thing", "name": normalized };
      });
    }
  }

  // Speakable property (voice assistants: Gemini Live, Siri, Alexa)
  articleObj.speakable = {
    "@type": "SpeakableSpecification",
    "cssSelector": [".article-summary", ".article-key-insights", ".article-header h1", ".article-excerpt"]
  };

  // Citation / sources (entity linking for AI search engines)
  var validCitations = citations.filter(function(c) { return c.url; });
  if (validCitations.length > 0) {
    articleObj.citation = validCitations.map(function(c) {
      var citObj = { "@type": "CreativeWork", "url": c.url };
      if (c.name) citObj.name = c.name;
      return citObj;
    });
  }

  // Build BreadcrumbList
  var breadcrumb = {
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://wordsthatsells.website" },
      { "@type": "ListItem", "position": 2, "name": "Articles", "item": "https://wordsthatsells.website/en/articles/" },
      { "@type": "ListItem", "position": 3, "name": title }
    ]
  };

  // Build @graph wrapper
  var schema = {
    "@context": "https://schema.org",
    "@graph": [articleObj, breadcrumb]
  };

  document.getElementById('schema_markup').value = JSON.stringify(schema, null, 2);
}

// ==================== OG & Meta Tags Preview ====================
function generateOgMetaPreview() {
  var title = document.getElementById('title').value || '';
  var seoTitle = document.getElementById('seo_title').value || '';
  var excerpt = document.getElementById('excerpt').value || '';
  var seoDesc = document.getElementById('seo_description').value || '';
  var ogTitle = document.getElementById('og_title').value || '';
  var ogDesc = document.getElementById('og_description').value || '';
  var ogImage = document.getElementById('og_image').value || '';
  var ogType = document.getElementById('og_type').value || 'article';
  var twCard = document.getElementById('twitter_card').value || 'summary_large_image';
  var twTitle = document.getElementById('twitter_title').value || '';
  var twDesc = document.getElementById('twitter_description').value || '';
  var twImage = document.getElementById('twitter_image').value || '';
  var twSite = document.getElementById('twitter_site').value || '';
  var twCreator = document.getElementById('twitter_creator').value || '';
  var canonical = document.getElementById('canonical_url').value || '';
  var publishedUrl = document.getElementById('published_url').value || '';
  var robotsMeta = document.getElementById('robots_meta').value || 'index, follow';
  var featuredImage = document.getElementById('featured_image').value || '';
  var publishedAt = document.getElementById('published_at').value || '';
  var updatedAt = document.getElementById('updated_at').value || '';
  var category = document.getElementById('category').value || '';
  var tags = document.getElementById('tags').value || '';

  var resolvedOgTitle = ogTitle || seoTitle || title;
  var resolvedOgDesc = ogDesc || seoDesc || excerpt;
  var resolvedOgImage = ogImage || featuredImage;
  var resolvedTwTitle = twTitle || ogTitle || seoTitle || title;
  var resolvedTwDesc = twDesc || ogDesc || seoDesc || excerpt;
  var resolvedTwImage = twImage || ogImage || featuredImage;
  var resolvedCanonical = canonical || publishedUrl;

  var slug = getArticleSlug(title);
  var articleUrl = resolvedCanonical || ('https://wordsthatsells.website/en/articles/' + slug + '/');

  var lines = [];
  lines.push('<!-- SEO Meta Tags -->');
  lines.push('<meta name="description" content="' + resolvedOgDesc + '">');
  lines.push('<meta name="robots" content="' + robotsMeta + '">');
  lines.push('<link rel="canonical" href="' + articleUrl + '">');
  lines.push('');
  lines.push('<!-- Open Graph / Facebook / LinkedIn / WhatsApp -->');
  lines.push('<meta property="og:site_name" content="WordsThatSells.Website">');
  lines.push('<meta property="og:type" content="' + ogType + '">');
  lines.push('<meta property="og:title" content="' + resolvedOgTitle + '">');
  lines.push('<meta property="og:description" content="' + resolvedOgDesc + '">');
  if (resolvedOgImage) {
    lines.push('<meta property="og:image" content="' + resolvedOgImage + '">');
    lines.push('<meta property="og:image:width" content="1200">');
    lines.push('<meta property="og:image:height" content="630">');
  }
  lines.push('<meta property="og:url" content="' + articleUrl + '">');
  if (publishedAt) lines.push('<meta property="article:published_time" content="' + new Date(publishedAt).toISOString() + '">');
  if (updatedAt) lines.push('<meta property="article:modified_time" content="' + new Date(updatedAt).toISOString() + '">');
  lines.push('<meta property="article:author" content="WordsThatSells.Website">');
  if (category) lines.push('<meta property="article:section" content="' + category + '">');
  if (tags) {
    tags.split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; }).forEach(function(tag) {
      lines.push('<meta property="article:tag" content="' + tag + '">');
    });
  }
  lines.push('');
  lines.push('<!-- Twitter / X Card -->');
  lines.push('<meta name="twitter:card" content="' + twCard + '">');
  if (twSite) lines.push('<meta name="twitter:site" content="' + twSite + '">');
  if (twCreator) lines.push('<meta name="twitter:creator" content="' + twCreator + '">');
  lines.push('<meta name="twitter:title" content="' + resolvedTwTitle + '">');
  lines.push('<meta name="twitter:description" content="' + resolvedTwDesc + '">');
  if (resolvedTwImage) lines.push('<meta name="twitter:image" content="' + resolvedTwImage + '">');

  document.getElementById('og_meta_preview').value = lines.join('\n');
  document.getElementById('ogMetaPreviewSection').style.display = 'block';
}

// ==================== Image Selector for Social Fields ====================
var socialImageTarget = null;

function openOgImageSelector() {
  socialImageTarget = 'og_image';
  openSocialImageModal();
}

function openTwitterImageSelector() {
  socialImageTarget = 'twitter_image';
  openSocialImageModal();
}

function openSocialImageModal() {
  document.getElementById('imageSelectorModal').style.display = 'block';
  // Override the selectImage function temporarily
  window._originalSelectImage = window.selectImage;
  window.selectImage = function(image) {
    if (socialImageTarget) {
      var url = image.cdn_url || '/images-serve/' + encodeURIComponent(image.filename);
      document.getElementById(socialImageTarget).value = url;
      socialImageTarget = null;
      window.selectImage = window._originalSelectImage;
      closeImageSelector();
      updateSocialPreviews();
      updateSocialScore();
    } else {
      window._originalSelectImage(image);
    }
  };
  loadImages(1);
}

// ==================== Content Labels Management ====================
var contentLabelsData = {};
var keyPointsData = [];
var sidebarSourcesData = [];

document.addEventListener('DOMContentLoaded', function() {
  try {
    var clVal = document.getElementById('content_labels').value;
    contentLabelsData = clVal ? JSON.parse(clVal) : {};
  } catch(e) { contentLabelsData = {}; }

  // Populate form fields from stored data
  if (contentLabelsData.description) document.getElementById('cl_description').value = contentLabelsData.description;
  if (contentLabelsData.who_should_read && Array.isArray(contentLabelsData.who_should_read)) {
    document.getElementById('cl_who_should_read').value = contentLabelsData.who_should_read.join('\n');
  }
  if (contentLabelsData.faqs_count) document.getElementById('cl_faqs_count').value = contentLabelsData.faqs_count;
  if (contentLabelsData.cta_text) document.getElementById('cl_cta_text').value = contentLabelsData.cta_text;

  keyPointsData = contentLabelsData.key_points || [];
  sidebarSourcesData = contentLabelsData.sources || [];
  renderKeyPoints();
  renderSidebarSources();
});

function updateContentLabels() {
  var desc = document.getElementById('cl_description').value.trim();
  var whoLines = document.getElementById('cl_who_should_read').value.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
  var faqsCount = parseInt(document.getElementById('cl_faqs_count').value) || 0;
  var ctaText = document.getElementById('cl_cta_text').value.trim();

  contentLabelsData.description = desc;
  contentLabelsData.who_should_read = whoLines;
  contentLabelsData.key_points = keyPointsData;
  contentLabelsData.sources = sidebarSourcesData;
  contentLabelsData.faqs_count = faqsCount;
  contentLabelsData.cta_text = ctaText;

  document.getElementById('content_labels').value = JSON.stringify(contentLabelsData);
}

function addKeyPoint() {
  keyPointsData.push({ title: '', description: '' });
  updateContentLabels();
  renderKeyPoints();
}

function removeKeyPoint(index) {
  keyPointsData.splice(index, 1);
  updateContentLabels();
  renderKeyPoints();
}

function updateKeyPointField(index, field, value) {
  keyPointsData[index][field] = value;
  updateContentLabels();
}

function renderKeyPoints() {
  var container = document.getElementById('keyPointsList');
  container.innerHTML = '';
  if (keyPointsData.length === 0) {
    container.innerHTML = '<p style="color: var(--gray-500); font-size: 14px; margin: 4px 0;">No key points added yet</p>';
    return;
  }
  keyPointsData.forEach(function(kp, i) {
    var div = document.createElement('div');
    div.className = 'key-point-item';

    var input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-input';
    input.placeholder = 'Point title (bold)';
    input.value = kp.title || '';
    input.oninput = function() {
      updateKeyPointField(i, 'title', this.value);
    };

    var textarea = document.createElement('textarea');
    textarea.className = 'form-input';
    textarea.placeholder = 'Point description';
    textarea.value = kp.description || '';
    textarea.oninput = function() {
      updateKeyPointField(i, 'description', this.value);
    };

    var button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn-remove';
    button.onclick = function() {
      removeKeyPoint(i);
    };

    var icon = document.createElement('i');
    icon.className = 'fas fa-times';
    button.appendChild(icon);

    div.appendChild(input);
    div.appendChild(textarea);
    div.appendChild(button);

    container.appendChild(div);
  });
}

function addSidebarSource() {
  sidebarSourcesData.push({ name: '', url: '' });
  updateContentLabels();
  renderSidebarSources();
}

function removeSidebarSource(index) {
  sidebarSourcesData.splice(index, 1);
  updateContentLabels();
  renderSidebarSources();
}

function updateSidebarSourceField(index, field, value) {
  sidebarSourcesData[index][field] = value;
  updateContentLabels();
}

function renderSidebarSources() {
  var container = document.getElementById('sidebarSourcesList');
  container.innerHTML = '';
  if (sidebarSourcesData.length === 0) {
    container.innerHTML = '<p style="color: var(--gray-500); font-size: 14px; margin: 4px 0;">No sources added yet</p>';
    return;
  }
  sidebarSourcesData.forEach(function(src, i) {
    var div = document.createElement('div');
    div.className = 'sidebar-source-item';

    var nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'form-input';
    nameInput.placeholder = 'Source name';
    nameInput.value = src.name || '';
    nameInput.style.flex = '0.4';
    nameInput.addEventListener('input', (function(idx) { return function() { updateSidebarSourceField(idx, 'name', this.value); }; })(i));

    var urlInput = document.createElement('input');
    urlInput.type = 'url';
    urlInput.className = 'form-input';
    urlInput.placeholder = 'https://source-url.com';
    urlInput.value = src.url || '';
    urlInput.style.flex = '0.6';
    urlInput.addEventListener('input', (function(idx) { return function() { updateSidebarSourceField(idx, 'url', this.value); }; })(i));

    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-remove';
    var removeIcon = document.createElement('i');
    removeIcon.className = 'fas fa-times';
    removeBtn.appendChild(removeIcon);
    removeBtn.addEventListener('click', (function(idx) { return function() { removeSidebarSource(idx); }; })(i));

    div.appendChild(nameInput);
    div.appendChild(urlInput);
    div.appendChild(removeBtn);
    container.appendChild(div);
  });
}

// ==================== AI Article Analysis ====================
function aiAnalyzeArticle() {
  var titleVal = document.getElementById('title').value.trim();
  var contentVal = document.getElementById('content').value.trim();
  var excerptVal = document.getElementById('excerpt').value.trim();

  if (!titleVal && !contentVal) {
    var status = document.getElementById('aiArticleStatus');
    status.style.display = 'block';
    status.innerHTML = '<div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); font-size: 13px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> <strong>Title or content required.</strong> Enter at least an article title or content before running AI analysis.</div>';
    return;
  }

  var btn = document.getElementById('aiArticleBtn');
  var status = document.getElementById('aiArticleStatus');

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing with AI...';
  status.style.display = 'block';
  status.innerHTML = '<div style="padding: 12px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius); font-size: 13px; color: var(--primary);"><i class="fas fa-robot"></i> AI is analyzing your article content and generating SEO metadata, social previews, and content labels...</div>';

  // Determine which endpoint to use
  var articleId = '<%= (typeof articleId !== "undefined" && articleId) ? articleId : "" %>';
  var url, fetchOptions;

  if (articleId && titleVal === '<%= article ? (article.title || "").replace(/\'/g, "\\\'") : "" %>') {
    // Existing article with unchanged title - use saved data
    url = '/content/articles/' + articleId + '/ai-analyze';
    fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' } };
  } else {
    // New article or modified content - send form data
    url = '/content/articles/ai-analyze-draft';
    fetchOptions = {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: titleVal, content: contentVal, excerpt: excerptVal })
    };
  }

  fetch(url, fetchOptions)
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.error) {
        status.innerHTML = '<div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); font-size: 13px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> ' + data.error + '</div>';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill All Metadata';
        return;
      }

      var fieldsUpdated = [];

      // Excerpt
      if (data.excerpt && !excerptVal) {
        document.getElementById('excerpt').value = data.excerpt;
        fieldsUpdated.push('Excerpt');
      }

      // SEO fields
      if (data.seo_title) {
        document.getElementById('seo_title').value = data.seo_title;
        updateCharCount(document.getElementById('seo_title'), 'seoTitleCount', 60);
        fieldsUpdated.push('SEO Title');
      }
      if (data.seo_description) {
        document.getElementById('seo_description').value = data.seo_description;
        updateCharCount(document.getElementById('seo_description'), 'seoDescCount', 160);
        fieldsUpdated.push('SEO Description');
      }
      if (data.seo_keywords && Array.isArray(data.seo_keywords)) {
        document.getElementById('seo_keywords').value = data.seo_keywords.join(', ');
        fieldsUpdated.push('SEO Keywords');
      }

      // Tags
      if (data.tags && Array.isArray(data.tags)) {
        var existingTags = document.getElementById('tags').value.trim();
        if (!existingTags) {
          document.getElementById('tags').value = data.tags.join(', ');
          fieldsUpdated.push('Tags');
        }
      }

      // Category â€” map AI response to current dropdown values
      if (data.category) {
        var catEl = document.getElementById('category');
        var legacyToNew = {
          'marketing': 'Digital Marketing', 'seo': 'SEO', 'ai': 'AI & Automation',
          'social-media': 'Social Media Marketing', 'content': 'Content Strategy', 'business': 'Business Growth'
        };
        var newCats = ['Digital Marketing','SEO','AI & Automation','Social Media Marketing','Content Strategy','Business Growth','Web Development','E-Commerce','Analytics & Data','Email Marketing','PPC & Paid Advertising','Branding & Design'];
        var mapped = legacyToNew[data.category] || data.category;
        if (newCats.indexOf(mapped) !== -1 && !catEl.value) {
          catEl.value = mapped;
          fieldsUpdated.push('Category');
        }
      }

      // OG fields
      if (data.og_title) {
        document.getElementById('og_title').value = data.og_title;
        updateCharCount(document.getElementById('og_title'), 'ogTitleCount', 60);
        fieldsUpdated.push('OG Title');
      }
      if (data.og_description) {
        document.getElementById('og_description').value = data.og_description;
        updateCharCount(document.getElementById('og_description'), 'ogDescCount', 200);
        fieldsUpdated.push('OG Description');
      }

      // Twitter fields
      if (data.twitter_title) {
        document.getElementById('twitter_title').value = data.twitter_title;
        updateCharCount(document.getElementById('twitter_title'), 'twitterTitleCount', 70);
        fieldsUpdated.push('X Title');
      }
      if (data.twitter_description) {
        document.getElementById('twitter_description').value = data.twitter_description;
        updateCharCount(document.getElementById('twitter_description'), 'twitterDescCount', 200);
        fieldsUpdated.push('X Description');
      }

      // Content Labels
      if (data.content_labels) {
        var cl = data.content_labels;
        if (cl.description) {
          document.getElementById('cl_description').value = cl.description;
          fieldsUpdated.push('Card Description');
        }
        if (cl.who_should_read && Array.isArray(cl.who_should_read)) {
          document.getElementById('cl_who_should_read').value = cl.who_should_read.join('\n');
          fieldsUpdated.push('Who Should Read');
        }
        if (cl.key_points && Array.isArray(cl.key_points)) {
          keyPointsData = cl.key_points;
          renderKeyPoints();
          fieldsUpdated.push('Key Points');
        }
        updateContentLabels();
      }

      // Update all live previews
      updateSerpPreview();
      updateSocialPreviews();
      updateSocialScore();

      status.innerHTML = '<div style="padding: 12px; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius); font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> AI analysis complete! Updated: <strong>' + fieldsUpdated.join(', ') + '</strong>. Review and edit as needed before saving.</div>';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill All Metadata';
    })
    .catch(function(err) {
      status.innerHTML = '<div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: var(--radius); font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> Failed to analyze: ' + err.message + '</div>';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill All Metadata';
    });
}

// ==================== Form Tab Switching ====================
function switchFormTab(tabName) {
  // Update tab buttons
  var tabs = document.querySelectorAll('.form-tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove('active');
  }
  var activeTab = document.querySelector('.form-tab[data-tab="' + tabName + '"]');
  if (activeTab) activeTab.classList.add('active');

  // Update panels - use inline styles for reliability
  var panels = document.querySelectorAll('.form-tab-panel');
  for (var i = 0; i < panels.length; i++) {
    panels[i].style.display = 'none';
    panels[i].classList.remove('active');
  }
  var activePanel = document.getElementById('panel-' + tabName);
  if (activePanel) {
    activePanel.style.display = 'block';
    activePanel.classList.add('active');
  }

  // Refresh previews for the active tab
  if (tabName === 'social') { updateSocialPreviews(); updateSocialScore(); }
  if (tabName === 'seo') { updateSerpPreview(); }
}

// ==================== Featured Image Picker ====================
function openFeaturedImageSelector() {
  socialImageTarget = 'featured_image';
  openSocialImageModal();
}

function updateFeaturedPreview() {
  var url = document.getElementById('featured_image').value;
  var preview = document.getElementById('featuredImagePreview');
  var thumb = document.getElementById('featuredImageThumb');
  var empty = document.getElementById('featuredImageEmpty');
  if (url) {
    thumb.src = url;
    preview.style.display = 'inline-block';
    empty.style.display = 'none';
  } else {
    preview.style.display = 'none';
    empty.style.display = 'flex';
  }
}

function removeFeaturedImage() {
  document.getElementById('featured_image').value = '';
  updateFeaturedPreview();
}

// ==================== AI Confirmation Dialog ====================
function confirmAiAnalysis() {
  var titleVal = document.getElementById('title').value.trim();
  var contentVal = document.getElementById('content').value.trim();
  if (!titleVal && !contentVal) {
    var status = document.getElementById('aiArticleStatus');
    status.style.display = 'block';
    status.innerHTML = '<div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); font-size: 13px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> <strong>Title or content required.</strong> Enter at least an article title or content before running AI analysis.</div>';
    return;
  }
  document.getElementById('aiConfirmModal').style.display = 'block';
}

function closeAiConfirmModal() {
  document.getElementById('aiConfirmModal').style.display = 'none';
}

// AI per-section micro-buttons (uses cached response)
var aiCachedResponse = null;

function aiSuggestSection(section) {
  if (aiCachedResponse) {
    applyAiToSection(section, aiCachedResponse);
    return;
  }
  // No cache, run full analysis and then apply just this section
  var titleVal = document.getElementById('title').value.trim();
  var contentVal = document.getElementById('content').value.trim();
  var excerptVal = document.getElementById('excerpt').value.trim();
  if (!titleVal && !contentVal) { alert('Please enter at least a title or content first.'); return; }

  var evt = window.event || {};
  var btn = evt.target ? evt.target.closest('button') : null;
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
  }

  var articleId = '<%= (typeof articleId !== "undefined" && articleId) ? articleId : "" %>';
  <% 
    var _originalTitle = article ? (article.title || "") : "";
    var _escapedTitle = JSON.stringify(_originalTitle).slice(1, -1);
  %>
  var url, fetchOptions;
  if (articleId && titleVal === '<%= _escapedTitle %>') {
    url = '/content/articles/' + articleId + '/ai-analyze';
    fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' } };
  } else {
    url = '/content/articles/ai-analyze-draft';
    fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: titleVal, content: contentVal, excerpt: excerptVal }) };
  }

  fetch(url, fetchOptions)
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (!data.error) {
        aiCachedResponse = data;
        applyAiToSection(section, data);
      } else {
        alert('AI error: ' + data.error);
      }
      if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot"></i> AI Suggest ' + (section === 'seo' ? 'SEO' : 'Social'); }
    })
    .catch(function(err) {
      alert('AI failed: ' + err.message);
      if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot"></i> AI Suggest ' + (section === 'seo' ? 'SEO' : 'Social'); }
    });
}

function applyAiToSection(section, data) {
  if (section === 'seo') {
    if (data.seo_title) { document.getElementById('seo_title').value = data.seo_title; updateCharCount(document.getElementById('seo_title'), 'seoTitleCount', 60); }
    if (data.seo_description) { document.getElementById('seo_description').value = data.seo_description; updateCharCount(document.getElementById('seo_description'), 'seoDescCount', 160); }
    if (data.seo_keywords && Array.isArray(data.seo_keywords)) { document.getElementById('seo_keywords').value = data.seo_keywords.join(', '); }
    updateSerpPreview();
  } else if (section === 'social') {
    if (data.og_title) { document.getElementById('og_title').value = data.og_title; updateCharCount(document.getElementById('og_title'), 'ogTitleCount', 60); }
    if (data.og_description) { document.getElementById('og_description').value = data.og_description; updateCharCount(document.getElementById('og_description'), 'ogDescCount', 200); }
    if (data.twitter_title) { document.getElementById('twitter_title').value = data.twitter_title; updateCharCount(document.getElementById('twitter_title'), 'twitterTitleCount', 70); }
    if (data.twitter_description) { document.getElementById('twitter_description').value = data.twitter_description; updateCharCount(document.getElementById('twitter_description'), 'twitterDescCount', 200); }
    updateSocialPreviews();
    updateSocialScore();
  }
  formDirty = true;
  document.getElementById('unsavedBadge').style.display = 'inline-flex';
}

// ==================== Twitter Fields Toggle ====================
function toggleTwitterFields() {
  var checked = document.getElementById('twitterCustomizeToggle').checked;
  document.getElementById('tab-twitter').style.display = checked ? 'block' : 'none';
}

// ==================== Accordion Toggle ====================
function toggleAccordion(id, btn) {
  var body = document.getElementById(id);
  if (body.style.display === 'none') {
    body.style.display = 'block';
    if (btn) btn.classList.add('open');
  } else {
    body.style.display = 'none';
    if (btn) btn.classList.remove('open');
  }
}

// ==================== Unsaved Changes Warning ====================
var formDirty = false;
var leaveUrl = '/content/articles';

document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('articleForm');
  form.addEventListener('input', function() {
    formDirty = true;
    var badge = document.getElementById('unsavedBadge');
    if (badge) badge.style.display = 'inline-flex';
    updateCompletionIndicator();
  });
  form.addEventListener('change', function() {
    formDirty = true;
    var badge = document.getElementById('unsavedBadge');
    if (badge) badge.style.display = 'inline-flex';
    updateCompletionIndicator();
  });
  form.addEventListener('submit', function() { formDirty = false; });

  // Intercept navigation links
  var backLink = document.querySelector('a[href="/content/articles"]');
  if (backLink) {
    backLink.addEventListener('click', function(e) {
      if (formDirty) { e.preventDefault(); showUnsavedModal('/content/articles'); }
    });
  }
  var cancelBtn = document.getElementById('cancelBtn');
  if (cancelBtn) cancelBtn.addEventListener('click', function(e) {
    if (formDirty) { e.preventDefault(); showUnsavedModal('/content/articles'); }
  });
  var cancelBtnBottom = document.getElementById('cancelBtnBottom');
  if (cancelBtnBottom) cancelBtnBottom.addEventListener('click', function(e) {
    if (formDirty) { e.preventDefault(); showUnsavedModal('/content/articles'); }
  });

  window.addEventListener('beforeunload', function(e) {
    if (formDirty) { e.preventDefault(); e.returnValue = ''; }
  });
});

function showUnsavedModal(url) {
  leaveUrl = url;
  document.getElementById('unsavedModal').style.display = 'block';
}
function closeUnsavedModal() {
  document.getElementById('unsavedModal').style.display = 'none';
}
function leaveWithoutSaving() {
  formDirty = false;
  window.location.href = leaveUrl;
}

// ==================== Completion Indicator ====================
function updateCompletionIndicator() {
  var dots = document.querySelectorAll('.completion-dot');
  var complete = 0;

  // Content: title + content
  var cDot = document.querySelector('.completion-dot[data-section="content"]');
  var hasTitle = document.getElementById('title').value.trim();
  var hasContent = document.getElementById('content').value.trim();
  if (hasTitle && hasContent) { cDot.className = 'completion-dot complete'; complete++; }
  else if (hasTitle || hasContent) { cDot.className = 'completion-dot partial'; }
  else { cDot.className = 'completion-dot'; }

  // SEO: seo_title + seo_description
  var sDot = document.querySelector('.completion-dot[data-section="seo"]');
  var hasST = document.getElementById('seo_title').value.trim();
  var hasSD = document.getElementById('seo_description').value.trim();
  if (hasST && hasSD) { sDot.className = 'completion-dot complete'; complete++; }
  else if (hasST || hasSD) { sDot.className = 'completion-dot partial'; }
  else { sDot.className = 'completion-dot'; }

  // Social: og_title + og_description + og_image
  var soDot = document.querySelector('.completion-dot[data-section="social"]');
  var hasOT = document.getElementById('og_title').value.trim();
  var hasOD = document.getElementById('og_description').value.trim();
  var hasOI = document.getElementById('og_image').value.trim();
  if (hasOT && hasOD && hasOI) { soDot.className = 'completion-dot complete'; complete++; }
  else if (hasOT || hasOD || hasOI) { soDot.className = 'completion-dot partial'; }
  else { soDot.className = 'completion-dot'; }

  // Advanced: citations or schema
  var aDot = document.querySelector('.completion-dot[data-section="advanced"]');
  var hasCit = false;
  try { hasCit = JSON.parse(document.getElementById('citations').value || '[]').length > 0; } catch(e) {}
  var hasSch = document.getElementById('schema_markup').value.trim();
  if (hasCit && hasSch) { aDot.className = 'completion-dot complete'; complete++; }
  else if (hasCit || hasSch) { aDot.className = 'completion-dot partial'; }
  else { aDot.className = 'completion-dot'; }

  // Publish: published_url set
  var pDot = document.querySelector('.completion-dot[data-section="publish"]');
  if (pDot) {
    var hasPubUrl = document.getElementById('published_url').value.trim();
    var ghToken = localStorage.getItem('wts_gh_token');
    if (hasPubUrl) { pDot.className = 'completion-dot complete'; complete++; }
    else if (ghToken) { pDot.className = 'completion-dot partial'; }
    else { pDot.className = 'completion-dot'; }
  }

  var text = document.getElementById('completionText');
  if (text) text.textContent = complete + '/5';
}

// ==================== Initialize on Page Load ====================
document.addEventListener('DOMContentLoaded', function() {
  // ---- Form tab click handlers (using addEventListener, not inline onclick) ----
  var formTabButtons = document.querySelectorAll('#formTabs .form-tab');
  for (var t = 0; t < formTabButtons.length; t++) {
    formTabButtons[t].addEventListener('click', function(e) {
      e.preventDefault();
      var tabName = this.getAttribute('data-tab');
      if (tabName) switchFormTab(tabName);
    });
  }

  // ---- Social inner tab click handlers ----
  var socialTabButtons = document.querySelectorAll('#socialTabs .social-tab');
  for (var s = 0; s < socialTabButtons.length; s++) {
    socialTabButtons[s].addEventListener('click', function(e) {
      e.preventDefault();
      var tabName = this.getAttribute('data-tab');
      if (tabName) switchSocialTab(tabName);
    });
  }

  // ---- Wire up ALL buttons (no inline onclick) ----
  function bind(id, fn) { var el = document.getElementById(id); if (el) el.addEventListener('click', fn); }

  // Sticky action bar
  bind('aiArticleBtn', function() { confirmAiAnalysis(); });

  // Content tab
  bind('removeFeaturedImageBtn', function() { removeFeaturedImage(); });
  bind('openFeaturedImageBtn', function() { openFeaturedImageSelector(); });

  // SEO tab
  bind('aiSuggestSeoBtn', function() { aiSuggestSection('seo'); });

  // Social tab
  bind('aiSuggestSocialBtn', function() { aiSuggestSection('social'); });
  bind('autoPopulateSocialBtn', function() { autoPopulateSocial(); });
  bind('openOgImageBtn', function() { openOgImageSelector(); });
  bind('openTwitterImageBtn', function() { openTwitterImageSelector(); });

  // Advanced tab
  bind('addCitationBtn', function() { addCitation(); });
  bind('schemaAccordionBtn', function() { toggleAccordion('schemaAccordion', this); });
  bind('genSchemaBtn', function() { generateSchemaMarkup(); });
  bind('genOgPreviewBtn', function() { generateOgMetaPreview(); });
  bind('addKeyPointBtn', function() { addKeyPoint(); });
  bind('addSidebarSourceBtn', function() { addSidebarSource(); });

  // Twitter toggle
  bind('twitterCustomizeToggle', function() { toggleTwitterFields(); });

  // AI Confirm modal
  bind('aiConfirmCloseX', function() { closeAiConfirmModal(); });
  bind('aiConfirmCancelBtn', function() { closeAiConfirmModal(); });
  bind('aiConfirmGoBtn', function() { closeAiConfirmModal(); aiAnalyzeArticle(); });

  // Unsaved modal
  bind('unsavedCloseX', function() { closeUnsavedModal(); });
  bind('unsavedStayBtn', function() { closeUnsavedModal(); });
  bind('unsavedLeaveBtn', function() { leaveWithoutSaving(); });

  // Image selector modal
  bind('imageModalCloseX', function() { closeImageSelector(); });
  bind('imageSearchBtn', function() { searchImages(); });

  // OG type & twitter card selects
  var ogTypeEl = document.getElementById('og_type');
  if (ogTypeEl) ogTypeEl.addEventListener('change', function() { updateSocialScore(); });
  var twCardEl = document.getElementById('twitter_card');
  if (twCardEl) twCardEl.addEventListener('change', function() { updateSocialPreviews(); updateSocialScore(); });

  // Featured image URL input
  var featImgEl = document.getElementById('featured_image');
  if (featImgEl) featImgEl.addEventListener('input', function() { updateFeaturedPreview(); });

  // Content labels fields
  var clFields = ['cl_description', 'cl_who_should_read', 'cl_faqs_count', 'cl_cta_text'];
  for (var c = 0; c < clFields.length; c++) {
    var clEl = document.getElementById(clFields[c]);
    if (clEl) clEl.addEventListener('input', function() { updateContentLabels(); });
  }

  // Initialize character counters
  var seoTitleEl = document.getElementById('seo_title');
  var seoDescEl = document.getElementById('seo_description');
  var ogTitleEl = document.getElementById('og_title');
  var ogDescEl = document.getElementById('og_description');
  var twTitleEl = document.getElementById('twitter_title');
  var twDescEl = document.getElementById('twitter_description');

  if (seoTitleEl) updateCharCount(seoTitleEl, 'seoTitleCount', 60);
  if (seoDescEl) updateCharCount(seoDescEl, 'seoDescCount', 160);
  if (ogTitleEl) updateCharCount(ogTitleEl, 'ogTitleCount', 60);
  if (ogDescEl) updateCharCount(ogDescEl, 'ogDescCount', 200);
  if (twTitleEl) updateCharCount(twTitleEl, 'twitterTitleCount', 70);
  if (twDescEl) updateCharCount(twDescEl, 'twitterDescCount', 200);

  // Initialize social score
  updateSocialScore();

  // Initialize previews
  updateSocialPreviews();

  // Listen for changes on main article fields to update SERP preview
  var titleEl = document.getElementById('title');
  var excerptEl = document.getElementById('excerpt');
  if (titleEl) titleEl.addEventListener('input', function() { updateSerpPreview(); updateSocialPreviews(); });
  if (excerptEl) excerptEl.addEventListener('input', function() { updateSerpPreview(); updateSocialPreviews(); });
  if (seoTitleEl) seoTitleEl.addEventListener('input', function() { updateCharCount(seoTitleEl, 'seoTitleCount', 60); updateSerpPreview(); updateSocialScore(); });
  if (seoDescEl) seoDescEl.addEventListener('input', function() { updateCharCount(seoDescEl, 'seoDescCount', 160); updateSerpPreview(); updateSocialScore(); });

  // OG / Social field input listeners
  if (ogTitleEl) ogTitleEl.addEventListener('input', function() { updateCharCount(ogTitleEl, 'ogTitleCount', 60); updateSocialPreviews(); updateSocialScore(); });
  if (ogDescEl) ogDescEl.addEventListener('input', function() { updateCharCount(ogDescEl, 'ogDescCount', 200); updateSocialPreviews(); updateSocialScore(); });
  var ogImageEl = document.getElementById('og_image');
  if (ogImageEl) ogImageEl.addEventListener('input', function() { updateSocialPreviews(); updateSocialScore(); });

  // Twitter field input listeners
  if (twTitleEl) twTitleEl.addEventListener('input', function() { updateCharCount(twTitleEl, 'twitterTitleCount', 70); updateSocialPreviews(); updateSocialScore(); });
  if (twDescEl) twDescEl.addEventListener('input', function() { updateCharCount(twDescEl, 'twitterDescCount', 200); updateSocialPreviews(); updateSocialScore(); });
  var twImageEl = document.getElementById('twitter_image');
  if (twImageEl) twImageEl.addEventListener('input', function() { updateSocialPreviews(); updateSocialScore(); });
  var twSiteEl = document.getElementById('twitter_site');
  if (twSiteEl) twSiteEl.addEventListener('input', function() { updateSocialPreviews(); updateSocialScore(); });
  var twCreatorEl = document.getElementById('twitter_creator');
  if (twCreatorEl) twCreatorEl.addEventListener('input', function() { updateSocialScore(); });

  // Initialize completion indicator
  updateCompletionIndicator();

  // Auto-check Twitter toggle if Twitter-specific values exist
  var twTitle = document.getElementById('twitter_title').value.trim();
  var twDesc = document.getElementById('twitter_description').value.trim();
  var twImage = document.getElementById('twitter_image').value.trim();
  var twSite = document.getElementById('twitter_site').value.trim();
  var twCreator = document.getElementById('twitter_creator').value.trim();
  if (twTitle || twDesc || twImage || twSite || twCreator) {
    document.getElementById('twitterCustomizeToggle').checked = true;
    toggleTwitterFields();
  }

  // ==================== SEO IMPROVEMENTS ====================

  // Author type toggle
  var authorTypeEl = document.getElementById('author_type');
  if (authorTypeEl) {
    authorTypeEl.addEventListener('change', function() {
      document.getElementById('personAuthorFields').style.display = this.value === 'person' ? 'block' : 'none';
    });
  }

  // Canonical URL auto-populate
  bind('autoCanonicalBtn', function() {
    var title = document.getElementById('title').value || '';
    var slug = getArticleSlug(title);
    if (slug) {
      document.getElementById('canonical_url').value = 'https://wordsthatsells.website/en/articles/' + slug + '.html';
      checkCanonicalMismatch();
    }
  });

  // Check canonical URL mismatch on input
  var canonicalEl = document.getElementById('canonical_url');
  if (canonicalEl) canonicalEl.addEventListener('input', function() { checkCanonicalMismatch(); });
  if (titleEl) titleEl.addEventListener('input', function() { checkCanonicalMismatch(); updateLiveWordCount(); });

  function checkCanonicalMismatch() {
    var title = document.getElementById('title').value || '';
    var canonical = document.getElementById('canonical_url').value || '';
    var warning = document.getElementById('canonicalMismatchWarning');
    if (!canonical || !title) { warning.style.display = 'none'; return; }
    var expectedSlug = getArticleSlug(title);
    var canonicalHasSlug = canonical.indexOf(expectedSlug) !== -1;
    warning.style.display = canonicalHasSlug ? 'none' : 'block';
  }
  checkCanonicalMismatch();

  // Twitter creator validation
  var twCreatorInput = document.getElementById('twitter_creator');
  if (twCreatorInput) {
    twCreatorInput.addEventListener('input', function() {
      var val = this.value.trim();
      var warning = document.getElementById('twitterCreatorWarning');
      if (val && !val.startsWith('@')) {
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    });
    // Also validate twitter_site
    var twSiteInput = document.getElementById('twitter_site');
    if (twSiteInput) {
      twSiteInput.addEventListener('blur', function() {
        var val = this.value.trim();
        if (val && !val.startsWith('@')) {
          this.value = '@' + val;
        }
      });
    }
    twCreatorInput.addEventListener('blur', function() {
      var val = this.value.trim();
      if (val && !val.startsWith('@')) {
        this.value = '@' + val;
        document.getElementById('twitterCreatorWarning').style.display = 'none';
      }
    });
  }

  // Live word count
  var textArticleEl = document.getElementById('text_article');
  var contentEl = document.getElementById('content');
  if (textArticleEl) textArticleEl.addEventListener('input', function() { updateLiveWordCount(); });
  if (contentEl) contentEl.addEventListener('input', function() { updateLiveWordCount(); });

  function updateLiveWordCount() {
    var textAreaEl = document.getElementById('text_article');
    var contentInputEl = document.getElementById('content');
    var rawValue = '';

    if (textAreaEl && textAreaEl.value) {
      rawValue = textAreaEl.value;
    } else if (contentInputEl && contentInputEl.value) {
      rawValue = contentInputEl.value;
    }

    // Strip HTML tags without interpreting the text as HTML.
    var plain = '';
    if (rawValue) {
      // Remove angle-bracketed tags; this avoids using innerHTML on untrusted input.
      plain = rawValue.replace(/<[^>]*>/g, '');
    }


    var count = plain.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
    var el = document.getElementById('liveWordCount');
    if (!el) return;
    el.textContent = count.toLocaleString() + ' words';
    el.className = 'char-counter';
    if (count >= 1000) el.classList.add('good');
    else if (count >= 500) el.classList.add('warn');
    else if (count > 0) el.classList.add('over');
  }
  updateLiveWordCount();

  // SEO Audit Panel
  bind('refreshAuditBtn', function() { runSeoAudit(); });

  function runSeoAudit() {
    var checks = [];
    var title = document.getElementById('title').value || '';
    var seoTitle = document.getElementById('seo_title').value || '';
    var seoDesc = document.getElementById('seo_description').value || '';
    var canonical = document.getElementById('canonical_url').value || '';
    var ogTitle = document.getElementById('og_title').value || '';
    var ogDesc = document.getElementById('og_description').value || '';
    var ogImage = document.getElementById('og_image').value || '';
    var featuredImage = document.getElementById('featured_image').value || '';
    var twCreator = document.getElementById('twitter_creator').value || '';
    var category = document.getElementById('category').value || '';
    var tags = document.getElementById('tags').value || '';
    var excerpt = document.getElementById('excerpt').value || '';
    var textContent = (document.getElementById('text_article').value || document.getElementById('content').value || '');
    var wordCount = textContent.replace(/<[^>]*>/g, '').split(/\s+/).filter(function(w) { return w.length > 0; }).length;
    var slug = getArticleSlug(title);

    // Checks
    checks.push({ label: 'Title present', pass: title.length > 0 });
    checks.push({ label: 'SEO title (50-60 chars)', pass: seoTitle.length >= 50 && seoTitle.length <= 60, warn: seoTitle.length > 0 && (seoTitle.length < 50 || seoTitle.length > 60) });
    checks.push({ label: 'SEO description (150-160 chars)', pass: seoDesc.length >= 150 && seoDesc.length <= 160, warn: seoDesc.length > 0 && (seoDesc.length < 150 || seoDesc.length > 160) });
    checks.push({ label: 'Canonical URL set', pass: canonical.length > 0 });
    checks.push({ label: 'Canonical matches slug', pass: canonical.indexOf(slug) !== -1, warn: canonical.length > 0 && canonical.indexOf(slug) === -1 });
    checks.push({ label: 'OG title set', pass: ogTitle.length > 0 });
    checks.push({ label: 'OG description set', pass: ogDesc.length > 0 });
    checks.push({ label: 'OG image set', pass: ogImage.length > 0 || featuredImage.length > 0 });
    checks.push({ label: 'Twitter creator format (@)', pass: !twCreator || twCreator.startsWith('@'), warn: twCreator.length > 0 && !twCreator.startsWith('@') });
    checks.push({ label: 'Category selected', pass: category.length > 0 });
    checks.push({ label: 'Tags present', pass: tags.length > 0 });
    checks.push({ label: 'Excerpt present', pass: excerpt.length > 0 });
    checks.push({ label: 'Word count >= 1000', pass: wordCount >= 1000, warn: wordCount >= 500 && wordCount < 1000 });
    checks.push({ label: 'Featured image set', pass: featuredImage.length > 0 });

    var passed = checks.filter(function(c) { return c.pass; }).length;
    var total = checks.length;
    var pct = Math.round((passed / total) * 100);

    document.getElementById('seoAuditScore').textContent = passed + '/' + total;
    var fill = document.getElementById('seoAuditFill');
    fill.style.width = pct + '%';
    fill.style.backgroundColor = pct >= 80 ? '#059669' : pct >= 50 ? '#d97706' : '#dc2626';

    var html = '';
    checks.forEach(function(c) {
      var cls = c.pass ? 'pass' : (c.warn ? 'warn' : 'fail');
      var icon = c.pass ? 'fa-check-circle' : (c.warn ? 'fa-exclamation-circle' : 'fa-times-circle');
      html += '<div class="seo-audit-check ' + cls + '">';
      html += '<span class="check-icon"><i class="fas ' + icon + '"></i></span>';
      html += '<span>' + c.label + '</span>';
      html += '</div>';
    });
    document.getElementById('seoAuditChecks').innerHTML = html;
  }

  // Run initial audit
  runSeoAudit();

  // Close modals on outside click
  window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('aiConfirmModal')) closeAiConfirmModal();
    if (e.target === document.getElementById('unsavedModal')) closeUnsavedModal();
  });
});

// ==================== AUTO-HYPERLINK ENGINE ====================
var linkTermsCache = null;
var contentBeforeLinks = null;
var textArticleBeforeLinks = null;

function fetchLinkTerms(callback) {
  if (linkTermsCache) return callback(linkTermsCache);
  fetch('/content/articles/api/link-terms')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      linkTermsCache = data;
      callback(data);
    })
    .catch(function(err) {
      console.error('Failed to fetch link terms:', err);
      callback({ glossary: [], seo_terms: [], ai_tools: [] });
    });
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function hyperlinkContent(htmlContent, terms) {
  if (!terms || !htmlContent) return { html: htmlContent, count: 0, details: { glossary: 0, seo: 0, ai_tool: 0 } };

  // Combine all terms and sort by length (longest first for greedy matching)
  var allTerms = [].concat(
    terms.glossary || [],
    terms.seo_terms || [],
    terms.ai_tools || []
  ).sort(function(a, b) { return b.term.length - a.term.length; });

  var linked = {};
  var result = htmlContent;
  var count = 0;
  var details = { glossary: 0, seo: 0, ai_tool: 0 };

  for (var i = 0; i < allTerms.length; i++) {
    var termData = allTerms[i];
    var termKey = termData.term.toLowerCase();
    if (linked[termKey]) continue;
    if (!termData.link) continue;

    var escaped = escapeRegex(termData.term);
    // Match term not already inside an HTML tag or existing link
    var regex = new RegExp('(?<![<\\/\\w])\\b(' + escaped + ')\\b(?![^<]*>)', 'i');

    var match = result.match(regex);
    if (match) {
      var linkClass = 'auto-linked auto-linked-' + termData.type;
      var title = (termData.definition || '').replace(/"/g, '&quot;');
      var replacement = '<a href="' + termData.link + '" class="' + linkClass + '" title="' + title + '" data-type="' + termData.type + '">' + match[1] + '</a>';
      result = result.replace(regex, replacement);
      linked[termKey] = true;
      count++;
      if (details[termData.type] !== undefined) details[termData.type]++;
    }
  }

  return { html: result, count: count, details: details };
}

function autoHyperlinkField(fieldId, statusId) {
  var statusEl = document.getElementById(statusId);
  statusEl.style.display = 'block';
  statusEl.innerHTML = '<div style="padding: 10px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius, 6px); font-size: 13px; color: var(--primary);"><i class="fas fa-spinner fa-spin"></i> Fetching terms and scanning content...</div>';

  fetchLinkTerms(function(terms) {
    var field = document.getElementById(fieldId);
    var content = field.value;

    // Save original content for undo
    if (fieldId === 'content') contentBeforeLinks = content;
    if (fieldId === 'text_article') textArticleBeforeLinks = content;

    var result = hyperlinkContent(content, terms);
    field.value = result.html;

    var totalTerms = (terms.glossary || []).length + (terms.seo_terms || []).length + (terms.ai_tools || []).length;
    statusEl.innerHTML = '<div style="padding: 10px; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius, 6px); font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> Linked <strong>' + result.count + '</strong> terms (Glossary: ' + result.details.glossary + ', SEO: ' + result.details.seo + ', AI Tools: ' + result.details.ai_tool + ') from ' + totalTerms + ' available terms.</div>';

    formDirty = true;
    document.getElementById('unsavedBadge').style.display = 'inline-flex';
  });
}

function autoHyperlinkAll() {
  var statusEl = document.getElementById('pubHyperlinkStatus');
  statusEl.style.display = 'block';
  statusEl.innerHTML = '<div style="padding: 10px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius, 6px); font-size: 13px; color: var(--primary);"><i class="fas fa-spinner fa-spin"></i> Fetching terms and scanning all content fields...</div>';

  fetchLinkTerms(function(terms) {
    var contentField = document.getElementById('content');
    var textField = document.getElementById('text_article');

    // Save originals for undo
    contentBeforeLinks = contentField.value;
    textArticleBeforeLinks = textField.value;

    var contentResult = hyperlinkContent(contentField.value, terms);
    var textResult = hyperlinkContent(textField.value, terms);

    contentField.value = contentResult.html;
    textField.value = textResult.html;

    var totalLinked = contentResult.count + textResult.count;
    var totalTerms = (terms.glossary || []).length + (terms.seo_terms || []).length + (terms.ai_tools || []).length;

    // Show stats
    var statsEl = document.getElementById('pubHyperlinkStats');
    statsEl.style.display = 'grid';
    statsEl.innerHTML =
      '<div class="hyperlink-stat-item"><i class="fas fa-link"></i> Total Linked: <span class="stat-count">' + totalLinked + '</span></div>' +
      '<div class="hyperlink-stat-item"><i class="fas fa-book"></i> Glossary: <span class="stat-count">' + (contentResult.details.glossary + textResult.details.glossary) + '</span></div>' +
      '<div class="hyperlink-stat-item"><i class="fas fa-search"></i> SEO Terms: <span class="stat-count">' + (contentResult.details.seo + textResult.details.seo) + '</span></div>' +
      '<div class="hyperlink-stat-item"><i class="fas fa-robot"></i> AI Tools: <span class="stat-count">' + (contentResult.details.ai_tool + textResult.details.ai_tool) + '</span></div>' +
      '<div class="hyperlink-stat-item"><i class="fas fa-database"></i> Available: <span class="stat-count">' + totalTerms + '</span></div>';

    // Show undo button
    document.getElementById('pubUndoLinksBtn').style.display = 'inline-flex';

    statusEl.innerHTML = '<div style="padding: 10px; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius, 6px); font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> Successfully auto-linked <strong>' + totalLinked + '</strong> terms across both content fields.</div>';

    formDirty = true;
    document.getElementById('unsavedBadge').style.display = 'inline-flex';
  });
}

function undoAutoLinks() {
  if (contentBeforeLinks !== null) {
    document.getElementById('content').value = contentBeforeLinks;
    contentBeforeLinks = null;
  }
  if (textArticleBeforeLinks !== null) {
    document.getElementById('text_article').value = textArticleBeforeLinks;
    textArticleBeforeLinks = null;
  }
  document.getElementById('pubUndoLinksBtn').style.display = 'none';
  document.getElementById('pubHyperlinkStats').style.display = 'none';
  document.getElementById('pubHyperlinkStatus').innerHTML = '<div style="padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius, 6px); font-size: 13px; color: #856404;"><i class="fas fa-undo"></i> Links have been removed. Content restored to previous state.</div>';
}

// ==================== CALCULATE READING TIME ====================
function calcReadingTime() {
  var content = document.getElementById('text_article').value || document.getElementById('content').value || '';
  var text = content.replace(/<[^>]*>/g, ' ');
  var words = text.split(/\s+/).filter(function(w) { return w.length > 0; });
  var minutes = Math.max(1, Math.ceil(words.length / 200));
  document.getElementById('time_to_read').value = minutes;
  formDirty = true;
  document.getElementById('unsavedBadge').style.display = 'inline-flex';
}

// ==================== ARTICLE PREVIEW GENERATOR ====================
function generateArticlePreview() {
  // If HTML Article Page code is provided, use it directly
  var articleCode = (document.getElementById('article_code').value || '').trim();
  if (articleCode) {
    var container = document.getElementById('articlePreviewContainer');
    var frame = document.getElementById('articlePreviewFrame');
    container.style.display = 'block';

    var doc = frame.contentDocument || frame.contentWindow.document;
    doc.open();
    doc.write(articleCode);
    doc.close();

    document.getElementById('openPreviewNewTabBtn').style.display = 'inline-flex';
    window._lastPreviewHTML = articleCode;
    return;
  }

  var title = document.getElementById('title').value || 'Untitled Article';
  var excerpt = document.getElementById('excerpt').value || '';
  var featuredImage = document.getElementById('featured_image').value || '';
  var textArticle = document.getElementById('text_article').value || document.getElementById('content').value || '';
  var publishedAt = document.getElementById('published_at').value || new Date().toISOString();
  var updatedAt = document.getElementById('updated_at').value || '';
  var timeToRead = document.getElementById('time_to_read').value || '';
  var category = document.getElementById('category').value || '';
  var tags = (document.getElementById('tags').value || '').split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; });
  var seoDesc = document.getElementById('seo_description').value || excerpt || '';

  if (!timeToRead) {
    var text = textArticle.replace(/<[^>]*>/g, ' ');
    var words = text.split(/\s+/).filter(function(w) { return w.length > 0; });
    timeToRead = Math.max(1, Math.ceil(words.length / 200));
  }

  var formattedDate = new Date(publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  var formattedUpdated = updatedAt ? new Date(updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';

  var categories = [];
  if (category) categories.push(category.charAt(0).toUpperCase() + category.slice(1));
  tags.forEach(function(t) { categories.push(t); });

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  var categoryPills = categories.map(function(c) {
    return '<span style="background-color:#64748b;color:#fff;padding:4px 12px;border-radius:999px;font-size:0.875rem;font-weight:500;">'
      + escapeHtml(c)
      + '</span>';
  }).join('');

  // Detect if content is plain text (no HTML tags) and wrap in paragraphs
  var articleContent = textArticle;
  if (articleContent && !/<[a-z][\s\S]*>/i.test(articleContent)) {
    articleContent = articleContent.split(/\n\n+/).map(function(p) {
      return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
    }).join('');
  }

  var previewHTML = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">'
    + '<title>' + title + ' | WordsThatSells.Website</title>'
    + '<script src="https://kit.fontawesome.com/a521ce00f6.js" crossorigin="anonymous"><\/script>'
    + '<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>'
    + '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">'
    + '<style>'
    + ':root{--color-primary-base:#1f85c9;--color-accent-magenta:#d62b83;--color-slate-900:#122a3f;--color-slate-800:#154266;--color-slate-500:#64748b;--color-white:#ffffff;--color-light:#f9f9f9;--color-border:#e5e7eb;--font-family-heading:"Poppins",sans-serif;--font-family-body:"Inter",sans-serif;}'
    + '*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}'
    + 'body{font-family:var(--font-family-body);line-height:1.6;color:var(--color-slate-800);background-color:var(--color-white);}'
    + '.container{width:90%;max-width:900px;margin:0 auto;padding:3rem 0;}'
    + '.article-header{margin-bottom:2rem;text-align:center;}'
    + 'h1{font-family:var(--font-family-heading);font-size:clamp(2rem,5vw,3rem);color:var(--color-slate-900);margin-bottom:1rem;line-height:1.2;}'
    + '.article-meta{display:flex;flex-wrap:wrap;justify-content:center;gap:1rem;font-size:0.875rem;color:var(--color-slate-500);margin-bottom:1.5rem;}'
    + '.article-meta span{display:flex;align-items:center;gap:0.5rem;}'
    + '.article-meta i{color:var(--color-primary-base);}'
    + '.article-categories{display:flex;flex-wrap:wrap;justify-content:center;gap:0.5rem;margin-bottom:2rem;}'
    + '.featured-image{width:100%;max-height:500px;object-fit:cover;border-radius:0.75rem;margin-bottom:2rem;}'
    + '.article-content{font-size:1.125rem;line-height:1.8;}'
    + '.article-content h2{font-family:var(--font-family-heading);font-size:1.875rem;color:var(--color-slate-900);margin-top:2rem;margin-bottom:1rem;}'
    + '.article-content h3{font-family:var(--font-family-heading);font-size:1.5rem;color:var(--color-slate-900);margin-top:1.5rem;margin-bottom:1rem;}'
    + '.article-content p{margin-bottom:1rem;}'
    + '.article-content ul,.article-content ol{margin-bottom:1rem;padding-left:2rem;}'
    + '.article-content li{margin-bottom:0.5rem;}'
    + '.article-content a{color:var(--color-primary-base);text-decoration:none;border-bottom:1px dashed var(--color-primary-base);}'
    + '.article-content a:hover{color:var(--color-accent-magenta);border-color:var(--color-accent-magenta);}'
    + '</style></head><body><div class="container">'
    + '<article><header class="article-header">'
    + '<h1>' + title + '</h1>'
    + '<div class="article-meta">'
    + '<span><i class="fas fa-calendar"></i> ' + formattedDate + '</span>'
    + (formattedUpdated ? '<span><i class="fas fa-clock"></i> Updated: ' + formattedUpdated + '</span>' : '')
    + '<span><i class="fas fa-book-open"></i> ' + timeToRead + ' min read</span>'
    + '</div>'
    + (categoryPills ? '<div class="article-categories">' + categoryPills + '</div>' : '')
    + '</header>'
    + (featuredImage ? '<img src="' + featuredImage + '" alt="' + title + '" class="featured-image" onerror="this.style.display=\'none\'">' : '')
    + '<div class="article-content">' + articleContent + '</div>'
    + '</article></div></body></html>';

  var container = document.getElementById('articlePreviewContainer');
  var frame = document.getElementById('articlePreviewFrame');
  container.style.display = 'block';

  var doc = frame.contentDocument || frame.contentWindow.document;
  doc.open();
  doc.write(previewHTML);
  doc.close();

  document.getElementById('openPreviewNewTabBtn').style.display = 'inline-flex';

  // Store for new tab opening
  window._lastPreviewHTML = previewHTML;
}

function openPreviewInNewTab() {
  if (!window._lastPreviewHTML) return;
  var blob = new Blob([window._lastPreviewHTML], { type: 'text/html' });
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}

// ==================== GITHUB PUBLISHING ====================
function initGitHubSettings() {
  // Load saved settings from localStorage
  var savedToken = localStorage.getItem('wts_gh_token') || '';
  var savedRepo = localStorage.getItem('wts_gh_repo') || 'laurentlaboise/marketing';
  var savedBranch = localStorage.getItem('wts_gh_branch') || 'main';

  var tokenEl = document.getElementById('gh_token');
  var repoEl = document.getElementById('gh_repo');
  var branchEl = document.getElementById('gh_branch');

  if (tokenEl && savedToken) tokenEl.value = savedToken;
  if (repoEl) repoEl.value = savedRepo;
  if (branchEl) branchEl.value = savedBranch;

  updateGhFilePath();
}

function updateGhFilePath() {
  var title = document.getElementById('title').value || '';
  var slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  var pathEl = document.getElementById('gh_path');
  if (pathEl) pathEl.value = slug ? 'en/articles/' + slug + '.html' : '';
}

function saveGhSettings() {
  localStorage.setItem('wts_gh_token', document.getElementById('gh_token').value);
  localStorage.setItem('wts_gh_repo', document.getElementById('gh_repo').value);
  localStorage.setItem('wts_gh_branch', document.getElementById('gh_branch').value);

  var statusEl = document.getElementById('ghConnectionStatus');
  statusEl.style.display = 'block';
  statusEl.innerHTML = '<div style="padding: 8px 12px; background: #d4edda; border: 1px solid #28a745; border-radius: 6px; font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> Settings saved to browser storage.</div>';
  setTimeout(function() { statusEl.style.display = 'none'; }, 3000);
}

function testGhConnection() {
  var token = document.getElementById('gh_token').value;
  var repo = document.getElementById('gh_repo').value;
  var statusEl = document.getElementById('ghConnectionStatus');

  if (!token) {
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div style="padding: 8px 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> Please enter a GitHub Personal Access Token.</div>';
    return;
  }

  statusEl.style.display = 'block';
  statusEl.innerHTML = '<div style="padding: 8px 12px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; font-size: 13px; color: var(--primary);"><i class="fas fa-spinner fa-spin"></i> Testing connection...</div>';

  fetch('https://api.github.com/repos/' + repo, {
    headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github.v3+json' }
  })
  .then(function(r) {
    if (r.ok) return r.json();
    throw new Error('HTTP ' + r.status);
  })
  .then(function(data) {
    statusEl.innerHTML = '<div style="padding: 8px 12px; background: #d4edda; border: 1px solid #28a745; border-radius: 6px; font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> Connected to <strong>' + data.full_name + '</strong>. Permissions: ' + (data.permissions && data.permissions.push ? 'Write' : 'Read-only') + '.</div>';
  })
  .catch(function(err) {
    statusEl.innerHTML = '<div style="padding: 8px 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> Connection failed: ' + err.message + '</div>';
  });
}

function generateFullArticleHTML() {
  var title = document.getElementById('title').value || 'Untitled Article';
  var slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  var seoTitle = document.getElementById('seo_title').value || title;
  var seoDesc = document.getElementById('seo_description').value || document.getElementById('excerpt').value || title;
  var featuredImage = document.getElementById('featured_image').value || '';
  var canonicalUrl = document.getElementById('canonical_url').value || ('https://wordsthatsells.website/en/articles/' + slug + '.html');
  var robotsMeta = document.getElementById('robots_meta').value || 'index, follow';
  var ogTitle = document.getElementById('og_title').value || seoTitle;
  var ogDesc = document.getElementById('og_description').value || seoDesc;
  var ogImage = document.getElementById('og_image').value || featuredImage;
  var ogType = document.getElementById('og_type').value || 'article';
  var twCard = document.getElementById('twitter_card').value || 'summary_large_image';
  var twTitle = document.getElementById('twitter_title').value || ogTitle;
  var twDesc = document.getElementById('twitter_description').value || ogDesc;
  var twImage = document.getElementById('twitter_image').value || ogImage;
  var twSite = document.getElementById('twitter_site').value || '';
  var twCreator = document.getElementById('twitter_creator').value || '';
  var publishedAt = document.getElementById('published_at').value || new Date().toISOString();
  var updatedAt = document.getElementById('updated_at').value || '';
  var timeToRead = document.getElementById('time_to_read').value || '';
  var category = document.getElementById('category').value || '';
  var tags = (document.getElementById('tags').value || '').split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; });
  var textArticle = document.getElementById('text_article').value || document.getElementById('content').value || '';

  // Calculate reading time if not set
  if (!timeToRead) {
    var textContent = textArticle.replace(/<[^>]*>/g, ' ');
    var words = textContent.split(/\s+/).filter(function(w) { return w.length > 0; });
    timeToRead = Math.max(1, Math.ceil(words.length / 200));
  }

  var publishedISO = new Date(publishedAt).toISOString();
  var updatedISO = updatedAt ? new Date(updatedAt).toISOString() : '';
  var articleUrl = canonicalUrl;
  var formattedDate = new Date(publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  var formattedUpdated = updatedAt ? new Date(updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';

  // Detect if content is plain text and wrap in paragraphs
  var articleContent = textArticle;
  if (articleContent && !/<[a-z][\s\S]*>/i.test(articleContent)) {
    articleContent = articleContent.split(/\n\n+/).map(function(p) {
      return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
    }).join('\n');
  }

  // Build Schema.org JSON-LD
  var schemaCustom = document.getElementById('schema_markup').value.trim();
  var schemaJSON;
  if (schemaCustom) {
    try { schemaJSON = schemaCustom; } catch(e) { schemaJSON = ''; }
  }
  if (!schemaJSON) {
    var schemaObj = {
      "@context": "https://schema.org",
      "@graph": [{
        "@type": "Article",
        "@id": articleUrl + "#article",
        "headline": title,
        "description": seoDesc,
        "datePublished": publishedISO,
        "author": { "@type": "Organization", "name": "Words That Sells", "url": "https://wordsthatsells.website" },
        "publisher": { "@type": "Organization", "name": "Words That Sells", "logo": { "@type": "ImageObject", "url": "https://wordsthatsells.website/assets/images/logo.png" } },
        "mainEntityOfPage": { "@type": "WebPage", "@id": articleUrl }
      }, {
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://wordsthatsells.website" },
          { "@type": "ListItem", "position": 2, "name": "Articles", "item": "https://wordsthatsells.website/en/articles/" },
          { "@type": "ListItem", "position": 3, "name": title }
        ]
      }]
    };
    if (updatedISO) schemaObj["@graph"][0].dateModified = updatedISO;
    if (ogImage) schemaObj["@graph"][0].image = ogImage;
    if (category) schemaObj["@graph"][0].articleSection = category;
    if (timeToRead) schemaObj["@graph"][0].timeRequired = "PT" + timeToRead + "M";
    schemaJSON = JSON.stringify(schemaObj, null, 2);
  }

  // Build category pills
  var categories = [];
  if (category) categories.push(category.charAt(0).toUpperCase() + category.slice(1));
  tags.forEach(function(t) { categories.push(t); });

  var html = '<!DOCTYPE html>\n<html lang="en">\n<head>\n'
    + '    <meta charset="UTF-8">\n'
    + '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n'
    + '    <title>' + escapeHTMLForAttr(title) + ' | WordsThatSells.Website</title>\n\n'
    + '    <!-- Favicon -->\n'
    + '    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">\n'
    + '    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">\n'
    + '    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">\n'
    + '    <link rel="shortcut icon" href="/favicon/favicon.ico">\n\n'
    + '    <!-- SEO Meta Tags -->\n'
    + '    <meta name="description" content="' + escapeHTMLForAttr(seoDesc) + '">\n'
    + '    <meta name="robots" content="' + robotsMeta + '">\n'
    + '    <link rel="canonical" href="' + articleUrl + '">\n\n'
    + '    <!-- Open Graph / Facebook / LinkedIn / WhatsApp -->\n'
    + '    <meta property="og:site_name" content="WordsThatSells.Website">\n'
    + '    <meta property="og:type" content="' + ogType + '">\n'
    + '    <meta property="og:title" content="' + escapeHTMLForAttr(ogTitle) + '">\n'
    + '    <meta property="og:description" content="' + escapeHTMLForAttr(ogDesc) + '">\n'
    + (ogImage ? '    <meta property="og:image" content="' + ogImage + '">\n    <meta property="og:image:width" content="1200">\n    <meta property="og:image:height" content="630">\n' : '')
    + '    <meta property="og:url" content="' + articleUrl + '">\n'
    + '    <meta property="article:published_time" content="' + publishedISO + '">\n'
    + (updatedISO ? '    <meta property="article:modified_time" content="' + updatedISO + '">\n' : '')
    + '    <meta property="article:author" content="WordsThatSells.Website">\n'
    + tags.map(function(t) { return '    <meta property="article:tag" content="' + escapeHTMLForAttr(t) + '">'; }).join('\n') + '\n\n'
    + '    <!-- Twitter / X Card -->\n'
    + '    <meta name="twitter:card" content="' + twCard + '">\n'
    + (twSite ? '    <meta name="twitter:site" content="' + escapeHTMLForAttr(twSite) + '">\n' : '')
    + (twCreator ? '    <meta name="twitter:creator" content="' + escapeHTMLForAttr(twCreator) + '">\n' : '')
    + '    <meta name="twitter:title" content="' + escapeHTMLForAttr(twTitle) + '">\n'
    + '    <meta name="twitter:description" content="' + escapeHTMLForAttr(twDesc) + '">\n'
    + (twImage ? '    <meta name="twitter:image" content="' + twImage + '">\n' : '')
    + '\n    <!-- Schema.org JSON-LD -->\n'
    + '    <script type="application/ld+json">\n' + schemaJSON + '\n    <\/script>\n\n'
    + '    <!-- Fonts and Icons -->\n'
    + '    <script src="https://kit.fontawesome.com/a521ce00f6.js" crossorigin="anonymous"><\/script>\n'
    + '    <link rel="preconnect" href="https://fonts.googleapis.com">\n'
    + '    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n'
    + '    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">\n\n'
    + '    <style>\n'
    + '        :root {\n'
    + '            --color-primary-base: #1f85c9;\n'
    + '            --color-accent-magenta: #d62b83;\n'
    + '            --color-slate-900: #122a3f;\n'
    + '            --color-slate-800: #154266;\n'
    + '            --color-slate-500: #64748b;\n'
    + '            --color-white: #ffffff;\n'
    + '            --color-light: #f9f9f9;\n'
    + '            --color-border: #e5e7eb;\n'
    + '            --font-family-heading: \'Poppins\', sans-serif;\n'
    + '            --font-family-body: \'Inter\', sans-serif;\n'
    + '        }\n'
    + '        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }\n'
    + '        body { font-family: var(--font-family-body); line-height: 1.6; color: var(--color-slate-800); background-color: var(--color-white); }\n'
    + '        .container { width: 90%; max-width: 900px; margin: 0 auto; padding: 4rem 0; }\n'
    + '        .article-header { margin-bottom: 3rem; text-align: center; }\n'
    + '        h1 { font-family: var(--font-family-heading); font-size: clamp(2rem, 5vw, 3rem); color: var(--color-slate-900); margin-bottom: 1rem; line-height: 1.2; }\n'
    + '        .article-meta { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; font-size: 0.875rem; color: var(--color-slate-500); margin-bottom: 1.5rem; }\n'
    + '        .article-meta span { display: flex; align-items: center; gap: 0.5rem; }\n'
    + '        .article-meta i { color: var(--color-primary-base); }\n'
    + '        .article-categories { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; }\n'
    + '        .category-pill { background-color: var(--color-slate-500); color: var(--color-white); padding: 4px 12px; border-radius: 999px; font-size: 0.875rem; font-weight: 500; }\n'
    + '        .featured-image { width: 100%; max-height: 500px; object-fit: cover; border-radius: 0.75rem; margin-bottom: 3rem; }\n'
    + '        .article-content { font-size: 1.125rem; line-height: 1.8; }\n'
    + '        .article-content h2 { font-family: var(--font-family-heading); font-size: 1.875rem; color: var(--color-slate-900); margin-top: 3rem; margin-bottom: 1rem; }\n'
    + '        .article-content h3 { font-family: var(--font-family-heading); font-size: 1.5rem; color: var(--color-slate-900); margin-top: 2rem; margin-bottom: 1rem; }\n'
    + '        .article-content p { margin-bottom: 1rem; }\n'
    + '        .article-content ul, .article-content ol { margin-bottom: 1rem; padding-left: 2rem; }\n'
    + '        .article-content li { margin-bottom: 0.5rem; }\n'
    + '        .article-content img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1.5rem 0; }\n'
    + '        .article-content a { color: var(--color-primary-base); text-decoration: none; border-bottom: 1px dashed var(--color-primary-base); }\n'
    + '        .article-content a:hover { color: var(--color-accent-magenta); border-color: var(--color-accent-magenta); }\n'
    + '        .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--color-primary-base); text-decoration: none; font-weight: 500; margin-bottom: 2rem; transition: color 0.2s; }\n'
    + '        .back-link:hover { color: var(--color-accent-magenta); }\n'
    + '        .share-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--color-border); justify-content: center; }\n'
    + '        .share-buttons a { background-color: #e5e7eb; color: #4e555b; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; text-decoration: none; }\n'
    + '        .share-buttons a:hover { color: var(--color-white); }\n'
    + '        .share-buttons .share-x:hover { background-color: #000; }\n'
    + '        .share-buttons .share-linkedin:hover { background-color: #0077b5; }\n'
    + '        .share-buttons .share-facebook:hover { background-color: #3b5998; }\n'
    + '        .share-buttons .share-whatsapp:hover { background-color: #25d366; }\n'
    + '        .share-buttons .share-copy:hover { background-color: var(--color-primary-base); }\n'
    + '        .back-to-top { position: fixed; bottom: 20px; right: 20px; background-color: var(--color-accent-magenta); color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; z-index: 1000; transition: background-color 0.3s, transform 0.3s, opacity 0.3s; display: flex; justify-content: center; align-items: center; font-size: 24px; opacity: 0; transform: translateY(20px); pointer-events: none; text-decoration: none; }\n'
    + '        .back-to-top.show { opacity: 1; transform: translateY(0); pointer-events: auto; }\n'
    + '        .back-to-top:hover { background-color: #f90784; color: white; }\n'
    + '        @media (max-width: 768px) { .container { width: 95%; padding: 2rem 0; } h1 { font-size: 2rem; } .article-content { font-size: 1rem; } }\n'
    + '    </style>\n'
    + '    <!-- Google tag (gtag.js) -->\n'
    + '    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LMRKC1VBBB"><\/script>\n'
    + '    <script>\n'
    + '      window.dataLayer = window.dataLayer || [];\n'
    + '      function gtag(){dataLayer.push(arguments);}\n'
    + '      gtag(\'js\', new Date());\n'
    + '      gtag(\'config\', \'G-LMRKC1VBBB\');\n'
    + '    <\/script>\n'
    + '</head>\n<body>\n'
    + '    <div class="container">\n'
    + '        <a href="../resources/articles/" class="back-link">\n'
    + '            <i class="fas fa-arrow-left"></i> Back to All Articles\n'
    + '        </a>\n\n'
    + '        <article>\n'
    + '            <header class="article-header">\n'
    + '                <h1>' + title + '</h1>\n\n'
    + '                <div class="article-meta">\n'
    + '                    <span><i class="fas fa-calendar"></i> <time datetime="' + publishedISO + '">' + formattedDate + '</time></span>\n'
    + (formattedUpdated ? '                    <span><i class="fas fa-clock"></i> Updated: <time datetime="' + updatedISO + '">' + formattedUpdated + '</time></span>\n' : '')
    + '                    <span><i class="fas fa-book-open"></i> ' + timeToRead + ' min read</span>\n'
    + '                </div>\n\n'
    + (categories.length > 0 ? '                <div class="article-categories">\n' + categories.map(function(c) { return '                    <span class="category-pill">' + c + '</span>'; }).join('\n') + '\n                </div>\n' : '')
    + '            </header>\n\n'
    + (featuredImage ? '            <img src="' + featuredImage + '" alt="' + escapeHTMLForAttr(title) + '" class="featured-image" onerror="this.style.display=\'none\'">\n\n' : '')
    + '            <div class="article-content">\n                ' + articleContent + '\n            </div>\n\n'
    + '            <div class="share-buttons">\n'
    + '                <a href="#" class="share-btn share-x" data-platform="x" title="Share on X (Twitter)"><i class="fab fa-twitter"></i></a>\n'
    + '                <a href="#" class="share-btn share-linkedin" data-platform="linkedin" title="Share on LinkedIn"><i class="fab fa-linkedin-in"></i></a>\n'
    + '                <a href="#" class="share-btn share-facebook" data-platform="facebook" title="Share on Facebook"><i class="fab fa-facebook-f"></i></a>\n'
    + '                <a href="#" class="share-btn share-whatsapp" data-platform="whatsapp" title="Share on WhatsApp"><i class="fab fa-whatsapp"></i></a>\n'
    + '                <a href="#" class="share-btn share-copy" data-platform="copy" title="Copy Link"><i class="fas fa-link"></i></a>\n'
    + '            </div>\n'
    + '        </article>\n'
    + '    </div>\n\n'
    + '    <a href="#" class="back-to-top" id="back-to-top"><i class="fas fa-chevron-up"></i></a>\n\n'
    + '    <script>\n'
    + '        var ARTICLE_URL = \'' + articleUrl + '\';\n'
    + '        var ARTICLE_TITLE = ' + JSON.stringify(title) + ';\n'
    + '        var ARTICLE_DESCRIPTION = ' + JSON.stringify(seoDesc) + ';\n'
    + '        var ARTICLE_IMAGE = \'' + ogImage + '\';\n\n'
    + '        function sharePost(platform, title, url, description, imageUrl) {\n'
    + '            var shareUrl = \'\';\n'
    + '            var encodedUrl = encodeURIComponent(url);\n'
    + '            var shareText = title + (description ? \' - \' + description : \'\');\n'
    + '            var encodedShareText = encodeURIComponent(shareText);\n'
    + '            switch (platform) {\n'
    + '                case \'x\': shareUrl = \'https://twitter.com/intent/tweet?text=\' + encodedShareText + \'&url=\' + encodedUrl; break;\n'
    + '                case \'linkedin\': shareUrl = \'https://www.linkedin.com/sharing/share-offsite/?url=\' + encodedUrl; break;\n'
    + '                case \'facebook\': shareUrl = \'https://www.facebook.com/sharer/sharer.php?u=\' + encodedUrl; break;\n'
    + '                case \'whatsapp\': shareUrl = \'https://api.whatsapp.com/send?text=\' + encodedShareText + \'%20\' + encodedUrl; break;\n'
    + '                case \'copy\': navigator.clipboard ? navigator.clipboard.writeText(url).then(function() { alert(\'Link copied!\'); }) : alert(url); return;\n'
    + '            }\n'
    + '            if (shareUrl) window.open(shareUrl, \'_blank\', \'width=600,height=400\');\n'
    + '        }\n'
    + '        document.addEventListener(\'DOMContentLoaded\', function() {\n'
    + '            document.querySelectorAll(\'.share-btn\').forEach(function(btn) {\n'
    + '                btn.addEventListener(\'click\', function(e) { e.preventDefault(); sharePost(btn.dataset.platform, ARTICLE_TITLE, ARTICLE_URL, ARTICLE_DESCRIPTION, ARTICLE_IMAGE); });\n'
    + '            });\n'
    + '            var btt = document.querySelector(\'.back-to-top\');\n'
    + '            window.addEventListener(\'scroll\', function() { if (btt) { if (window.scrollY > 300) btt.classList.add(\'show\'); else btt.classList.remove(\'show\'); } });\n'
    + '            if (btt) btt.addEventListener(\'click\', function(e) { e.preventDefault(); window.scrollTo({ top: 0, behavior: \'smooth\' }); });\n'
    + '        });\n'
    + '    <\/script>\n'
    + '    <script src="/js/services/page-sidebar.js"><\/script>\n'
    + '</body>\n</html>';

  return html;
}

function escapeHTMLForAttr(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

function publishToGitHub() {
  var token = document.getElementById('gh_token').value || localStorage.getItem('wts_gh_token');
  var repo = document.getElementById('gh_repo').value;
  var branch = document.getElementById('gh_branch').value;
  var filePath = document.getElementById('gh_path').value;

  var progressEl = document.getElementById('publishProgress');
  var progressFill = document.getElementById('publishProgressFill');
  var progressText = document.getElementById('publishProgressText');
  var resultEl = document.getElementById('publishResult');

  if (!token) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = '<div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> GitHub Personal Access Token is required. Enter it in the GitHub Settings above.</div>';
    return;
  }
  if (!filePath) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = '<div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> Article title is required to generate file path.</div>';
    return;
  }

  var title = document.getElementById('title').value || 'Untitled';

  // Use HTML Article Page code if provided, otherwise generate from form fields
  progressEl.style.display = 'block';
  resultEl.style.display = 'none';
  progressFill.style.width = '10%';
  progressText.textContent = 'Generating article HTML...';

  var articleHTML;
  try {
    var articleCode = (document.getElementById('article_code').value || '').trim();
    articleHTML = articleCode || generateFullArticleHTML();
  } catch(e) {
    progressEl.style.display = 'none';
    resultEl.style.display = 'block';

    // Clear any existing content
    resultEl.textContent = '';

    // Build error message safely without using innerHTML
    var errorWrapper = document.createElement('div');
    errorWrapper.style.padding = '12px';
    errorWrapper.style.background = '#f8d7da';
    errorWrapper.style.border = '1px solid #dc3545';
    errorWrapper.style.borderRadius = '6px';
    errorWrapper.style.fontSize = '13px';
    errorWrapper.style.color = '#721c24';

    var errorIcon = document.createElement('i');
    errorIcon.className = 'fas fa-times-circle';
    errorWrapper.appendChild(errorIcon);

    errorWrapper.appendChild(document.createTextNode(' Failed to generate HTML: ' + e.message));

    resultEl.appendChild(errorWrapper);
    return;
  }

  progressFill.style.width = '30%';
  progressText.textContent = 'Checking for existing file...';

  var apiBase = 'https://api.github.com/repos/' + repo + '/contents/' + filePath;
  var headers = {
    'Authorization': 'Bearer ' + token,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
  };

  // Check if file exists (to get SHA for update)
  fetch(apiBase + '?ref=' + branch, { headers: headers })
    .then(function(r) {
      if (r.ok) return r.json();
      if (r.status === 404) return null;
      throw new Error('GitHub API error: HTTP ' + r.status);
    })
    .then(function(existing) {
      progressFill.style.width = '50%';
      progressText.textContent = 'Pushing to GitHub...';

      var content = btoa(unescape(encodeURIComponent(articleHTML)));
      var body = {
        message: (existing ? 'Update' : 'Add') + ' article: ' + title,
        content: content,
        branch: branch
      };

      if (existing && existing.sha) {
        body.sha = existing.sha;
      }

      return fetch(apiBase, {
        method: 'PUT',
        headers: headers,
        body: JSON.stringify(body)
      });
    })
    .then(function(r) {
      if (!r.ok) {
        return r.json().then(function(err) {
          throw new Error(err.message || 'HTTP ' + r.status);
        });
      }
      return r.json();
    })
    .then(function(data) {
      progressFill.style.width = '80%';
      progressText.textContent = 'Triggering GitHub Pages rebuild...';

      // GitHub Pages auto-rebuilds on push, show success
      setTimeout(function() {
        progressFill.style.width = '100%';
        progressText.textContent = 'Published successfully!';

        var publishedUrl = 'https://wordsthatsells.website/' + filePath;
        var githubUrl = 'https://github.com/' + repo + '/blob/' + branch + '/' + filePath;

        // Also update published_url field
        var pubUrlField = document.getElementById('published_url');
        if (pubUrlField && !pubUrlField.value) {
          pubUrlField.value = publishedUrl;
          formDirty = true;
          document.getElementById('unsavedBadge').style.display = 'inline-flex';
        }

        resultEl.style.display = 'block';

        // Clear any existing content
        resultEl.textContent = '';

        // Build success message safely without using innerHTML
        var successWrapper = document.createElement('div');
        successWrapper.style.padding = '16px';
        successWrapper.style.background = '#d4edda';
        successWrapper.style.border = '1px solid #28a745';
        successWrapper.style.borderRadius = '8px';
        successWrapper.style.fontSize = '13px';
        successWrapper.style.color = '#155724';

        var titleDiv = document.createElement('div');
        titleDiv.style.fontSize = '16px';
        titleDiv.style.fontWeight = '600';
        titleDiv.style.marginBottom = '8px';

        var successIcon = document.createElement('i');
        successIcon.className = 'fas fa-check-circle';
        titleDiv.appendChild(successIcon);
        titleDiv.appendChild(document.createTextNode(' Article Published Successfully!'));

        var liveUrlDiv = document.createElement('div');
        liveUrlDiv.style.marginBottom = '8px';
        var liveStrong = document.createElement('strong');
        liveStrong.textContent = 'Live URL:';
        liveUrlDiv.appendChild(liveStrong);
        liveUrlDiv.appendChild(document.createTextNode(' '));
        var liveLink = document.createElement('a');
        liveLink.href = publishedUrl;
        liveLink.target = '_blank';
        liveLink.style.color = '#155724';
        liveLink.style.textDecoration = 'underline';
        liveLink.textContent = publishedUrl;
        liveUrlDiv.appendChild(liveLink);

        var githubDiv = document.createElement('div');
        githubDiv.style.marginBottom = '8px';
        var ghStrong = document.createElement('strong');
        ghStrong.textContent = 'GitHub:';
        githubDiv.appendChild(ghStrong);
        githubDiv.appendChild(document.createTextNode(' '));
        var ghLink = document.createElement('a');
        ghLink.href = githubUrl;
        ghLink.target = '_blank';
        ghLink.style.color = '#155724';
        ghLink.style.textDecoration = 'underline';
        ghLink.textContent = 'View on GitHub';
        githubDiv.appendChild(ghLink);

        var noteDiv = document.createElement('div');
        noteDiv.style.fontSize = '12px';
        noteDiv.style.color = '#6c757d';
        noteDiv.textContent = 'Note: GitHub Pages may take 1-2 minutes to rebuild. The article URL will be live after deployment completes.';

        successWrapper.appendChild(titleDiv);
        successWrapper.appendChild(liveUrlDiv);
        successWrapper.appendChild(githubDiv);
        successWrapper.appendChild(noteDiv);

        resultEl.appendChild(successWrapper);
      }, 1000);
    })
    .catch(function(err) {
      progressFill.style.width = '0%';
      progressEl.style.display = 'none';
      resultEl.style.display = 'block';

      // Clear any existing content
      resultEl.textContent = '';

      // Build error message safely without using innerHTML
      var publishErrorWrapper = document.createElement('div');
      publishErrorWrapper.style.padding = '12px';
      publishErrorWrapper.style.background = '#f8d7da';
      publishErrorWrapper.style.border = '1px solid #dc3545';
      publishErrorWrapper.style.borderRadius = '6px';
      publishErrorWrapper.style.fontSize = '13px';
      publishErrorWrapper.style.color = '#721c24';

      var publishErrorIcon = document.createElement('i');
      publishErrorIcon.className = 'fas fa-times-circle';
      publishErrorWrapper.appendChild(publishErrorIcon);

      publishErrorWrapper.appendChild(document.createTextNode(' Publish failed: ' + err.message));

      resultEl.appendChild(publishErrorWrapper);
    });
}

// ==================== PUBLISH TAB INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  initGitHubSettings();

  // Update file path when title changes
  var titleEl = document.getElementById('title');
  if (titleEl) titleEl.addEventListener('input', function() { updateGhFilePath(); });

  // Bind Publish tab buttons
  function bind(id, fn) { var el = document.getElementById(id); if (el) el.addEventListener('click', fn); }

  // Content tab auto-hyperlink buttons
  bind('autoHyperlinkContentBtn', function() { autoHyperlinkField('content', 'hyperlinkStatus'); });
  bind('autoHyperlinkTextBtn', function() { autoHyperlinkField('text_article', 'hyperlinkStatus'); });

  // Calculate reading time
  bind('calcReadTimeBtn', function() { calcReadingTime(); });

  // Publish tab buttons
  bind('pubAutoHyperlinkBtn', function() { autoHyperlinkAll(); });
  bind('pubPreviewLinksBtn', function() {
    fetchLinkTerms(function(terms) {
      var content = document.getElementById('content').value || '';
      var textArticle = document.getElementById('text_article').value || '';
      var contentResult = hyperlinkContent(content, terms);
      var textResult = hyperlinkContent(textArticle, terms);
      var total = contentResult.count + textResult.count;
      var statusEl = document.getElementById('pubHyperlinkStatus');
      statusEl.style.display = 'block';
      statusEl.innerHTML = '<div style="padding: 10px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius, 6px); font-size: 13px; color: var(--primary);"><i class="fas fa-info-circle"></i> Preview: <strong>' + total + '</strong> terms would be linked (Sidemenu: ' + contentResult.count + ', Text Article: ' + textResult.count + '). Click "Auto-Hyperlink All Content" to apply.</div>';
    });
  });
  bind('pubUndoLinksBtn', function() { undoAutoLinks(); });

  // Preview
  bind('generatePreviewBtn', function() { generateArticlePreview(); });
  bind('openPreviewNewTabBtn', function() { openPreviewInNewTab(); });

  // GitHub settings
  bind('saveGhSettingsBtn', function() { saveGhSettings(); });
  bind('testGhConnectionBtn', function() { testGhConnection(); });
  bind('publishToGithubBtn', function() { publishToGitHub(); });
});

// ==================== ARTICLE AUDIO MANAGEMENT ====================
(function() {
  var LANG_LABELS = {
    en: 'English', lo: 'Lao', th: 'Thai', es: 'Spanish',
    fr: 'French', zh: 'Chinese', ja: 'Japanese', ko: 'Korean',
    vi: 'Vietnamese', km: 'Khmer', my: 'Burmese'
  };

  var hiddenInput   = document.getElementById('audio_files');
  var toggle        = document.getElementById('audioEnabledToggle');
  var panel         = document.getElementById('audioFieldsPanel');
  var rowsContainer = document.getElementById('audioLangRows');
  var addBtn        = document.getElementById('addAudioLangBtn');
  var langSelect    = document.getElementById('audioNewLangSelect');

  if (!hiddenInput || !toggle) return;

  // Parse stored value
  var audioData = {};
  try { audioData = JSON.parse(hiddenInput.value) || {}; } catch(e) { audioData = {}; }

  // Check if audio is enabled (has at least one key or _enabled flag)
  var isEnabled = audioData._enabled === true || Object.keys(audioData).filter(function(k){ return k !== '_enabled'; }).length > 0;
  toggle.checked = isEnabled;
  panel.style.display = isEnabled ? 'block' : 'none';

  toggle.addEventListener('change', function() {
    panel.style.display = toggle.checked ? 'block' : 'none';
    syncHiddenInput();
  });

  function createRow(langCode, url) {
    var row = document.createElement('div');
    row.style.cssText = 'display:flex; align-items:center; gap:8px; margin-bottom:8px;';
    row.dataset.lang = langCode;

    var label = document.createElement('span');
    label.style.cssText = 'min-width:80px; font-weight:600; font-size:13px; color:#555;';
    label.textContent = LANG_LABELS[langCode] || langCode;

    var input = document.createElement('input');
    input.type = 'url';
    input.className = 'form-input';
    input.placeholder = 'https://cdn.example.com/audio/article-' + langCode + '.mp3';
    input.value = url || '';
    input.style.cssText = 'flex:1; font-size:13px;';
    input.addEventListener('input', syncHiddenInput);

    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-sm';
    removeBtn.style.cssText = 'background:none; border:none; color:#dc3545; font-size:18px; cursor:pointer; padding:4px 8px;';
    removeBtn.innerHTML = '&times;';
    removeBtn.title = 'Remove ' + (LANG_LABELS[langCode] || langCode);
    removeBtn.addEventListener('click', function() {
      row.remove();
      syncHiddenInput();
      updateSelectOptions();
    });

    row.appendChild(label);
    row.appendChild(input);
    row.appendChild(removeBtn);
    rowsContainer.appendChild(row);
  }

  function syncHiddenInput() {
    var data = {};
    if (toggle.checked) {
      data._enabled = true;
      var rows = rowsContainer.querySelectorAll('[data-lang]');
      rows.forEach(function(row) {
        var code = row.dataset.lang;
        var val = row.querySelector('input[type="url"]').value.trim();
        if (val) data[code] = val;
      });
    }
    hiddenInput.value = JSON.stringify(data);
    // Trigger unsaved badge
    var badge = document.getElementById('unsavedBadge');
    if (badge) badge.style.display = 'inline-flex';
  }

  function updateSelectOptions() {
    var existing = [];
    rowsContainer.querySelectorAll('[data-lang]').forEach(function(r) { existing.push(r.dataset.lang); });
    var options = langSelect.querySelectorAll('option');
    options.forEach(function(opt) {
      if (opt.value) opt.disabled = existing.indexOf(opt.value) !== -1;
    });
    langSelect.value = '';
  }

  // Initialize rows from stored data
  Object.keys(audioData).forEach(function(key) {
    if (key === '_enabled') return;
    createRow(key, audioData[key]);
  });
  updateSelectOptions();

  // Add language button
  addBtn.addEventListener('click', function() {
    var code = langSelect.value;
    if (!code) return;
    createRow(code, '');
    syncHiddenInput();
    updateSelectOptions();
  });
})();
</script>

<%- include('../../partials/footer') %>
