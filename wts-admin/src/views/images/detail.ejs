<%- include('../partials/head', { title, bodyClass: 'dashboard-layout' }) %>

<%- include('../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title"><%= image.title || image.filename %></h1>
        <p class="page-subtitle">
          <a href="/images"><i class="fas fa-arrow-left"></i> Back to Image Library</a>
        </p>
      </div>
      <div class="page-actions">
        <a href="/images/<%= image.id %>/download" class="btn btn-secondary btn-sm">
          <i class="fas fa-download"></i> Download
        </a>
        <button class="btn btn-secondary btn-sm copy-cdn-url" data-url="<%= image.cdn_url %>">
          <i class="fas fa-link"></i> Copy CDN URL
        </button>
        <a href="<%= image.web_url %>" target="_blank" class="btn btn-secondary btn-sm">
          <i class="fas fa-external-link-alt"></i> View on Web
        </a>
      </div>
    </div>

    <div class="responsive-grid-2">
      <!-- Left: Image Preview & Info -->
      <div>
        <div class="card">
          <div class="card-body" style="text-align: center; background: var(--gray-50); padding: 20px;">
            <img
              src="<%= image.cdn_url || ('/images-serve/' + encodeURIComponent(image.filename) + '?path=' + encodeURIComponent(image.file_path)) %>"
              alt="<%= image.alt_text || image.filename %>"
              style="max-width: 100%; max-height: 500px; border-radius: var(--radius); object-fit: contain;">
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title">File Information</h2>
          </div>
          <div class="card-body" style="padding: 0;">
            <table class="table">
              <tbody>
                <tr><td style="font-weight: 600; width: 140px;">Filename</td><td><%= image.filename %></td></tr>
                <tr><td style="font-weight: 600;">Original Name</td><td><%= image.original_filename %></td></tr>
                <tr><td style="font-weight: 600;">File Size</td><td><%= image.file_size_formatted %></td></tr>
                <tr><td style="font-weight: 600;">Format</td><td><%= image.mime_type %></td></tr>
                <% if (image.width && image.height) { %>
                <tr><td style="font-weight: 600;">Dimensions</td><td><%= image.width %> &times; <%= image.height %> px</td></tr>
                <% } %>
                <tr><td style="font-weight: 600;">Category</td><td><span class="status-badge <%= image.category %>"><%= image.category %></span></td></tr>
                <tr><td style="font-weight: 600;">Folder</td><td><%= currentFolderName ? currentFolderName : '<span style="color:var(--gray-400);">None</span>' %></td></tr>
                <tr><td style="font-weight: 600;">File Path</td><td style="word-break: break-all;"><code><%= image.file_path %></code></td></tr>
                <tr><td style="font-weight: 600;">Uploaded</td><td><%= new Date(image.created_at).toLocaleDateString() %></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- URL Copy Section -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title">URLs</h2>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">jsDelivr CDN URL</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" value="<%= image.cdn_url %>" readonly id="cdnUrlField">
                <button class="btn btn-secondary btn-sm copy-cdn-url" data-url="<%= image.cdn_url %>" title="Copy">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Website URL</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" value="<%= image.web_url %>" readonly id="webUrlField">
                <button class="btn btn-secondary btn-sm copy-cdn-url" data-url="<%= image.web_url %>" title="Copy">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">HTML Image Tag</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" value='<img src="<%= image.cdn_url %>" alt="<%= (image.alt_text || '').replace(/"/g, '&quot;') %>"<%= image.width ? ' width="' + image.width + '"' : '' %><%= image.height ? ' height="' + image.height + '"' : '' %> loading="lazy" decoding="async">' readonly id="htmlTagField">
                <button class="btn btn-secondary btn-sm" id="copyHtmlBtn" title="Copy">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Rename -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title">Rename File</h2>
          </div>
          <div class="card-body">
            <form action="/images/<%= image.id %>/rename" method="POST">
              <div class="form-group">
                <label class="form-label" for="new_filename">New Filename</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="new_filename" name="new_filename" class="form-input" value="<%= image.filename.replace(/\.[^.]+$/, '') %>" placeholder="seo-friendly-filename">
                  <button type="submit" class="btn btn-secondary btn-sm">
                    <i class="fas fa-pen"></i> Rename
                  </button>
                </div>
                <p class="form-help">Use lowercase, hyphens, no spaces. Extension is preserved automatically.</p>
              </div>
            </form>
          </div>
        </div>

        <!-- Re-upload / Replace -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-redo"></i> Replace Image</h2>
          </div>
          <div class="card-body">
            <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
              Upload a new file to replace this image. All SEO metadata (alt text, title, description, tags) will be preserved. The CDN URL stays the same.
            </p>
            <form action="/images/<%= image.id %>/reupload" method="POST" enctype="multipart/form-data" id="reuploadForm">
              <div class="form-group">
                <div id="reuploadDropzone" style="border: 2px dashed var(--gray-300); border-radius: var(--radius); padding: 24px; text-align: center; cursor: pointer; transition: border-color 0.2s;">
                  <input type="file" id="reuploadFile" name="image" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml,image/avif" required style="display: none;">
                  <div id="reuploadContent">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 28px; color: var(--gray-400); margin-bottom: 8px;"></i>
                    <p style="font-size: 14px; color: var(--gray-600);">Drop new image here or <span style="color: var(--primary); cursor: pointer;">browse</span></p>
                  </div>
                  <div id="reuploadPreview" style="display: none;">
                    <img id="reuploadPreviewImg" src="" alt="Preview" style="max-height: 120px; border-radius: var(--radius); margin-bottom: 8px;">
                    <p id="reuploadPreviewName" style="font-size: 13px; font-weight: 500;"></p>
                    <p id="reuploadPreviewSize" style="font-size: 12px; color: var(--gray-500);"></p>
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <label class="form-checkbox" style="margin: 0;">
                  <input type="checkbox" name="optimize" value="on" checked>
                  <span style="font-size: 13px;">Optimize (WebP)</span>
                </label>
                <button type="submit" class="btn btn-primary btn-sm" id="reuploadBtn" disabled>
                  <i class="fas fa-redo"></i> Replace Image
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Image Optimizer -->
        <% if (image.mime_type !== 'image/svg+xml') { %>
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-compress-arrows-alt"></i> Optimize Image</h2>
          </div>
          <div class="card-body">
            <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
              Convert format, adjust quality, or resize to reduce file size. The optimized file replaces the current one and is pushed to CDN.
            </p>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="opt_format">Output Format</label>
                <select id="opt_format" class="form-input" onchange="previewOptimization()">
                  <option value="webp" <%= image.mime_type === 'image/webp' ? 'selected' : '' %>>WebP (recommended)</option>
                  <option value="avif">AVIF (smallest, slower)</option>
                  <option value="jpeg" <%= image.mime_type === 'image/jpeg' ? 'selected' : '' %>>JPEG (MozJPEG)</option>
                  <option value="png" <%= image.mime_type === 'image/png' ? 'selected' : '' %>>PNG (lossless)</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="opt_quality">Quality: <span id="qualityValue">82</span>%</label>
                <input type="range" id="opt_quality" min="1" max="100" value="82" class="form-input" style="padding: 4px 0;" oninput="document.getElementById('qualityValue').textContent=this.value" onchange="previewOptimization()">
                <p class="form-help">Lower = smaller file. 60-85 is ideal for web.</p>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="opt_max_width">Max Width (px)</label>
                <input type="number" id="opt_max_width" class="form-input" placeholder="<%= image.width || 'auto' %>" min="1" onchange="previewOptimization()">
                <p class="form-help">Leave empty to keep original</p>
              </div>
              <div class="form-group">
                <label class="form-label" for="opt_max_height">Max Height (px)</label>
                <input type="number" id="opt_max_height" class="form-input" placeholder="<%= image.height || 'auto' %>" min="1" onchange="previewOptimization()">
                <p class="form-help">Leave empty to keep original</p>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="opt_fit">Resize Fit</label>
              <select id="opt_fit" class="form-input" onchange="previewOptimization()">
                <option value="inside">Inside (fit within bounds)</option>
                <option value="cover">Cover (fill & crop)</option>
                <option value="contain">Contain (fit with padding)</option>
                <option value="fill">Fill (stretch)</option>
              </select>
            </div>

            <!-- Preview Result -->
            <div id="optimizePreview" style="display: none; margin: 16px 0; padding: 14px; border-radius: var(--radius); border: 1px solid var(--gray-200); background: var(--gray-50);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <p style="font-size: 13px; color: var(--gray-600);">Estimated result:</p>
                  <p style="font-weight: 600; font-size: 15px;">
                    <span id="previewOriginalSize">-</span> &rarr; <span id="previewNewSize" style="color: var(--success);">-</span>
                  </p>
                </div>
                <div id="previewSavings" style="text-align: right;">
                  <p style="font-size: 24px; font-weight: 700; color: var(--success);" id="previewSavingsPct">-</p>
                  <p style="font-size: 12px; color: var(--gray-500);">smaller</p>
                </div>
              </div>
            </div>
            <div id="optimizePreviewLoading" style="display: none; text-align: center; padding: 12px; color: var(--gray-500); font-size: 13px;">
              <i class="fas fa-spinner fa-spin"></i> Calculating...
            </div>

            <div style="display: flex; gap: 8px; align-items: center;">
              <button type="button" id="optimizeBtn" class="btn btn-primary btn-sm" onclick="runOptimization()">
                <i class="fas fa-compress-arrows-alt"></i> Optimize Now
              </button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="previewOptimization()">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>

            <!-- Optimize Status -->
            <div id="optimizeStatus" style="display: none; margin-top: 12px;"></div>
          </div>
        </div>
        <% } %>

        <!-- Delete -->
        <div class="card" style="margin-top: 20px; border: 1px solid var(--danger);">
          <div class="card-body delete-card-body">
            <div>
              <p style="font-weight: 600; color: var(--danger);">Archive this image</p>
              <p class="form-help">Removes from library. The file remains on disk.</p>
            </div>
            <form action="/images/<%= image.id %>/delete" method="POST">
              <button type="submit" class="btn btn-sm btn-danger" data-confirm-delete="Are you sure you want to archive this image?">
                <i class="fas fa-trash"></i> Archive
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: SEO Metadata Form -->
      <div>
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title"><i class="fas fa-search"></i> SEO Optimization</h2>
            <button type="button" id="aiAnalyzeBtn" class="btn btn-sm btn-primary" onclick="analyzeWithAI()">
              <i class="fas fa-robot"></i> AI Auto-fill
            </button>
          </div>
          <div class="card-body">
            <!-- AI Analysis Status -->
            <div id="aiAnalysisStatus" style="display: none; margin-bottom: 16px;"></div>

            <form action="/images/<%= image.id %>" method="POST">
              <!-- SEO Score -->
              <div class="seo-score-card" id="seoScoreCard">
                <div class="seo-score-ring" id="seoScoreRing">
                  <span id="seoScoreValue">0</span>
                </div>
                <div>
                  <p style="font-weight: 600;" id="seoScoreLabel">Checking...</p>
                  <p class="form-help" id="seoScoreHint"></p>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="alt_text">
                  Alt Text *
                  <span id="altCounter" style="float: right; font-weight: 400; color: var(--gray-500); font-size: 12px;">0/125</span>
                </label>
                <input type="text" id="alt_text" name="alt_text" class="form-input" value="<%= image.alt_text || '' %>" placeholder="Descriptive text with keywords" required maxlength="250">
                <p class="form-help">Essential for SEO and accessibility. Describe what the image shows.</p>
              </div>

              <div class="form-group">
                <label class="form-label" for="title">Title Attribute</label>
                <input type="text" id="title" name="title" class="form-input" value="<%= image.title || '' %>" placeholder="Image title for tooltip and AI context">
                <p class="form-help">Shown on hover. AI crawlers (GPTBot, PerplexityBot) use this for context.</p>
              </div>

              <div class="form-group">
                <label class="form-label" for="description">Description (Schema.org)</label>
                <textarea id="description" name="description" class="form-input" rows="4" placeholder="Detailed description for structured data. AI search engines parse this."><%= image.description || '' %></textarea>
                <p class="form-help">Used in Schema.org ImageObject markup for rich results and AI indexing.</p>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="category">Category</label>
                  <select id="category" name="category" class="form-input">
                    <option value="general" <%= image.category === 'general' ? 'selected' : '' %>>General</option>
                    <option value="hero" <%= image.category === 'hero' ? 'selected' : '' %>>Hero Images</option>
                    <option value="portfolio" <%= image.category === 'portfolio' ? 'selected' : '' %>>Portfolio</option>
                    <option value="logos" <%= image.category === 'logos' ? 'selected' : '' %>>Logos</option>
                    <option value="articles" <%= image.category === 'articles' ? 'selected' : '' %>>Articles</option>
                    <option value="og" <%= image.category === 'og' ? 'selected' : '' %>>Open Graph</option>
                    <option value="icons" <%= image.category === 'icons' ? 'selected' : '' %>>Icons</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="folder_id">Folder</label>
                  <select id="folder_id" name="folder_id" class="form-input">
                    <option value="">No folder</option>
                    <% if (folders && folders.length > 0) { folders.forEach(f => { %>
                    <option value="<%= f.id %>" <%= image.folder_id === f.id ? 'selected' : '' %>><%= 'â€”'.repeat(f.depth) %><%= f.depth ? ' ' : '' %><%= f.name %></option>
                    <% }); } %>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="tags">Tags</label>
                  <input type="text" id="tags" name="tags" class="form-input" value="<%= image.tags ? image.tags.join(', ') : '' %>" placeholder="marketing, seo, laos">
                  <p class="form-help">Comma-separated</p>
                </div>
              </div>

              <div class="form-actions form-actions-sticky">
                <a href="/images" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Save SEO Metadata
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Schema.org Preview -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-code"></i> Schema.org Preview</h2>
          </div>
          <div class="card-body">
            <pre id="schemaPreview" style="background: var(--gray-50); padding: 16px; border-radius: var(--radius); font-size: 12px; overflow-x: auto; white-space: pre-wrap; color: var(--gray-700);"></pre>
            <button class="btn btn-sm btn-secondary" id="copySchemaBtn" style="margin-top: 12px;">
              <i class="fas fa-copy"></i> Copy Schema JSON
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Copy URL toast -->
  <div id="copyToast" class="copy-toast">
    <i class="fas fa-check-circle"></i> Copied to clipboard
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const image = {
    cdn_url: '<%= image.cdn_url %>',
    web_url: '<%= image.web_url %>',
    width: <%= image.width || 'null' %>,
    height: <%= image.height || 'null' %>,
    mime_type: '<%= image.mime_type %>',
  };

  // Alt text counter
  const altInput = document.getElementById('alt_text');
  const altCounter = document.getElementById('altCounter');
  function updateAltCounter() {
    const len = altInput.value.length;
    altCounter.textContent = len + '/125';
    altCounter.style.color = len > 125 ? 'var(--danger)' : len > 0 ? 'var(--success)' : 'var(--gray-500)';
    updateSeoScore();
    updateSchemaPreview();
  }
  altInput.addEventListener('input', updateAltCounter);
  updateAltCounter();

  // SEO Score
  function updateSeoScore() {
    const alt = document.getElementById('alt_text').value.trim();
    const title = document.getElementById('title').value.trim();
    const desc = document.getElementById('description').value.trim();
    const filename = '<%= image.filename %>';

    let score = 0;
    const tips = [];

    // Alt text (40 points)
    if (alt) {
      score += 20;
      if (alt.length >= 20 && alt.length <= 125) score += 20;
      else tips.push('Alt text should be 20-125 characters');
    } else {
      tips.push('Add alt text (critical for SEO)');
    }

    // Title (15 points)
    if (title) score += 15;
    else tips.push('Add a title attribute');

    // Description (20 points)
    if (desc) {
      score += 10;
      if (desc.length >= 50) score += 10;
      else tips.push('Description should be 50+ characters');
    } else {
      tips.push('Add a Schema.org description');
    }

    // Filename (15 points)
    if (/^[a-z0-9-]+\.[a-z]+$/.test(filename)) score += 15;
    else tips.push('Rename file to lowercase-hyphenated format');

    // File format (10 points)
    if (image.mime_type === 'image/webp' || image.mime_type === 'image/svg+xml') score += 10;
    else tips.push('Convert to WebP for better performance');

    const scoreEl = document.getElementById('seoScoreValue');
    const labelEl = document.getElementById('seoScoreLabel');
    const hintEl = document.getElementById('seoScoreHint');
    const ringEl = document.getElementById('seoScoreRing');

    scoreEl.textContent = score;
    ringEl.className = 'seo-score-ring ' + (score >= 80 ? 'good' : score >= 50 ? 'ok' : 'poor');
    labelEl.textContent = score >= 80 ? 'Well Optimized' : score >= 50 ? 'Needs Improvement' : 'Poorly Optimized';
    hintEl.textContent = tips.length > 0 ? tips[0] : 'All checks passed!';
  }

  // Schema.org Preview
  function updateSchemaPreview() {
    const schema = {
      '@type': 'ImageObject',
      contentUrl: image.cdn_url,
      url: image.web_url,
      name: document.getElementById('title').value || '<%= image.filename %>',
      description: document.getElementById('description').value || '',
      creator: { '@type': 'Organization', name: 'WordsThatSells.website', url: 'https://wordsthatsells.website' },
    };
    if (image.width) schema.width = image.width;
    if (image.height) schema.height = image.height;
    if (image.mime_type) schema.encodingFormat = image.mime_type;

    document.getElementById('schemaPreview').textContent = JSON.stringify(schema, null, 2);
  }

  document.getElementById('title').addEventListener('input', () => { updateSeoScore(); updateSchemaPreview(); });
  document.getElementById('description').addEventListener('input', () => { updateSeoScore(); updateSchemaPreview(); });

  updateSeoScore();
  updateSchemaPreview();

  // Copy HTML tag
  document.getElementById('copyHtmlBtn').addEventListener('click', () => {
    const text = document.getElementById('htmlTagField').value;
    navigator.clipboard.writeText(text).then(() => showToast());
  });

  // Copy Schema
  document.getElementById('copySchemaBtn').addEventListener('click', () => {
    const text = document.getElementById('schemaPreview').textContent;
    navigator.clipboard.writeText(text).then(() => showToast());
  });

  function showToast() {
    const toast = document.getElementById('copyToast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  }

  // Re-upload dropzone
  const reDropzone = document.getElementById('reuploadDropzone');
  const reFileInput = document.getElementById('reuploadFile');
  const reContent = document.getElementById('reuploadContent');
  const rePreview = document.getElementById('reuploadPreview');
  const rePreviewImg = document.getElementById('reuploadPreviewImg');
  const reBtn = document.getElementById('reuploadBtn');

  reDropzone.addEventListener('click', () => reFileInput.click());
  reDropzone.addEventListener('dragover', (e) => { e.preventDefault(); reDropzone.style.borderColor = 'var(--primary)'; });
  reDropzone.addEventListener('dragleave', () => { reDropzone.style.borderColor = 'var(--gray-300)'; });
  reDropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    reDropzone.style.borderColor = 'var(--gray-300)';
    if (e.dataTransfer.files.length > 0) {
      reFileInput.files = e.dataTransfer.files;
      showReuploadPreview(e.dataTransfer.files[0]);
    }
  });
  reFileInput.addEventListener('change', () => {
    if (reFileInput.files.length > 0) showReuploadPreview(reFileInput.files[0]);
  });

  function showReuploadPreview(file) {
    // Validate MIME type before rendering preview to prevent rendering non-image content
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml', 'image/avif'];
    if (!allowedTypes.includes(file.type)) return;
    // Use FileReader to generate a validated data URL for the preview
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      if (typeof dataUrl === 'string' && dataUrl.startsWith('data:image/')) {
        rePreviewImg.src = dataUrl;
      }
    };
    reader.readAsDataURL(file);
    document.getElementById('reuploadPreviewName').textContent = file.name;
    const size = file.size < 1024*1024 ? (file.size/1024).toFixed(1)+' KB' : (file.size/(1024*1024)).toFixed(1)+' MB';
    document.getElementById('reuploadPreviewSize').textContent = size;
    reContent.style.display = 'none';
    rePreview.style.display = '';
    reBtn.disabled = false;
  }

  document.getElementById('reuploadForm').addEventListener('submit', () => {
    reBtn.disabled = true;
    reBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Replacing...';
  });
});

// AI Image Analysis
function analyzeWithAI() {
  const btn = document.getElementById('aiAnalyzeBtn');
  const status = document.getElementById('aiAnalysisStatus');

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
  status.style.display = 'block';
  status.innerHTML = '<div style="padding: 12px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius); font-size: 13px; color: var(--primary);"><i class="fas fa-robot"></i> AI is analyzing the image content and filename...</div>';

  fetch('/images/<%= image.id %>/analyze', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      status.innerHTML = '<div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); font-size: 13px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> ' + data.error + '</div>';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill';
      return;
    }

    // Fill in the fields
    if (data.alt_text) document.getElementById('alt_text').value = data.alt_text;
    if (data.title) document.getElementById('title').value = data.title;
    if (data.description) document.getElementById('description').value = data.description;
    if (data.tags) document.getElementById('tags').value = data.tags;

    // Trigger updates
    document.getElementById('alt_text').dispatchEvent(new Event('input'));
    document.getElementById('title').dispatchEvent(new Event('input'));
    document.getElementById('description').dispatchEvent(new Event('input'));

    status.innerHTML = '<div style="padding: 12px; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius); font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> AI analysis complete! Fields have been filled. Review and edit as needed, then click Save.</div>';
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill';
  })
  .catch(err => {
    status.innerHTML = '<div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: var(--radius); font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> Failed to analyze: ' + err.message + '</div>';
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill';
  });
}

// Image Optimization
function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function getOptimizeParams() {
  return {
    format: document.getElementById('opt_format') ? document.getElementById('opt_format').value : 'webp',
    quality: document.getElementById('opt_quality') ? document.getElementById('opt_quality').value : '82',
    max_width: document.getElementById('opt_max_width') ? document.getElementById('opt_max_width').value : '',
    max_height: document.getElementById('opt_max_height') ? document.getElementById('opt_max_height').value : '',
    fit: document.getElementById('opt_fit') ? document.getElementById('opt_fit').value : 'inside',
  };
}

let previewTimeout;
function previewOptimization() {
  clearTimeout(previewTimeout);
  previewTimeout = setTimeout(doPreview, 300);
}

function doPreview() {
  const preview = document.getElementById('optimizePreview');
  const loading = document.getElementById('optimizePreviewLoading');
  if (!preview || !loading) return;

  loading.style.display = 'block';
  preview.style.display = 'none';

  const params = getOptimizeParams();

  fetch('/images/<%= image.id %>/optimize-preview', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params),
  })
  .then(r => r.json())
  .then(data => {
    loading.style.display = 'none';
    if (data.error && data.error === 'SVG') return;
    if (data.error) { return; }

    document.getElementById('previewOriginalSize').textContent = formatBytes(data.original_size);
    document.getElementById('previewNewSize').textContent = formatBytes(data.estimated_size);
    const pct = data.savings_pct;
    const pctEl = document.getElementById('previewSavingsPct');
    pctEl.textContent = (pct >= 0 ? '-' : '+') + Math.abs(pct) + '%';
    pctEl.style.color = pct >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('previewNewSize').style.color = pct >= 0 ? 'var(--success)' : 'var(--danger)';
    preview.style.display = 'block';
  })
  .catch(() => { loading.style.display = 'none'; });
}

function runOptimization() {
  const btn = document.getElementById('optimizeBtn');
  const status = document.getElementById('optimizeStatus');

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Optimizing...';
  status.style.display = 'block';
  status.innerHTML = '<div style="padding: 12px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius); font-size: 13px; color: var(--primary);"><i class="fas fa-compress-arrows-alt"></i> Processing image and pushing to CDN...</div>';

  const params = getOptimizeParams();

  fetch('/images/<%= image.id %>/optimize', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params),
  })
  .then(r => r.json())
  .then(data => {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-compress-arrows-alt"></i> Optimize Now';

    if (data.error) {
      status.innerHTML = '<div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); font-size: 13px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> ' + data.error + '</div>';
      return;
    }

    const savedText = data.savings >= 0
      ? 'Saved ' + formatBytes(data.savings) + ' (' + data.savings_pct + '% smaller)'
      : 'Size increased by ' + formatBytes(Math.abs(data.savings));
    const cdnText = data.cdn_pushed ? ' Pushed to CDN.' : '';

    status.innerHTML = '<div style="padding: 12px; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius); font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> ' +
      '<strong>Optimized!</strong> ' + formatBytes(data.original_size) + ' &rarr; ' + formatBytes(data.new_size) + '. ' + savedText + '.' + cdnText +
      ' <a href="" onclick="location.reload(); return false;" style="color: #155724; text-decoration: underline;">Reload page</a> to see updated info.</div>';
  })
  .catch(err => {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-compress-arrows-alt"></i> Optimize Now';
    status.innerHTML = '<div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: var(--radius); font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> ' + err.message + '</div>';
  });
}
</script>

<%- include('../partials/footer') %>
