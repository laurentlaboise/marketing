<%- include('../partials/head', { title, bodyClass: 'dashboard-layout' }) %>

<%- include('../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Upload Image</h1>
        <p class="page-subtitle">
          <a href="/images"><i class="fas fa-arrow-left"></i> Back to Image Library</a>
        </p>
      </div>
    </div>

    <% if (!githubConfigured) { %>
    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); padding: 16px 20px; margin-bottom: 20px; max-width: 900px; display: flex; gap: 12px; align-items: flex-start;">
      <i class="fas fa-exclamation-triangle" style="color: #856404; font-size: 18px; margin-top: 2px;"></i>
      <div>
        <p style="font-weight: 600; color: #856404; margin-bottom: 4px;">GitHub Token Not Configured</p>
        <p style="font-size: 13px; color: #856404;">Uploaded images will be stored locally only and <strong>will not appear on the CDN</strong>. They will be lost when Railway redeploys. Add <code>GITHUB_TOKEN</code> to your Railway environment variables to enable automatic CDN publishing.</p>
      </div>
    </div>
    <% } %>

    <div class="card form-card" style="max-width: 900px;">
      <div class="card-body">
        <form action="/images/upload" method="POST" enctype="multipart/form-data" id="uploadForm">

          <div class="form-section">
            <h3 class="form-section-title">Image File(s)</h3>

            <div class="form-group">
              <label class="form-label" for="images">Select Image(s) *</label>
              <div class="upload-dropzone" id="dropzone">
                <input type="file" id="images" name="images" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml,image/avif" multiple required style="display: none;">
                <div class="dropzone-content" id="dropzoneContent">
                  <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--gray-400); margin-bottom: 16px;"></i>
                  <p style="font-size: 16px; font-weight: 600; color: var(--gray-700);">Drag & drop your image(s) here</p>
                  <p style="color: var(--gray-500); margin-top: 4px;">or <span style="color: var(--primary); cursor: pointer;" id="browseBtn">browse files</span></p>
                  <p class="form-help" style="margin-top: 12px;">JPG, PNG, GIF, WebP, SVG, AVIF - Max 20MB each. You can select multiple files.</p>
                </div>
                <div class="dropzone-preview" id="dropzonePreview" style="display: none;">
                  <div id="previewList" style="display: flex; flex-wrap: wrap; gap: 12px; width: 100%;"></div>
                  <div style="margin-top: 12px;">
                    <button type="button" id="removeFile" class="btn btn-sm btn-danger">
                      <i class="fas fa-times"></i> Remove all
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-checkbox">
                <input type="checkbox" name="optimize" value="on" checked>
                <span class="form-label" style="margin-bottom: 0;">Optimize image (convert to WebP, max 2400px)</span>
              </label>
              <p class="form-help">Reduces file size for faster CDN delivery. SVG files are kept as-is.</p>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Organization</h3>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="category">Category *</label>
                <select id="category" name="category" class="form-input" required>
                  <option value="general">General</option>
                  <option value="hero">Hero Images</option>
                  <option value="portfolio">Portfolio</option>
                  <option value="logos">Logos</option>
                  <option value="articles">Articles</option>
                  <option value="og">Open Graph</option>
                  <option value="icons">Icons</option>
                </select>
                <p class="form-help">Determines the subdirectory in the images folder</p>
              </div>
              <div class="form-group">
                <label class="form-label" for="tags">Tags</label>
                <input type="text" id="tags" name="tags" class="form-input" placeholder="marketing, seo, laos">
                <p class="form-help">Comma-separated tags for organization</p>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">SEO Metadata</h3>
            <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
              <i class="fas fa-info-circle"></i> Setting these fields improves discoverability in Google, Bing, ChatGPT, and Perplexity search results.
            </p>

            <div class="form-group">
              <label class="form-label" for="alt_text">Alt Text</label>
              <input type="text" id="alt_text" name="alt_text" class="form-input" placeholder="Descriptive text about the image content (auto-fills from filename if empty)">
              <p class="form-help">125 characters max recommended. Include relevant keywords naturally. If left empty, the filename will be used.</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="title">Title</label>
              <input type="text" id="title" name="title" class="form-input" placeholder="Image title for tooltips and SEO">
              <p class="form-help">Shown on hover and used by AI search engines for context.</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="description">Description</label>
              <textarea id="description" name="description" class="form-input" rows="3" placeholder="Detailed description of the image for Schema.org structured data and AI crawlers"></textarea>
              <p class="form-help">Used in Schema.org ImageObject markup. AI search engines use this to understand image context.</p>
            </div>
          </div>

          <div class="form-actions">
            <a href="/images" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary" id="uploadBtn">
              <i class="fas fa-cloud-upload-alt"></i> Upload Image(s)
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('images');
  const browseBtn = document.getElementById('browseBtn');
  const removeBtn = document.getElementById('removeFile');
  const content = document.getElementById('dropzoneContent');
  const preview = document.getElementById('dropzonePreview');
  const previewList = document.getElementById('previewList');
  const uploadBtn = document.getElementById('uploadBtn');

  browseBtn.addEventListener('click', () => fileInput.click());
  dropzone.addEventListener('click', (e) => {
    if (e.target === dropzone || e.target.closest('.dropzone-content')) fileInput.click();
  });

  // Drag and drop
  dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      fileInput.files = e.dataTransfer.files;
      showPreviews(e.dataTransfer.files);
    }
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) showPreviews(fileInput.files);
  });

  removeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.value = '';
    content.style.display = '';
    preview.style.display = 'none';
    previewList.innerHTML = '';
  });

  function showPreviews(files) {
    previewList.innerHTML = '';
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const item = document.createElement('div');
      item.style.cssText = 'display: flex; align-items: center; gap: 10px; background: var(--gray-50); border-radius: var(--radius); padding: 8px 12px; min-width: 200px;';

      const img = document.createElement('img');
      img.style.cssText = 'width: 48px; height: 48px; object-fit: cover; border-radius: 4px;';
      img.alt = 'Preview';
      img.src = URL.createObjectURL(file);

      const info = document.createElement('div');
      const nameEl = document.createElement('p');
      nameEl.style.cssText = 'font-weight: 600; font-size: 13px; margin: 0;';
      nameEl.textContent = file.name;
      const sizeEl = document.createElement('p');
      sizeEl.style.cssText = 'color: var(--gray-500); font-size: 12px; margin: 0;';
      sizeEl.textContent = formatSize(file.size);
      info.appendChild(nameEl);
      info.appendChild(sizeEl);

      item.appendChild(img);
      item.appendChild(info);
      previewList.appendChild(item);
    }
    content.style.display = 'none';
    preview.style.display = 'flex';
    preview.style.flexDirection = 'column';
    preview.style.alignItems = 'center';
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Show loading state on submit
  document.getElementById('uploadForm').addEventListener('submit', () => {
    uploadBtn.disabled = true;
    const count = fileInput.files.length;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading ' + count + ' image' + (count !== 1 ? 's' : '') + '...';
  });
});
</script>

<%- include('../partials/footer') %>
