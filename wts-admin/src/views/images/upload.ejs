<%- include('../partials/head', { title, bodyClass: 'dashboard-layout' }) %>

<%- include('../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Upload Image</h1>
        <p class="page-subtitle">
          <a href="/images"><i class="fas fa-arrow-left"></i> Back to Image Library</a>
          &nbsp;&middot;&nbsp;
          <a href="/images/upload-multiple"><i class="fas fa-images"></i> Batch upload multiple images</a>
        </p>
      </div>
    </div>

    <% if (!githubConfigured) { %>
    <div class="alert-banner alert-banner-warning">
      <i class="fas fa-exclamation-triangle" style="font-size: 18px; margin-top: 2px;"></i>
      <div>
        <p style="font-weight: 600; margin-bottom: 4px;">GitHub Token Not Configured</p>
        <p style="font-size: 13px;">Uploaded images will be stored locally only and <strong>will not appear on the CDN</strong>. They will be lost when Railway redeploys. Add <code>GITHUB_TOKEN</code> to your Railway environment variables to enable automatic CDN publishing.</p>
      </div>
    </div>
    <% } %>

    <div class="card form-card">
      <div class="card-body">
        <form action="/images/upload" method="POST" enctype="multipart/form-data" id="uploadForm">

          <div class="form-section">
            <h3 class="form-section-title">Image File</h3>

            <div class="form-group">
              <label class="form-label" for="image">Select Image *</label>
              <div class="upload-dropzone" id="dropzone">
                <input type="file" id="image" name="image" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml,image/avif" required style="display: none;">
                <div class="dropzone-content" id="dropzoneContent">
                  <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--gray-400); margin-bottom: 16px;"></i>
                  <p style="font-size: 16px; font-weight: 600; color: var(--gray-700);">Drag & drop your image here</p>
                  <p style="color: var(--gray-500); margin-top: 4px;">or <span style="color: var(--primary); cursor: pointer;" id="browseBtn">browse files</span></p>
                  <p class="form-help" style="margin-top: 12px;">JPG, PNG, GIF, WebP, SVG, AVIF - Max 20MB</p>
                </div>
                <div class="dropzone-preview" id="dropzonePreview" style="display: none;">
                  <img id="previewImg" src="" alt="Preview">
                  <div class="dropzone-preview-info">
                    <p id="previewName" style="font-weight: 600;"></p>
                    <p id="previewSize" style="color: var(--gray-500); font-size: 13px;"></p>
                    <button type="button" id="removeFile" class="btn btn-sm btn-danger" style="margin-top: 8px;">
                      <i class="fas fa-times"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-checkbox">
                <input type="checkbox" name="optimize" value="on" checked>
                <span class="form-label" style="margin-bottom: 0;">Optimize image (convert to WebP, max 2400px)</span>
              </label>
              <p class="form-help">Reduces file size for faster CDN delivery. SVG files are kept as-is.</p>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Organization</h3>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="category">Category *</label>
                <select id="category" name="category" class="form-input" required>
                  <option value="general">General</option>
                  <option value="hero">Hero Images</option>
                  <option value="portfolio">Portfolio</option>
                  <option value="logos">Logos</option>
                  <option value="articles">Articles</option>
                  <option value="og">Open Graph</option>
                  <option value="icons">Icons</option>
                </select>
                <p class="form-help">Determines the subdirectory in the images folder</p>
              </div>
              <div class="form-group">
                <label class="form-label" for="folder_id">Folder</label>
                <select id="folder_id" name="folder_id" class="form-input">
                  <option value="">No folder</option>
                  <% if (folders && folders.length > 0) { folders.forEach(f => { %>
                  <option value="<%= f.id %>" <%= preselectedFolder === f.id ? 'selected' : '' %>><%= 'â€”'.repeat(f.depth) %><%= f.depth ? ' ' : '' %><%= f.name %></option>
                  <% }); } %>
                </select>
                <p class="form-help">Organize this image into a folder</p>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="tags">Tags</label>
                <input type="text" id="tags" name="tags" class="form-input" placeholder="marketing, seo, laos">
                <p class="form-help">Comma-separated tags for organization</p>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 class="form-section-title" style="margin-bottom: 0;">SEO Metadata</h3>
              <button type="button" id="aiAnalyzeUploadBtn" class="btn btn-sm btn-primary" onclick="analyzeUploadWithAI()" disabled>
                <i class="fas fa-robot"></i> AI Auto-fill
              </button>
            </div>
            <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
              <i class="fas fa-info-circle"></i> Setting these fields improves discoverability in Google, Bing, ChatGPT, and Perplexity search results.
              Select an image first, then click <strong>AI Auto-fill</strong> to generate metadata automatically.
            </p>

            <!-- AI Analysis Status -->
            <div id="aiAnalysisStatus" style="display: none; margin-bottom: 16px;"></div>

            <div class="form-group">
              <label class="form-label" for="alt_text">Alt Text *</label>
              <input type="text" id="alt_text" name="alt_text" class="form-input" placeholder="Descriptive text about the image content" required>
              <p class="form-help">125 characters max recommended. Include relevant keywords naturally.</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="title">Title</label>
              <input type="text" id="title" name="title" class="form-input" placeholder="Image title for tooltips and SEO">
              <p class="form-help">Shown on hover and used by AI search engines for context.</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="description">Description</label>
              <textarea id="description" name="description" class="form-input" rows="3" placeholder="Detailed description of the image for Schema.org structured data and AI crawlers"></textarea>
              <p class="form-help">Used in Schema.org ImageObject markup. AI search engines use this to understand image context.</p>
            </div>
          </div>

          <div class="form-actions">
            <a href="/images" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary" id="uploadBtn">
              <i class="fas fa-cloud-upload-alt"></i> Upload Image
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('image');
  const browseBtn = document.getElementById('browseBtn');
  const removeBtn = document.getElementById('removeFile');
  const content = document.getElementById('dropzoneContent');
  const preview = document.getElementById('dropzonePreview');
  const previewImg = document.getElementById('previewImg');
  const previewName = document.getElementById('previewName');
  const previewSize = document.getElementById('previewSize');
  const uploadBtn = document.getElementById('uploadBtn');

  browseBtn.addEventListener('click', () => fileInput.click());
  dropzone.addEventListener('click', (e) => {
    if (e.target === dropzone || e.target.closest('.dropzone-content')) fileInput.click();
  });

  // Drag and drop
  dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      fileInput.files = e.dataTransfer.files;
      showPreview(e.dataTransfer.files[0]);
    }
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) showPreview(fileInput.files[0]);
  });

  removeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.value = '';
    content.style.display = '';
    preview.style.display = 'none';
    // Disable AI Auto-fill button when file is removed
    const aiBtn = document.getElementById('aiAnalyzeUploadBtn');
    if (aiBtn) aiBtn.disabled = true;
  });

  function showPreview(file) {
    const url = URL.createObjectURL(file);
    previewImg.src = url;
    previewName.textContent = file.name;
    previewSize.textContent = formatSize(file.size);
    content.style.display = 'none';
    preview.style.display = 'flex';

    // Enable AI Auto-fill button when a file is selected
    const aiBtn = document.getElementById('aiAnalyzeUploadBtn');
    if (aiBtn) aiBtn.disabled = false;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Show loading state on submit
  document.getElementById('uploadForm').addEventListener('submit', () => {
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading & publishing to CDN...';
  });
});

// AI Image Analysis for upload page
function analyzeUploadWithAI() {
  const fileInput = document.getElementById('image');
  if (!fileInput.files || fileInput.files.length === 0) return;

  const btn = document.getElementById('aiAnalyzeUploadBtn');
  const status = document.getElementById('aiAnalysisStatus');

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
  status.style.display = 'block';
  status.innerHTML = '<div style="padding: 12px; background: var(--primary-light, #eff6ff); border: 1px solid rgba(59,130,246,0.3); border-radius: var(--radius); font-size: 13px; color: var(--primary);"><i class="fas fa-robot"></i> AI is analyzing the image content and filename...</div>';

  const formData = new FormData();
  formData.append('image', fileInput.files[0]);

  fetch('/images/analyze-upload', {
    method: 'POST',
    body: formData,
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      status.innerHTML = '<div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: var(--radius); font-size: 13px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> ' + data.error + '</div>';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill';
      return;
    }

    // Fill in the SEO fields
    if (data.alt_text) document.getElementById('alt_text').value = data.alt_text;
    if (data.title) document.getElementById('title').value = data.title;
    if (data.description) document.getElementById('description').value = data.description;
    if (data.tags) document.getElementById('tags').value = data.tags;

    status.innerHTML = '<div style="padding: 12px; background: #d4edda; border: 1px solid #28a745; border-radius: var(--radius); font-size: 13px; color: #155724;"><i class="fas fa-check-circle"></i> AI analysis complete! Review the fields below and edit as needed.</div>';
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill';
  })
  .catch(err => {
    status.innerHTML = '<div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: var(--radius); font-size: 13px; color: #721c24;"><i class="fas fa-times-circle"></i> Failed to analyze: ' + err.message + '</div>';
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot"></i> AI Auto-fill';
  });
}
</script>

<%- include('../partials/footer') %>
