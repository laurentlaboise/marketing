<%- include('../../partials/head', { title, bodyClass: 'dashboard-layout' }) %>
<%- include('../../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
      <div>
        <h1 class="page-title"><%= product ? 'Edit Product' : 'New Product' %></h1>
        <p class="page-subtitle"><a href="/business/products"><i class="fas fa-arrow-left"></i> Back to Products</a></p>
      </div>
      <button type="button" id="btn-preview-sidebar" class="btn btn-primary" style="white-space:nowrap;">
        <i class="fas fa-eye"></i> Preview Sidebar
      </button>
    </div>

    <form action="<%= product ? '/business/products/' + product.id : '/business/products' %>" method="POST">

      <!-- Basic Information -->
      <div class="card form-card" style="margin-bottom: 1.5rem;">
        <div class="card-body">
          <h3 style="margin-bottom: 1rem; color: var(--text-primary, #1a1a2e);"><i class="fas fa-info-circle"></i> Basic Information</h3>

          <div class="form-group">
            <label class="form-label" for="name">Product Name *</label>
            <input type="text" id="name" name="name" class="form-input" value="<%= product ? product.name : '' %>" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="slug">Slug (URL-friendly name)</label>
            <input type="text" id="slug" name="slug" class="form-input" value="<%= product ? (product.slug || '') : '' %>" placeholder="auto-generated-from-name">
          </div>

          <div class="form-group">
            <label class="form-label" for="description">Description</label>
            <textarea id="description" name="description" class="form-input" rows="4"><%= product ? (product.description || '') : '' %></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="product_type">Product Type</label>
              <select id="product_type" name="product_type" class="form-input">
                <option value="service" <%= product && product.product_type === 'service' ? 'selected' : (!product ? 'selected' : '') %>>Service</option>
                <option value="digital" <%= product && product.product_type === 'digital' ? 'selected' : '' %>>Digital Product</option>
                <option value="subscription" <%= product && product.product_type === 'subscription' ? 'selected' : '' %>>Subscription</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="status">Status</label>
              <select id="status" name="status" class="form-input">
                <option value="active" <%= !product || product.status === 'active' ? 'selected' : '' %>>Active</option>
                <option value="inactive" <%= product && product.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                <option value="draft" <%= product && product.status === 'draft' ? 'selected' : '' %>>Draft</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing & Category -->
      <div class="card form-card" style="margin-bottom: 1.5rem;">
        <div class="card-body">
          <h3 style="margin-bottom: 1rem; color: var(--text-primary, #1a1a2e);"><i class="fas fa-tags"></i> Pricing & Category</h3>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="price">Price</label>
              <input type="number" id="price" name="price" class="form-input" step="0.01" value="<%= product ? (product.price || '') : '' %>">
            </div>
            <div class="form-group">
              <label class="form-label" for="currency">Currency</label>
              <select id="currency" name="currency" class="form-input">
                <option value="USD" <%= !product || product.currency === 'USD' ? 'selected' : '' %>>USD</option>
                <option value="EUR" <%= product && product.currency === 'EUR' ? 'selected' : '' %>>EUR</option>
                <option value="GBP" <%= product && product.currency === 'GBP' ? 'selected' : '' %>>GBP</option>
                <option value="THB" <%= product && product.currency === 'THB' ? 'selected' : '' %>>THB</option>
                <option value="LAK" <%= product && product.currency === 'LAK' ? 'selected' : '' %>>LAK</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="category">Category</label>
              <input type="text" id="category" name="category" class="form-input" value="<%= product ? (product.category || '') : '' %>" placeholder="e.g. copywriting, design, automation">
            </div>
            <div class="form-group">
              <label class="form-label" for="service_page">Service Page</label>
              <select id="service_page" name="service_page" class="form-input">
                <option value="" <%= !product || !product.service_page ? 'selected' : '' %>>-- None --</option>
                <option value="content-creation" <%= product && product.service_page === 'content-creation' ? 'selected' : '' %>>Content Creation</option>
                <option value="social-media-management" <%= product && product.service_page === 'social-media-management' ? 'selected' : '' %>>Social Media Management</option>
                <option value="web-development" <%= product && product.service_page === 'web-development' ? 'selected' : '' %>>Web Development</option>
                <option value="business-tools" <%= product && product.service_page === 'business-tools' ? 'selected' : '' %>>Business Tools</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="sort_order">Sort Order</label>
              <input type="number" id="sort_order" name="sort_order" class="form-input" value="<%= product ? (product.sort_order || 0) : 0 %>">
            </div>
            <div class="form-group">
              <label class="form-label" for="is_featured">Featured</label>
              <select id="is_featured" name="is_featured" class="form-input">
                <option value="false" <%= !product || !product.is_featured ? 'selected' : '' %>>No</option>
                <option value="true" <%= product && product.is_featured ? 'selected' : '' %>>Yes</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Appearance -->
      <div class="card form-card" style="margin-bottom: 1.5rem;">
        <div class="card-body">
          <h3 style="margin-bottom: 1rem; color: var(--text-primary, #1a1a2e);"><i class="fas fa-palette"></i> Appearance (Service Card)</h3>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="icon_class">Icon Class (Font Awesome)</label>
              <input type="text" id="icon_class" name="icon_class" class="form-input" value="<%= product ? (product.icon_class || 'fas fa-box') : 'fas fa-box' %>" placeholder="fas fa-pen-nib">
              <small style="color: #666;">e.g. fas fa-pen-nib, fas fa-globe, fas fa-car</small>
            </div>
            <div class="form-group">
              <label class="form-label" for="animation_class">Animation Class</label>
              <select id="animation_class" name="animation_class" class="form-input">
                <option value="kinetic-pulse-float" <%= !product || product.animation_class === 'kinetic-pulse-float' ? 'selected' : '' %>>Pulse Float</option>
                <option value="kinetic-rotate" <%= product && product.animation_class === 'kinetic-rotate' ? 'selected' : '' %>>Rotate</option>
                <option value="kinetic-oscillate" <%= product && product.animation_class === 'kinetic-oscillate' ? 'selected' : '' %>>Oscillate</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="image_url">Card Image URL</label>
            <input type="url" id="image_url" name="image_url" class="form-input" value="<%= product ? (product.image_url || '') : '' %>">
          </div>

          <div class="form-group">
            <label class="form-label" for="features">Features (one per line)</label>
            <textarea id="features" name="features" class="form-input" rows="4"><%= product && product.features ? product.features.join('\n') : '' %></textarea>
          </div>
        </div>
      </div>

      <!-- Slide-in Detail Panel -->
      <div class="card form-card" style="margin-bottom: 1.5rem;">
        <div class="card-body">
          <h3 style="margin-bottom: 1rem; color: var(--text-primary, #1a1a2e);"><i class="fas fa-expand-arrows-alt"></i> Detail Panel (Learn More Slide-in)</h3>

          <div class="form-group">
            <label class="form-label" for="slide_in_title">Detail Title</label>
            <input type="text" id="slide_in_title" name="slide_in_title" class="form-input" value="<%= product ? (product.slide_in_title || '') : '' %>" placeholder="Headline for the detail panel">
          </div>

          <div class="form-group">
            <label class="form-label" for="slide_in_subtitle">Detail Subtitle</label>
            <textarea id="slide_in_subtitle" name="slide_in_subtitle" class="form-input" rows="2"><%= product ? (product.slide_in_subtitle || '') : '' %></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="slide_in_content" style="display:flex;align-items:center;gap:0.5rem;">
              <i class="fas fa-code" style="color:#d62b83;"></i> Sidebar HTML Content
            </label>
            <textarea id="slide_in_content" name="slide_in_content" class="form-input" rows="16"
              style="font-family:'Fira Code','Cascadia Code','Consolas',monospace;font-size:13px;line-height:1.6;background:#1a1a2e;color:#e2e8f0;padding:1rem;border-radius:8px;tab-size:2;white-space:pre-wrap;resize:vertical;"
            ><%= product ? (product.slide_in_content || '') : '' %></textarea>
            <small style="color: #666; display:block; margin-top:0.4rem;">
              Write HTML that renders inside the sidebar panel. Use headings, lists, cards, etc.
              Click <strong>"Preview Sidebar"</strong> above to see the result live.
            </small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="slide_in_image">Detail Image URL</label>
              <input type="url" id="slide_in_image" name="slide_in_image" class="form-input" value="<%= product ? (product.slide_in_image || '') : '' %>">
            </div>
            <div class="form-group">
              <label class="form-label" for="slide_in_video">Detail Video URL (YouTube embed)</label>
              <input type="url" id="slide_in_video" name="slide_in_video" class="form-input" value="<%= product ? (product.slide_in_video || '') : '' %>" placeholder="https://www.youtube.com/embed/...">
            </div>
          </div>
        </div>
      </div>

      <!-- Stripe & Digital Delivery -->
      <div class="card form-card" style="margin-bottom: 1.5rem;">
        <div class="card-body">
          <h3 style="margin-bottom: 1rem; color: var(--text-primary, #1a1a2e);"><i class="fab fa-stripe"></i> Stripe & Digital Delivery</h3>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="stripe_product_id">Stripe Product ID</label>
              <input type="text" id="stripe_product_id" name="stripe_product_id" class="form-input" value="<%= product ? (product.stripe_product_id || '') : '' %>" placeholder="prod_...">
            </div>
            <div class="form-group">
              <label class="form-label" for="stripe_price_id">Stripe Price ID</label>
              <input type="text" id="stripe_price_id" name="stripe_price_id" class="form-input" value="<%= product ? (product.stripe_price_id || '') : '' %>" placeholder="price_...">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="download_url">Download URL (for digital products)</label>
            <input type="url" id="download_url" name="download_url" class="form-input" value="<%= product ? (product.download_url || '') : '' %>" placeholder="URL to downloadable file after purchase">
          </div>
        </div>
      </div>

      <div class="form-actions" style="margin-bottom: 2rem;">
        <a href="/business/products" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Product</button>
      </div>
    </form>
  </div>
</main>

<!-- ── Sidebar Preview Panel ────────────────────────────────── -->
<div id="preview-overlay" style="position:fixed;inset:0;background:rgba(18,42,63,0.6);z-index:9998;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;"></div>
<div id="preview-panel" style="position:fixed;top:0;right:0;width:75%;max-width:800px;height:100%;background:#fff;z-index:9999;transform:translateX(100%);transition:transform .35s ease;box-shadow:-10px 0 30px rgba(0,0,0,.2);display:flex;flex-direction:column;font-family:'Inter',sans-serif;">
  <div style="padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
    <h2 id="preview-title" style="font-size:1.4rem;margin:0;color:#1a1a2e;">Product Preview</h2>
    <button type="button" id="preview-close" style="font-size:1.6rem;background:none;border:none;cursor:pointer;color:#64748b;padding:0.25rem 0.5rem;">&times;</button>
  </div>
  <div id="preview-body" style="padding:1.5rem;overflow-y:auto;flex-grow:1;">
    <!-- filled by JS -->
  </div>
</div>

<script>
// ── Auto-generate slug ──────────────────────────────────────
document.getElementById('name').addEventListener('input', function() {
  const slugField = document.getElementById('slug');
  if (!slugField.dataset.manual) {
    slugField.value = this.value
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
  }
});
document.getElementById('slug').addEventListener('input', function() {
  this.dataset.manual = 'true';
});
<% if (product && product.slug) { %>
document.getElementById('slug').dataset.manual = 'true';
<% } %>

// ── Sidebar Preview Logic ───────────────────────────────────
(function() {
  const btnOpen    = document.getElementById('btn-preview-sidebar');
  const btnClose   = document.getElementById('preview-close');
  const overlay    = document.getElementById('preview-overlay');
  const panel      = document.getElementById('preview-panel');
  const titleEl    = document.getElementById('preview-title');
  const bodyEl     = document.getElementById('preview-body');

  function val(id) { return (document.getElementById(id) || {}).value || ''; }

  function open() {
    // Read current form values
    const name        = val('name');
    const description = val('description');
    const price       = val('price');
    const currency    = val('currency');
    const iconClass   = val('icon_class') || 'fas fa-box';
    const features    = val('features').split('\n').filter(function(l){ return l.trim(); });
    const siTitle     = val('slide_in_title') || name;
    const siSubtitle  = val('slide_in_subtitle');
    const siContent   = val('slide_in_content');
    const siImage     = val('slide_in_image');
    const siVideo     = val('slide_in_video');

    titleEl.textContent = siTitle || 'Product Preview';

    // Build preview HTML — matches frontend product-loader rendering
    let html = '';

    // Image
    if (siImage) {
      html += '<img src="' + esc(siImage) + '" alt="' + esc(siTitle) + '" style="width:100%;height:auto;border-radius:12px;margin-bottom:1.5rem;background:#f1f5f9;">';
    }

    // Subtitle
    if (siSubtitle) {
      html += '<p style="font-size:1.1rem;color:#64748b;margin-bottom:1.5rem;">' + esc(siSubtitle) + '</p>';
    }

    // Video
    if (siVideo) {
      html += '<div style="margin-bottom:1.5rem;"><iframe width="100%" height="360" src="' + esc(siVideo) + '" frameborder="0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen style="border-radius:12px;"></iframe></div>';
    }

    // HTML Content — rendered raw (this is the HTML textbox output)
    if (siContent) {
      var safeContent = (window.DOMPurify && window.DOMPurify.sanitize) ? window.DOMPurify.sanitize(siContent) : siContent;
      html += '<div class="preview-html-content" style="margin-bottom:1.5rem;line-height:1.7;color:#334155;">' + safeContent + '</div>';
    }

    // Features list
    if (features.length) {
      html += '<div style="margin-bottom:1.5rem;"><h3 style="font-size:1.1rem;font-weight:600;color:#1a1a2e;margin-bottom:0.75rem;">Features</h3><ul style="padding-left:1.2rem;color:#475569;">';
      features.forEach(function(f) { html += '<li style="margin-bottom:0.4rem;">' + esc(f) + '</li>'; });
      html += '</ul></div>';
    }

    // Price + Add to My Services button
    html += '<div style="text-align:center;margin-top:2rem;padding-top:1.5rem;border-top:1px solid #e2e8f0;">';
    if (price) {
      html += '<p style="font-size:1.3rem;font-weight:700;color:#d62b83;margin-bottom:1rem;">$' + parseFloat(price).toFixed(2) + ' ' + esc(currency || 'USD') + '</p>';
    }
    html += '<button type="button" style="background:#d62b83;color:#fff;border:none;padding:0.8rem 2rem;border-radius:8px;font-size:1.05rem;cursor:pointer;font-weight:600;"><i class="fas fa-plus"></i> Add to My Services</button>';
    html += '</div>';

    bodyEl.innerHTML = html;

    // Show panel
    panel.style.transform = 'translateX(0)';
    overlay.style.opacity = '1';
    overlay.style.visibility = 'visible';
  }

  function close() {
    panel.style.transform = 'translateX(100%)';
    overlay.style.opacity = '0';
    overlay.style.visibility = 'hidden';
  }

  function esc(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = String(s);
    return d.innerHTML;
  }

  btnOpen.addEventListener('click', open);
  btnClose.addEventListener('click', close);
  overlay.addEventListener('click', close);

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') close();
  });
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js" integrity="sha384-uT3pX9zt2ChjFuO5YPuMV+KCYQ7LTYxt6++YOaiq4O4psZxfqyD7ZTjZJNMIafzV" crossorigin="anonymous"></script>

<%- include('../../partials/footer') %>
