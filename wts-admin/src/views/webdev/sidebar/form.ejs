<%- include('../../partials/head', { title, bodyClass: 'dashboard-layout' }) %>
<%- include('../../partials/sidebar', { currentPage, user }) %>

<main class="main-content">
  <%- include('../../partials/header', { user, messages }) %>

  <div class="page-content">
    <div class="page-header">
      <div>
        <h1 class="page-title"><%= item ? 'Edit Sidebar Item' : 'New Sidebar Item' %></h1>
        <p class="page-subtitle"><a href="/webdev/sidebar"><i class="fas fa-arrow-left"></i> Back to Sidebar</a></p>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">

      <!-- Left column: Settings -->
      <div class="card form-card">
        <div class="card-body">
          <h3 style="margin-bottom:1rem;"><i class="fas fa-cog"></i> Settings</h3>
          <form id="sidebar-form" action="<%= item ? '/webdev/sidebar/' + item.id : '/webdev/sidebar' %>" method="POST">
            <div class="form-group">
              <label class="form-label" for="label">Label / Title *</label>
              <input type="text" id="label" name="label" class="form-input" value="<%= item ? item.label : '' %>" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="page_url">Target Page URL *</label>
              <div style="display:flex;gap:0.5rem;align-items:flex-start;">
                <div style="flex:1;">
                  <input type="text" id="page_url" name="page_url" class="form-input" value="<%= item ? (item.page_url || '') : '' %>" placeholder="Paste full URL or path, e.g. https://wordsthatsells.website/en/articles/my-article" required>
                </div>
                <button type="button" id="verifyLinkBtn" class="btn btn-primary btn-sm" style="white-space:nowrap;margin-top:1px;height:38px;">
                  <i class="fas fa-check-circle"></i> Verify
                </button>
              </div>
              <small style="color:#64748b;">Paste the <strong>full URL</strong> or just the path. The system will extract and normalize the path automatically. Use <code>*</code> as wildcard (e.g. <code>/en/articles/*</code>).</small>

              <!-- Verification result panel -->
              <div id="verifyResult" style="display:none;margin-top:0.6rem;"></div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="button_label">Floating Button Label</label>
                <input type="text" id="button_label" name="button_label" class="form-input" value="<%= item ? (item.button_label || 'Help') : 'Help' %>" placeholder="Help">
                <small style="color:#64748b;">Text shown on the floating side button (rotated vertically).</small>
              </div>
              <div class="form-group">
                <label class="form-label" for="icon_class">Button Icon (Font Awesome)</label>
                <input type="text" id="icon_class" name="icon_class" class="form-input" value="<%= item ? (item.icon_class || 'fas fa-question-circle') : 'fas fa-question-circle' %>">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="url">Link URL (optional)</label>
              <input type="text" id="url" name="url" class="form-input" value="<%= item ? (item.url || '') : '' %>" placeholder="Optional link within sidebar content">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="section">Section *</label>
                <select id="section" name="section" class="form-input" required>
                  <option value="page-sidebar" <%= !item || item.section === 'page-sidebar' ? 'selected' : '' %>>Page Sidebar (floating button)</option>
                  <option value="content-creation" <%= item && item.section === 'content-creation' ? 'selected' : '' %>>Content Creation</option>
                  <option value="social-media-management" <%= item && item.section === 'social-media-management' ? 'selected' : '' %>>Social Media Management</option>
                  <option value="web-development" <%= item && item.section === 'web-development' ? 'selected' : '' %>>Web Development</option>
                  <option value="business-tools" <%= item && item.section === 'business-tools' ? 'selected' : '' %>>Business Tools</option>
                  <option value="footer" <%= item && item.section === 'footer' ? 'selected' : '' %>>Footer</option>
                  <option value="global" <%= item && item.section === 'global' ? 'selected' : '' %>>Global (all pages)</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="sort_order">Sort Order</label>
                <input type="number" id="sort_order" name="sort_order" class="form-input" value="<%= item ? (item.sort_order || 0) : 0 %>">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="is_visible">Visible</label>
                <select id="is_visible" name="is_visible" class="form-input">
                  <option value="true" <%= !item || item.is_visible !== false ? 'selected' : '' %>>Yes</option>
                  <option value="false" <%= item && item.is_visible === false ? 'selected' : '' %>>No</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="open_in_new_tab">Open in New Tab</label>
                <select id="open_in_new_tab" name="open_in_new_tab" class="form-input">
                  <option value="false" <%= !item || !item.open_in_new_tab ? 'selected' : '' %>>No</option>
                  <option value="true" <%= item && item.open_in_new_tab ? 'selected' : '' %>>Yes</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="css_class">CSS Class (optional)</label>
              <input type="text" id="css_class" name="css_class" class="form-input" value="<%= item ? (item.css_class || '') : '' %>" placeholder="e.g. highlight, premium">
            </div>

            <!-- HTML Content -->
            <div class="form-group">
              <label class="form-label" for="content_html">Sidebar HTML Content</label>
              <div style="border:1px solid #d1d5db;border-radius:8px;overflow:hidden;">
                <div id="html-toolbar" style="display:flex;gap:4px;flex-wrap:wrap;padding:8px 10px;background:#f8fafc;border-bottom:1px solid #d1d5db;">
                  <button type="button" class="toolbar-btn" data-cmd="bold" title="Bold"><i class="fas fa-bold"></i></button>
                  <button type="button" class="toolbar-btn" data-cmd="italic" title="Italic"><i class="fas fa-italic"></i></button>
                  <button type="button" class="toolbar-btn" data-cmd="underline" title="Underline"><i class="fas fa-underline"></i></button>
                  <span style="border-left:1px solid #d1d5db;margin:0 4px;"></span>
                  <button type="button" class="toolbar-btn" data-cmd="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                  <button type="button" class="toolbar-btn" data-cmd="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                  <span style="border-left:1px solid #d1d5db;margin:0 4px;"></span>
                  <button type="button" class="toolbar-btn" data-cmd="formatBlock" data-value="H2" title="Heading 2">H2</button>
                  <button type="button" class="toolbar-btn" data-cmd="formatBlock" data-value="H3" title="Heading 3">H3</button>
                  <button type="button" class="toolbar-btn" data-cmd="formatBlock" data-value="H4" title="Heading 4">H4</button>
                  <button type="button" class="toolbar-btn" data-cmd="formatBlock" data-value="P" title="Paragraph">P</button>
                  <span style="border-left:1px solid #d1d5db;margin:0 4px;"></span>
                  <button type="button" class="toolbar-btn" id="insertLinkBtn" title="Insert Link"><i class="fas fa-link"></i></button>
                  <button type="button" class="toolbar-btn" id="insertImageBtn" title="Insert Image"><i class="fas fa-image"></i></button>
                  <span style="border-left:1px solid #d1d5db;margin:0 4px;"></span>
                  <button type="button" class="toolbar-btn" id="toggleSourceBtn" title="Toggle HTML Source"><i class="fas fa-code"></i></button>
                </div>
                <div id="html-editor" contenteditable="true" style="min-height:300px;padding:16px;outline:none;font-size:0.95rem;line-height:1.6;"><%- item ? (item.content_html || '') : '' %></div>
                <textarea id="html-source" name="content_html" style="display:none;width:100%;min-height:300px;padding:16px;border:none;font-family:monospace;font-size:0.9rem;resize:vertical;"><%= item ? (item.content_html || '') : '' %></textarea>
              </div>
              <small style="color:#64748b;">Rich HTML content shown in the slide-in panel when the user clicks the floating button.</small>
            </div>

            <div class="form-actions">
              <a href="/webdev/sidebar" class="btn btn-secondary">Cancel</a>
              <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Right column: Live Preview -->
      <div>
        <div class="card" style="position:sticky;top:1rem;">
          <div class="card-body">
            <h3 style="margin-bottom:1rem;"><i class="fas fa-eye"></i> Preview</h3>

            <!-- Button preview -->
            <div style="margin-bottom:1.5rem;">
              <h4 style="font-size:0.85rem;color:#64748b;text-transform:uppercase;margin-bottom:0.75rem;">Floating Button</h4>
              <div id="preview-button" style="display:inline-flex;align-items:center;gap:8px;background:var(--color-accent-magenta,#d62b83);color:#fff;padding:10px 20px;border-radius:8px 8px 0 0;font-weight:600;font-size:0.9rem;">
                <i id="preview-btn-icon" class="<%= item ? (item.icon_class || 'fas fa-question-circle') : 'fas fa-question-circle' %>"></i>
                <span id="preview-btn-label"><%= item ? (item.button_label || 'Help') : 'Help' %></span>
              </div>
            </div>

            <!-- Panel content preview -->
            <h4 style="font-size:0.85rem;color:#64748b;text-transform:uppercase;margin-bottom:0.75rem;">Panel Content</h4>
            <div id="preview-panel" style="border:1px solid #e2e8f0;border-radius:12px;max-height:500px;overflow-y:auto;">
              <div style="padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <h3 id="preview-title" style="font-size:1.2rem;margin:0;"><%= item ? item.label : 'Sidebar Title' %></h3>
                <span style="color:#94a3b8;font-size:1.2rem;cursor:default;">&times;</span>
              </div>
              <div id="preview-content" style="padding:20px;line-height:1.7;font-size:0.95rem;">
                <%- item ? (item.content_html || '<p style="color:#94a3b8;">HTML content will appear here...</p>') : '<p style="color:#94a3b8;">HTML content will appear here...</p>' %>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<style>
  .toolbar-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    color: #374151;
    transition: all 0.15s;
  }
  .toolbar-btn:hover {
    background: #e2e8f0;
    border-color: #94a3b8;
  }
  #html-editor:focus {
    box-shadow: inset 0 0 0 2px rgba(102, 126, 234, 0.2);
  }
  #html-editor h2, #html-editor h3, #html-editor h4 {
    margin: 0.5rem 0;
  }
  #html-editor ul, #html-editor ol {
    padding-left: 1.5rem;
    margin: 0.5rem 0;
  }
  #html-editor img {
    max-width: 100%;
    border-radius: 8px;
    margin: 0.5rem 0;
  }
  #html-editor a {
    color: #667eea;
    text-decoration: underline;
  }
  #preview-content h2, #preview-content h3, #preview-content h4 {
    margin: 0.5rem 0;
  }
  #preview-content ul, #preview-content ol {
    padding-left: 1.5rem;
    margin: 0.5rem 0;
  }
  #preview-content img {
    max-width: 100%;
    border-radius: 8px;
    margin: 0.5rem 0;
  }
  @media (max-width: 900px) {
    div[style*="grid-template-columns:1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }

  /* Link Verifier */
  .verify-box {
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    line-height: 1.5;
  }
  .verify-box.success {
    background: #f0fdf4;
    border: 1px solid #86efac;
    color: #166534;
  }
  .verify-box.warning {
    background: #fffbeb;
    border: 1px solid #fcd34d;
    color: #92400e;
  }
  .verify-box.error {
    background: #fef2f2;
    border: 1px solid #fca5a5;
    color: #991b1b;
  }
  .verify-box.info {
    background: #eff6ff;
    border: 1px solid #93c5fd;
    color: #1e40af;
  }
  .verify-box .verify-icon {
    font-size: 1rem;
    margin-right: 0.4rem;
  }
  .verify-box .verify-heading {
    font-weight: 700;
    margin-bottom: 0.3rem;
  }
  .verify-box code {
    background: rgba(0,0,0,0.06);
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    font-size: 0.82rem;
  }
  .verify-box .conflict-item {
    margin-top: 0.4rem;
    padding: 0.4rem 0.6rem;
    background: rgba(0,0,0,0.04);
    border-radius: 5px;
    font-size: 0.82rem;
  }
  .verify-box .conflict-item strong {
    font-weight: 600;
  }
  .verify-spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #d1d5db;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: verify-spin 0.6s linear infinite;
    margin-right: 0.4rem;
    vertical-align: middle;
  }
  @keyframes verify-spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const editor = document.getElementById('html-editor');
  const source = document.getElementById('html-source');
  const toggleBtn = document.getElementById('toggleSourceBtn');
  const previewContent = document.getElementById('preview-content');
  const previewTitle = document.getElementById('preview-title');
  const previewBtnIcon = document.getElementById('preview-btn-icon');
  const previewBtnLabel = document.getElementById('preview-btn-label');
  const labelInput = document.getElementById('label');
  const iconInput = document.getElementById('icon_class');
  const btnLabelInput = document.getElementById('button_label');
  let sourceMode = false;

  // Toolbar commands
  document.querySelectorAll('.toolbar-btn[data-cmd]').forEach(btn => {
    btn.addEventListener('click', () => {
      const cmd = btn.dataset.cmd;
      const val = btn.dataset.value || null;
      document.execCommand(cmd, false, val);
      editor.focus();
      syncToSource();
    });
  });

  // Insert link
  document.getElementById('insertLinkBtn').addEventListener('click', () => {
    const url = prompt('Enter URL:');
    if (url) {
      document.execCommand('createLink', false, url);
      editor.focus();
      syncToSource();
    }
  });

  // Insert image
  document.getElementById('insertImageBtn').addEventListener('click', () => {
    const url = prompt('Enter image URL:');
    if (url) {
      document.execCommand('insertImage', false, url);
      editor.focus();
      syncToSource();
    }
  });

  // Toggle source view
  toggleBtn.addEventListener('click', () => {
    sourceMode = !sourceMode;
    if (sourceMode) {
      source.value = editor.innerHTML;
      editor.style.display = 'none';
      source.style.display = 'block';
      toggleBtn.style.background = '#667eea';
      toggleBtn.style.color = '#fff';
    } else {
      editor.innerHTML = source.value;
      source.style.display = 'none';
      editor.style.display = 'block';
      toggleBtn.style.background = '';
      toggleBtn.style.color = '';
      updatePreview();
    }
  });

  // Sync editor to hidden textarea
  function syncToSource() {
    source.value = editor.innerHTML;
    updatePreview();
  }

  // Update live preview
  function updatePreview() {
    previewContent.innerHTML = editor.innerHTML || '<p style="color:#94a3b8;">HTML content will appear here...</p>';
  }

  editor.addEventListener('input', syncToSource);
  editor.addEventListener('paste', () => setTimeout(syncToSource, 0));

  // Sync form before submit
  document.getElementById('sidebar-form').addEventListener('submit', () => {
    if (!sourceMode) {
      source.value = editor.innerHTML;
    }
  });

  // Live preview for label/icon/button
  if (labelInput) {
    labelInput.addEventListener('input', () => {
      previewTitle.textContent = labelInput.value || 'Sidebar Title';
    });
  }
  if (iconInput) {
    iconInput.addEventListener('input', () => {
      previewBtnIcon.className = iconInput.value || 'fas fa-question-circle';
    });
  }
  if (btnLabelInput) {
    btnLabelInput.addEventListener('input', () => {
      previewBtnLabel.textContent = btnLabelInput.value || 'Help';
    });
  }
});
</script>

<!-- Link Verifier Script -->
<script>
(function() {
  var verifyBtn = document.getElementById('verifyLinkBtn');
  var pageUrlInput = document.getElementById('page_url');
  var resultBox = document.getElementById('verifyResult');
  var currentItemId = '<%= item ? item.id : '' %>';

  if (!verifyBtn || !pageUrlInput || !resultBox) return;

  // Auto-extract path from full URL when user pastes
  pageUrlInput.addEventListener('input', function() {
    var val = pageUrlInput.value.trim();
    // If they pasted a full URL, extract just the path
    try {
      if (val.match(/^https?:\/\//i)) {
        var url = new URL(val);
        pageUrlInput.value = url.pathname;
      }
    } catch(e) {
      // Not a valid URL, leave as-is (they're typing a path)
    }
    // Hide previous result
    resultBox.style.display = 'none';
  });

  verifyBtn.addEventListener('click', function() {
    var path = pageUrlInput.value.trim();
    if (!path) {
      showResult('error', '<i class="fas fa-times-circle verify-icon"></i> Enter a page URL or paste a full link first.');
      return;
    }

    // Extract path from full URL if needed
    try {
      if (path.match(/^https?:\/\//i)) {
        var url = new URL(path);
        path = url.pathname;
        pageUrlInput.value = path;
      }
    } catch(e) {}

    // Show loading
    resultBox.style.display = 'block';
    resultBox.innerHTML = '<div class="verify-box info"><span class="verify-spinner"></span> Verifying link...</div>';
    verifyBtn.disabled = true;

    var qs = '/webdev/sidebar/verify-link?path=' + encodeURIComponent(path);
    if (currentItemId) qs += '&exclude=' + currentItemId;

    fetch(qs)
      .then(function(res) { return res.json(); })
      .then(function(data) {
        verifyBtn.disabled = false;
        if (data.error) {
          showResult('error', '<i class="fas fa-times-circle verify-icon"></i> ' + escHtml(data.error));
          return;
        }

        var html = '';

        // Show normalized path
        html += '<div class="verify-heading"><i class="fas fa-route verify-icon"></i> Path Analysis</div>';
        html += '<div style="margin-bottom:0.4rem;">Input: <code>' + escHtml(data.input) + '</code></div>';
        html += '<div style="margin-bottom:0.6rem;">Normalized: <code>' + escHtml(data.normalized) + '</code>';
        if (data.input !== data.normalized) {
          html += ' <span style="color:#d97706;font-size:0.8rem;">(auto-corrected)</span>';
        }
        html += '</div>';

        // Check for conflicts (other visible items matching same path)
        if (data.matches && data.matches.length > 0) {
          html += '<div class="verify-heading" style="color:#dc2626;margin-top:0.5rem;"><i class="fas fa-exclamation-triangle verify-icon"></i> Conflict: ' + data.matches.length + ' other sidebar item' + (data.matches.length > 1 ? 's' : '') + ' already match this path</div>';
          data.matches.forEach(function(m) {
            html += '<div class="conflict-item">';
            html += '<strong>' + escHtml(m.label) + '</strong> ';
            html += '<code>' + escHtml(m.page_url) + '</code> ';
            html += '<span style="font-size:0.75rem;color:#6b7280;">(' + m.match_type + ' match)</span> ';
            html += '<a href="/webdev/sidebar/' + m.id + '/edit" style="font-size:0.78rem;color:var(--primary);">Edit</a>';
            html += '</div>';
          });
          showResult('warning', html);
        } else {
          // No conflicts — this path is clear
          html += '<div class="verify-heading" style="color:#16a34a;"><i class="fas fa-check-circle verify-icon"></i> No conflicts — this path is available</div>';
          html += '<div style="font-size:0.82rem;color:#6b7280;">When a visitor loads <code>' + escHtml(data.normalized) + '</code>, your floating button will appear.</div>';
          showResult('success', html);
        }

        // Hidden items warning
        if (data.hidden_matches && data.hidden_matches.length > 0) {
          var hiddenHtml = '<div style="margin-top:0.5rem;font-size:0.82rem;color:#9ca3af;"><i class="fas fa-eye-slash" style="margin-right:0.3rem;"></i> ' + data.hidden_matches.length + ' hidden item' + (data.hidden_matches.length > 1 ? 's' : '') + ' also match this path (won\'t show on site)</div>';
          resultBox.querySelector('.verify-box').insertAdjacentHTML('beforeend', hiddenHtml);
        }
      })
      .catch(function(err) {
        verifyBtn.disabled = false;
        showResult('error', '<i class="fas fa-times-circle verify-icon"></i> Verification failed. Try again.');
      });
  });

  function showResult(type, html) {
    resultBox.style.display = 'block';
    resultBox.innerHTML = '<div class="verify-box ' + type + '">' + html + '</div>';
  }

  function escHtml(str) {
    var d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }
})();
</script>

<%- include('../../partials/footer') %>
